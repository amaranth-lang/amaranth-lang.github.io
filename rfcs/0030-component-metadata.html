<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0030-component-metadata - The Amaranth RFC Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/img-color-scheme.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="0001-aggregate-data-structures.html">0001-aggregate-data-structures</a></li><li class="chapter-item expanded "><a href="0002-interfaces.html">0002-interfaces</a></li><li class="chapter-item expanded "><a href="0003-enumeration-shapes.html">0003-enumeration-shapes</a></li><li class="chapter-item expanded "><a href="0004-const-castable-exprs.html">0004-const-castable-exprs</a></li><li class="chapter-item expanded "><a href="0005-remove-const-normalize.html">0005-remove-const-normalize</a></li><li class="chapter-item expanded "><a href="0006-stdlib-crc.html">0006-stdlib-crc</a></li><li class="chapter-item expanded "><a href="0008-aggregate-extensibility.html">0008-aggregate-extensibility</a></li><li class="chapter-item expanded "><a href="0009-const-init-shape-castable.html">0009-const-init-shape-castable</a></li><li class="chapter-item expanded "><a href="0010-move-repl-to-value.html">0010-move-repl-to-value</a></li><li class="chapter-item expanded "><a href="0015-lifting-shape-castables.html">0015-lifting-shape-castables</a></li><li class="chapter-item expanded "><a href="0016-soc-csr-regs.html">0016-soc-csr-regs</a></li><li class="chapter-item expanded "><a href="0017-remove-log2-int.html">0017-remove-log2-int</a></li><li class="chapter-item expanded "><a href="0018-reorganize-vendor-platforms.html">0018-reorganize-vendor-platforms</a></li><li class="chapter-item expanded "><a href="0019-remove-scheduler.html">0019-remove-scheduler</a></li><li class="chapter-item expanded "><a href="0020-deprecate-non-fwft-fifos.html">0020-deprecate-non-fwft-fifos</a></li><li class="chapter-item expanded "><a href="0021-patch-releases.html">0021-patch-releases</a></li><li class="chapter-item expanded "><a href="0022-valuecastable-shape.html">0022-valuecastable-shape</a></li><li class="chapter-item expanded "><a href="0027-simulator-testbenches.html">0027-simulator-testbenches</a></li><li class="chapter-item expanded "><a href="0028-override-value-operators.html">0028-override-value-operators</a></li><li class="chapter-item expanded "><a href="0030-component-metadata.html" class="active">0030-component-metadata</a></li><li class="chapter-item expanded "><a href="0031-enumeration-type-safety.html">0031-enumeration-type-safety</a></li><li class="chapter-item expanded "><a href="0034-interface-rename.html">0034-interface-rename</a></li><li class="chapter-item expanded "><a href="0035-shapelike-valuelike.html">0035-shapelike-valuelike</a></li><li class="chapter-item expanded "><a href="0036-async-testbench-functions.html">0036-async-testbench-functions</a></li><li class="chapter-item expanded "><a href="0037-make-signature-immutable.html">0037-make-signature-immutable</a></li><li class="chapter-item expanded "><a href="0038-component-signature-immutability.html">0038-component-signature-immutability</a></li><li class="chapter-item expanded "><a href="0039-empty-case.html">0039-empty-case</a></li><li class="chapter-item expanded "><a href="0040-arbitrary-memory-shape.html">0040-arbitrary-memory-shape</a></li><li class="chapter-item expanded "><a href="0042-const-from-shape-castable.html">0042-const-from-shape-castable</a></li><li class="chapter-item expanded "><a href="0043-rename-reset-to-init.html">0043-rename-reset-to-init</a></li><li class="chapter-item expanded "><a href="0045-lib-memory.html">0045-lib-memory</a></li><li class="chapter-item expanded "><a href="0046-shape-range-1.html">0046-shape-range-1</a></li><li class="chapter-item expanded "><a href="0049-soc-gpio-peripheral.html">0049-soc-gpio-peripheral</a></li><li class="chapter-item expanded "><a href="0050-print.html">0050-print</a></li><li class="chapter-item expanded "><a href="0051-const-from-bits.html">0051-const-from-bits</a></li><li class="chapter-item expanded "><a href="0053-ioport.html">0053-ioport</a></li><li class="chapter-item expanded "><a href="0054-read-port-init.html">0054-read-port-init</a></li><li class="chapter-item expanded "><a href="0055-lib-io.html">0055-lib-io</a></li><li class="chapter-item expanded "><a href="0056-mem-wide.html">0056-mem-wide</a></li><li class="chapter-item expanded "><a href="0057-single-field-shortcut.html">0057-single-field-shortcut</a></li><li class="chapter-item expanded "><a href="0061-minimal-streams.html">0061-minimal-streams</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Amaranth RFC Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/amaranth-lang/rfcs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <ul>
<li>Start Date: 2024-01-22</li>
<li>RFC PR: <a href="https://github.com/amaranth-lang/rfcs/pull/30">amaranth-lang/rfcs#30</a></li>
<li>Amaranth Issue: <a href="https://github.com/amaranth-lang/amaranth/issues/1047">amaranth-lang/amaranth#1047</a></li>
</ul>
<h1 id="component-metadata-rfc"><a class="header" href="#component-metadata-rfc">Component metadata RFC</a></h1>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>Add support for JSON-based introspection of an Amaranth component, describing its interface and properties.</p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>Introspection of components is an inherent feature of Amaranth. As Python objects, they make use of attributes to:</p>
<ul>
<li>expose the ports that compose their interface.</li>
<li>communicate other kinds of metadata, such as behavioral properties or safety invariants.</li>
</ul>
<p>Multiple tools may consume parts of this metadata at different points in time. While the ports of an interface must be known at build time, other properties (such as a bus memory map) may be used afterwards to operate or verify the design.</p>
<p>However, in a mixed HDL design, components implemented in other HDLs require ad-hoc integration:</p>
<ul>
<li>their netlist must be consulted in order to know their signature.</li>
<li>each port must be connected individually (whereas Amaranth components can use <code>connect()</code> on compatible interfaces).</li>
<li>there is no mechanism to pass metadata besides instance parameters and attributes. Any information produced by the instance itself cannot be easily passed to its parent.</li>
</ul>
<p>This RFC proposes a JSON-based format to describe and exchange component metadata. While building upon the concepts of <a href="https://github.com/amaranth-lang/rfcs/blob/main/text/0002-interfaces.md">RFC 2</a>, this metadata format tries to avoid making assumptions about its consumers (which could be other HDL frontends, block diagram design tools, etc).</p>
<h2 id="guide-level-explanation"><a class="header" href="#guide-level-explanation">Guide-level explanation</a></h2>
<h3 id="component-metadata"><a class="header" href="#component-metadata">Component metadata</a></h3>
<p>An <code>amaranth.lib.wiring.Component</code> can provide metadata about itself, represented as a JSON object. This metadata contains a hierarchical description of every port of its interface.</p>
<p>The following example defines an <code>AsyncSerial</code> component, and outputs its metadata:</p>
<pre><code class="language-python3">from amaranth import *
from amaranth.lib.data import StructLayout
from amaranth.lib.wiring import In, Out, Signature, Component


class AsyncSerialSignature(Signature):
    def __init__(self, divisor_reset, divisor_bits, data_bits, parity):
        self.data_bits = data_bits
        self.parity    = parity

        super().__init__({
            &quot;divisor&quot;: In(divisor_bits, reset=divisor_reset),

            &quot;rx_data&quot;: Out(data_bits),
            &quot;rx_err&quot;:  Out(StructLayout({&quot;overflow&quot;: 1, &quot;frame&quot;: 1, &quot;parity&quot;: 1})),
            &quot;rx_rdy&quot;:  Out(1),
            &quot;rx_ack&quot;:  In(1),
            &quot;rx_i&quot;:    In(1),

            &quot;tx_data&quot;: In(data_bits),
            &quot;tx_rdy&quot;:  Out(1),
            &quot;tx_ack&quot;:  In(1),
            &quot;tx_o&quot;:    Out(1),
        })


class AsyncSerial(Component):
    def __init__(self, *, divisor_reset, divisor_bits, data_bits=8, parity=&quot;none&quot;):
        super().__init__(AsyncSerialSignature(divisor_reset, divisor_bits, data_bits, parity))


if __name__ == &quot;__main__&quot;:
    import json
    from amaranth.utils import bits_for

    divisor = int(100e6 // 115200)
    serial = AsyncSerial(divisor_reset=divisor, divisor_bits=bits_for(divisor), data_bits=8, parity=&quot;none&quot;)

    print(json.dumps(serial.metadata.as_json(), indent=4))
</code></pre>
<p>The <code>.metadata</code> property of a <code>Component</code> returns a <code>ComponentMetadata</code> instance describing that component. In the above example, <code>serial.metadata.as_json()</code> converts this metadata into a JSON object, which is then printed:</p>
<pre><code class="language-json">{
    &quot;interface&quot;: {
        &quot;members&quot;: {
            &quot;divisor&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;divisor&quot;,
                &quot;dir&quot;: &quot;in&quot;,
                &quot;width&quot;: 10,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;868&quot;
            },
            &quot;rx_ack&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;rx_ack&quot;,
                &quot;dir&quot;: &quot;in&quot;,
                &quot;width&quot;: 1,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;0&quot;
            },
            &quot;rx_data&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;rx_data&quot;,
                &quot;dir&quot;: &quot;out&quot;,
                &quot;width&quot;: 8,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;0&quot;
            },
            &quot;rx_err&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;rx_err&quot;,
                &quot;dir&quot;: &quot;out&quot;,
                &quot;width&quot;: 3,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;0&quot;
            },
            &quot;rx_i&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;rx_i&quot;,
                &quot;dir&quot;: &quot;in&quot;,
                &quot;width&quot;: 1,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;0&quot;
            },
            &quot;rx_rdy&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;rx_rdy&quot;,
                &quot;dir&quot;: &quot;out&quot;,
                &quot;width&quot;: 1,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;0&quot;
            },
            &quot;tx_ack&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;tx_ack&quot;,
                &quot;dir&quot;: &quot;in&quot;,
                &quot;width&quot;: 1,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;0&quot;
            },
            &quot;tx_data&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;tx_data&quot;,
                &quot;dir&quot;: &quot;in&quot;,
                &quot;width&quot;: 8,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;0&quot;
            },
            &quot;tx_o&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;tx_o&quot;,
                &quot;dir&quot;: &quot;out&quot;,
                &quot;width&quot;: 1,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;0&quot;
            },
            &quot;tx_rdy&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;tx_rdy&quot;,
                &quot;dir&quot;: &quot;out&quot;,
                &quot;width&quot;: 1,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;0&quot;
            }
        },
        &quot;annotations&quot;: {}
    }
}
</code></pre>
<p>The <code>[&quot;interface&quot;][&quot;annotations&quot;]</code> object, which is empty here, is explained in the next section.</p>
<h3 id="annotations"><a class="header" href="#annotations">Annotations</a></h3>
<p>Users can attach arbitrary annotations to an <code>amaranth.lib.wiring.Signature</code>, which are automatically collected into the metadata of components using this signature.</p>
<p>An <code>Annotation</code> class has a name (e.g. <code>&quot;org.amaranth-lang.amaranth-soc.memory-map&quot;</code>) and a <a href="https://json-schema.org">JSON schema</a> defining the structure of its instances. To continue our <code>AsyncSerial</code> example, we add an annotation to <code>AsyncSerialSignature</code> that will allow us to describe a <a href="https://en.wikipedia.org/wiki/8-N-1">8-N-1</a> configuration:</p>
<pre><code class="language-python3">class AsyncSerialAnnotation(Annotation):
    schema = {
        &quot;$schema&quot;: &quot;https://json-schema.org/draft/2020-12/schema&quot;,
        &quot;$id&quot;: &quot;https://example.com/schema/foo/1.0/serial.json&quot;,
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: {
            &quot;data_bits&quot;: {
                &quot;type&quot;: &quot;integer&quot;,
                &quot;minimum&quot;: 0,
            },
            &quot;parity&quot;: {
                &quot;enum&quot;: [ &quot;none&quot;, &quot;mark&quot;, &quot;space&quot;, &quot;even&quot;, &quot;odd&quot; ],
            },
        },
        &quot;additionalProperties&quot;: False,
        &quot;required&quot;: [
            &quot;data_bits&quot;,
            &quot;parity&quot;,
        ],
    }

    def __init__(self, origin):
        assert isinstance(origin, AsyncSerialSignature)
        self.origin = origin

    def as_json(self):
        instance = {
            &quot;data_bits&quot;: self.origin.data_bits,
            &quot;parity&quot;: self.origin.parity,
        }
        self.validate(instance)
        return instance
</code></pre>
<p>We can attach annotations to a <code>Signature</code> subclass by overriding its <code>.annotations()</code> method:</p>
<pre><code class="language-python3">class AsyncSerialSignature(Signature):
    # ...

    def annotations(self, obj):
        return (*super().annotations(obj), AsyncSerialAnnotation(self))
</code></pre>
<p>In this case, <code>AsyncSerialAnnotation</code> depends on immutable metadata attached to <code>AsyncSerialSignature</code> (<code>.data_bits</code> and <code>.parity</code>).</p>
<p>The JSON object returned by <code>serial.metadata.as_json()</code> will now use this annotation:</p>
<pre><code class="language-json">{
    &quot;interface&quot;: {
        &quot;members&quot;: {
            &quot;divisor&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;divisor&quot;,
                &quot;dir&quot;: &quot;in&quot;,
                &quot;width&quot;: 10,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;868&quot;
            },
            &quot;rx_ack&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;rx_ack&quot;,
                &quot;dir&quot;: &quot;in&quot;,
                &quot;width&quot;: 1,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;0&quot;
            },
            &quot;rx_data&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;rx_data&quot;,
                &quot;dir&quot;: &quot;out&quot;,
                &quot;width&quot;: 8,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;0&quot;
            },
            &quot;rx_err&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;rx_err&quot;,
                &quot;dir&quot;: &quot;out&quot;,
                &quot;width&quot;: 3,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;0&quot;
            },
            &quot;rx_i&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;rx_i&quot;,
                &quot;dir&quot;: &quot;in&quot;,
                &quot;width&quot;: 1,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;0&quot;
            },
            &quot;rx_rdy&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;rx_rdy&quot;,
                &quot;dir&quot;: &quot;out&quot;,
                &quot;width&quot;: 1,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;0&quot;
            },
            &quot;tx_ack&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;tx_ack&quot;,
                &quot;dir&quot;: &quot;in&quot;,
                &quot;width&quot;: 1,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;0&quot;
            },
            &quot;tx_data&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;tx_data&quot;,
                &quot;dir&quot;: &quot;in&quot;,
                &quot;width&quot;: 8,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;0&quot;
            },
            &quot;tx_o&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;tx_o&quot;,
                &quot;dir&quot;: &quot;out&quot;,
                &quot;width&quot;: 1,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;0&quot;
            },
            &quot;tx_rdy&quot;: {
                &quot;type&quot;: &quot;port&quot;,
                &quot;name&quot;: &quot;tx_rdy&quot;,
                &quot;dir&quot;: &quot;out&quot;,
                &quot;width&quot;: 1,
                &quot;signed&quot;: false,
                &quot;reset&quot;: &quot;0&quot;
            }
        },
        &quot;annotations&quot;: {
            &quot;https://example.com/schema/foo/1.0/serial.json&quot;: {
                &quot;data_bits&quot;: 8,
                &quot;parity&quot;: &quot;none&quot;
            }
        }
    }
}
</code></pre>
<h4 id="annotation-schema-urls"><a class="header" href="#annotation-schema-urls">Annotation schema URLs</a></h4>
<p>An <code>Annotation</code> schema must have a <code>&quot;$id&quot;</code> property, which holds an URL that serves as its unique identifier. The following convention is required for the <code>&quot;$id&quot;</code> of schemas hosted at https://amaranth-lang.org, and suggested otherwise:</p>
<p><code>&lt;protocol&gt;://&lt;domain&gt;/schema/&lt;package&gt;/&lt;version&gt;/&lt;path&gt;.json</code></p>
<p>where:</p>
<ul>
<li><code>&lt;domain&gt;</code> is a domain name registered to the person or entity defining the annotation;</li>
<li><code>&lt;package&gt;</code> is the name of the Python package providing the <code>Annotation</code> subclass;</li>
<li><code>&lt;version&gt;</code> is the version of the aforementioned package;</li>
<li><code>&lt;path&gt;</code> is a non-empty string.</li>
</ul>
<p>For example:</p>
<ul>
<li>&quot;https://amaranth-lang.org/schema/amaranth/0.5/fifo.json&quot;;</li>
<li>&quot;https://amaranth-lang.org/schema/amaranth-soc/0.1/memory-map.json&quot;.</li>
</ul>
<p>Changes to schema definitions hosted at https://amaranth-lang.org should follow the <a href="https://github.com/amaranth-lang/rfcs">RFC process</a>.</p>
<h2 id="reference-level-explanation"><a class="header" href="#reference-level-explanation">Reference-level explanation</a></h2>
<h3 id="annotations-1"><a class="header" href="#annotations-1">Annotations</a></h3>
<ul>
<li>add an <code>Annotation</code> base class to <code>amaranth.lib.meta</code>, with:
<ul>
<li>a <code>.schema</code> &quot;abstract&quot; class attribute, which must be a JSON schema, as a dict.</li>
<li>a <code>.__init_subclass__()</code> class method, which raises an exception if:
<ul>
<li><code>.schema</code> does not comply with the <a href="https://json-schema.org/specification-links#2020-12">2020-12 draft</a> of the JSON Schema specification.</li>
</ul>
</li>
</ul>
<ul>
<li>a <code>.origin</code> attribute, which returns the Python object described by an annotation instance.</li>
</ul>
<ul>
<li>a <code>.validate()</code> class method, which takes a JSON instance as argument. An exception is raised if the instance does not comply with the schema.</li>
<li>a <code>.as_json()</code> abstract method, which must return a JSON instance, as a dict. This instance must be compliant with <code>.schema</code>, i.e. <code>self.validate(self.as_json())</code> must succeed.</li>
</ul>
</li>
</ul>
<p>The following changes are made to <code>amaranth.lib.wiring</code>:</p>
<ul>
<li>add a <code>.annotations(self, obj)</code> method to <code>Signature</code>, which returns an empty tuple. If overriden, it must return an iterable of <code>Annotation</code> objects. <code>obj</code> is an interface object that complies with this signature, i.e. <code>self.is_compliant(obj)</code> must succeed.</li>
</ul>
<h3 id="component-metadata-1"><a class="header" href="#component-metadata-1">Component metadata</a></h3>
<p>The following changes are made to <code>amaranth.lib.wiring</code>:</p>
<ul>
<li>add a <code>ComponentMetadata</code> class, with:
<ul>
<li>a <code>.schema</code> class attribute, which returns a JSON schema of component metadata. Its definition is detailed <a href="#component-metadata-schema">below</a>.</li>
<li>a <code>.validate()</code> class method, which takes a JSON instance as argument. An exception is raised if the instance does not comply with the schema.</li>
<li><code>.__init__()</code> takes a <code>Component</code> object as parameter.</li>
<li>a <code>.origin</code> attribute, which returns the component object given in <code>.__init__()</code>.</li>
<li>a <code>.as_json()</code> method, which returns a JSON instance of <code>.origin</code> that complies with <code>.schema</code>. It is populated by iterating over the component's interface and annotations.</li>
</ul>
</li>
<li>add a <code>.metadata</code> property to <code>Component</code>, which returns <code>ComponentMetadata(self)</code>.</li>
</ul>
<h4 id="component-metadata-schema"><a class="header" href="#component-metadata-schema">Component metadata schema</a></h4>
<pre><code class="language-python3">class ComponentMetadata(Annotation):
    schema = {
        &quot;$schema&quot;: &quot;https://json-schema.org/draft/2020-12/schema&quot;,
        &quot;$id&quot;: &quot;https://amaranth-lang.org/schema/amaranth/0.5/component.json&quot;,
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: {
            &quot;interface&quot;: {
                &quot;type&quot;: &quot;object&quot;,
                &quot;properties&quot;: {
                    &quot;members&quot;: {
                        &quot;type&quot;: &quot;object&quot;,
                        &quot;patternProperties&quot;: {
                            &quot;^[A-Za-z][0-9A-Za-z_]*$&quot;: {
                                &quot;oneOf&quot;: [
                                    {
                                        &quot;type&quot;: &quot;object&quot;,
                                        &quot;properties&quot;: {
                                            &quot;type&quot;: {
                                                &quot;enum&quot;: [&quot;port&quot;],
                                            },
                                            &quot;name&quot;: {
                                                &quot;type&quot;: &quot;string&quot;,
                                                &quot;pattern&quot;: &quot;^[A-Za-z][A-Za-z0-9_]*$&quot;,
                                            },
                                            &quot;dir&quot;: {
                                                &quot;enum&quot;: [&quot;in&quot;, &quot;out&quot;],
                                            },
                                            &quot;width&quot;: {
                                                &quot;type&quot;: &quot;integer&quot;,
                                                &quot;minimum&quot;: 0,
                                            },
                                            &quot;signed&quot;: {
                                                &quot;type&quot;: &quot;boolean&quot;,
                                            },
                                            &quot;reset&quot;: {
                                                &quot;type&quot;: &quot;string&quot;,
                                                &quot;pattern&quot;: &quot;^[+-]?[0-9]+$&quot;,
                                            },
                                        },
                                        &quot;additionalProperties&quot;: False,
                                        &quot;required&quot;: [
                                            &quot;type&quot;,
                                            &quot;name&quot;,
                                            &quot;dir&quot;,
                                            &quot;width&quot;,
                                            &quot;signed&quot;,
                                            &quot;reset&quot;,
                                        ],
                                    },
                                    {
                                        &quot;type&quot;: &quot;object&quot;,
                                        &quot;properties&quot;: {
                                            &quot;type&quot;: {
                                                &quot;enum&quot;: [&quot;interface&quot;],
                                            },
                                            &quot;members&quot;: {
                                                &quot;$ref&quot;: &quot;#/properties/interface/properties/members&quot;,
                                            },
                                            &quot;annotations&quot;: {
                                                &quot;type&quot;: &quot;object&quot;,
                                            },
                                        },
                                        &quot;additionalProperties&quot;: False,
                                        &quot;required&quot;: [
                                            &quot;type&quot;,
                                            &quot;members&quot;,
                                            &quot;annotations&quot;,
                                        ],
                                    },
                                ],
                            },
                        },
                        &quot;additionalProperties&quot;: False,
                    },
                    &quot;annotations&quot;: {
                        &quot;type&quot;: &quot;object&quot;,
                    },
                },
                &quot;additionalProperties&quot;: False,
                &quot;required&quot;: [
                    &quot;members&quot;,
                    &quot;annotations&quot;,
                ],
            },
        },
        &quot;additionalProperties&quot;: False,
        &quot;required&quot;: [
            &quot;interface&quot;,
        ]
    }

    # ...
</code></pre>
<p>Reset values are serialized to strings (e.g. &quot;-1&quot;), because JSON can only represent integers up to 2^53.</p>
<h2 id="drawbacks"><a class="header" href="#drawbacks">Drawbacks</a></h2>
<ul>
<li>Developers need to learn the JSON Schema language to define annotations.</li>
<li>An annotation schema URL may point to a non-existent domain, despite being well formatted.</li>
<li>Handling backward-incompatible changes in new versions of an annotation is left to its consumers.</li>
</ul>
<h2 id="rationale-and-alternatives"><a class="header" href="#rationale-and-alternatives">Rationale and alternatives</a></h2>
<ul>
<li>As an alternative, do nothing; let tools and downstream libraries provide non-interoperable mechanisms to introspect components to and from Amaranth designs.</li>
<li>Usage of this feature is entirely optional. It has a limited impact on the <code>amaranth.lib.wiring</code>, by reserving only two attributes: <code>Signature.annotations</code> and <code>Component.metadata</code>.</li>
<li>JSON schema is an IETF standard that is well supported across tools and programming languages.</li>
<li>This metadata format can be translated into other formats, such as <a href="https://www.accellera.org/downloads/standards/ip-xact">IP-XACT</a>.</li>
</ul>
<h2 id="unresolved-questions"><a class="header" href="#unresolved-questions">Unresolved questions</a></h2>
<ul>
<li>The clock and reset ports of a component are omitted from this metadata format. Currently, the clock domains of an Amaranth component are only known at elaboration, whereas this RFC requires metadata to be accessible at any time. While this is a significant limitation for multi-clock components, single-clock components may be assumed to have a positive edge clock <code>&quot;clk&quot;</code> and a synchronous reset <code>&quot;rst&quot;</code>. Support for arbitrary clock domains should be introduced in later RFCs.</li>
<li>Annotating individual ports of an interface is out of the scope of this RFC. Port annotations may be useful to describe non-trivial signal shapes, and introduced in a later RFC.</li>
</ul>
<h2 id="future-possibilities"><a class="header" href="#future-possibilities">Future possibilities</a></h2>
<p>While this RFC can apply to any Amaranth component, one of its motivating use cases is the ability to export the interface and behavioral properties of SoC peripherals in various formats, such as SVD.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="0028-override-value-operators.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="0031-enumeration-type-safety.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="0028-override-value-operators.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="0031-enumeration-type-safety.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
