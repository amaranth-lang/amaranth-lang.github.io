<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0003-enumeration-shapes - The Amaranth RFC Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="0001-aggregate-data-structures.html">0001-aggregate-data-structures</a></li><li class="chapter-item expanded "><a href="0002-interfaces.html">0002-interfaces</a></li><li class="chapter-item expanded "><a href="0003-enumeration-shapes.html" class="active">0003-enumeration-shapes</a></li><li class="chapter-item expanded "><a href="0004-const-castable-exprs.html">0004-const-castable-exprs</a></li><li class="chapter-item expanded "><a href="0005-remove-const-normalize.html">0005-remove-const-normalize</a></li><li class="chapter-item expanded "><a href="0006-stdlib-crc.html">0006-stdlib-crc</a></li><li class="chapter-item expanded "><a href="0008-aggregate-extensibility.html">0008-aggregate-extensibility</a></li><li class="chapter-item expanded "><a href="0009-const-init-shape-castable.html">0009-const-init-shape-castable</a></li><li class="chapter-item expanded "><a href="0010-move-repl-to-value.html">0010-move-repl-to-value</a></li><li class="chapter-item expanded "><a href="0015-lifting-shape-castables.html">0015-lifting-shape-castables</a></li><li class="chapter-item expanded "><a href="0016-soc-csr-regs.html">0016-soc-csr-regs</a></li><li class="chapter-item expanded "><a href="0017-remove-log2-int.html">0017-remove-log2-int</a></li><li class="chapter-item expanded "><a href="0018-reorganize-vendor-platforms.html">0018-reorganize-vendor-platforms</a></li><li class="chapter-item expanded "><a href="0019-remove-scheduler.html">0019-remove-scheduler</a></li><li class="chapter-item expanded "><a href="0020-deprecate-non-fwft-fifos.html">0020-deprecate-non-fwft-fifos</a></li><li class="chapter-item expanded "><a href="0021-patch-releases.html">0021-patch-releases</a></li><li class="chapter-item expanded "><a href="0022-valuecastable-shape.html">0022-valuecastable-shape</a></li><li class="chapter-item expanded "><a href="0027-simulator-testbenches.html">0027-simulator-testbenches</a></li><li class="chapter-item expanded "><a href="0028-override-value-operators.html">0028-override-value-operators</a></li><li class="chapter-item expanded "><a href="0030-component-metadata.html">0030-component-metadata</a></li><li class="chapter-item expanded "><a href="0031-enumeration-type-safety.html">0031-enumeration-type-safety</a></li><li class="chapter-item expanded "><a href="0034-interface-rename.html">0034-interface-rename</a></li><li class="chapter-item expanded "><a href="0035-shapelike-valuelike.html">0035-shapelike-valuelike</a></li><li class="chapter-item expanded "><a href="0036-async-testbench-functions.html">0036-async-testbench-functions</a></li><li class="chapter-item expanded "><a href="0037-make-signature-immutable.html">0037-make-signature-immutable</a></li><li class="chapter-item expanded "><a href="0038-component-signature-immutability.html">0038-component-signature-immutability</a></li><li class="chapter-item expanded "><a href="0039-empty-case.html">0039-empty-case</a></li><li class="chapter-item expanded "><a href="0040-arbitrary-memory-shape.html">0040-arbitrary-memory-shape</a></li><li class="chapter-item expanded "><a href="0042-const-from-shape-castable.html">0042-const-from-shape-castable</a></li><li class="chapter-item expanded "><a href="0043-rename-reset-to-init.html">0043-rename-reset-to-init</a></li><li class="chapter-item expanded "><a href="0045-lib-memory.html">0045-lib-memory</a></li><li class="chapter-item expanded "><a href="0046-shape-range-1.html">0046-shape-range-1</a></li><li class="chapter-item expanded "><a href="0049-soc-gpio-peripheral.html">0049-soc-gpio-peripheral</a></li><li class="chapter-item expanded "><a href="0050-print.html">0050-print</a></li><li class="chapter-item expanded "><a href="0051-const-from-bits.html">0051-const-from-bits</a></li><li class="chapter-item expanded "><a href="0053-ioport.html">0053-ioport</a></li><li class="chapter-item expanded "><a href="0054-read-port-init.html">0054-read-port-init</a></li><li class="chapter-item expanded "><a href="0055-lib-io.html">0055-lib-io</a></li><li class="chapter-item expanded "><a href="0056-mem-wide.html">0056-mem-wide</a></li><li class="chapter-item expanded "><a href="0057-single-field-shortcut.html">0057-single-field-shortcut</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Amaranth RFC Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/amaranth-lang/rfcs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <ul>
<li>Start Date: 2023-02-27</li>
<li>RFC PR: <a href="https://github.com/amaranth-lang/rfcs/pull/3">amaranth-lang/rfcs#3</a></li>
<li>Amaranth Issue: <a href="https://github.com/amaranth-lang/amaranth/issues/756">amaranth-lang/amaranth#756</a></li>
</ul>
<h1 id="enumeration-shapes"><a class="header" href="#enumeration-shapes">Enumeration shapes</a></h1>
<blockquote>
<p><strong>Amendments</strong>
The behavior described in this RFC was updated by <a href="0004-const-castable-exprs.html">RFC #4</a>.</p>
</blockquote>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>Allow explicitly specifying shape for enumerations as an alternative to implicitly inferring it.</p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>Hardware development includes a lot of enumerated values, so first class support for enumerations is important, and so is integration with the standard Python mechanisms for specifying enumerations.</p>
<p>Amaranth accepts <code>enum.Enum</code> subclasses anywhere a shape is expected, and <code>enum.Enum</code> instances anywhere a value is expected:</p>
<pre><code class="language-python">&gt;&gt;&gt; from amaranth import *
&gt;&gt;&gt; from enum import Enum
&gt;&gt;&gt; class Kind(Enum):
...     MUL = 0
...     ADD = 1
...     SUB = 2
...
&gt;&gt;&gt; Shape.cast(Kind)
unsigned(2)
&gt;&gt;&gt; Value.cast(Kind.SUB)
(const 2'd2)
</code></pre>
<p>However, this does not cover an important use case: a enumeration where many values are reserved. For example, if the <code>Kind</code> enumeration above may need to be extended in the future, it would be necessary to reserve space for additional values, which may require additional storage bits. Right now there is no way to specify that <code>Kind</code> should be cast to e.g. <code>unsigned(4)</code>.</p>
<h2 id="guide-level-explanation"><a class="header" href="#guide-level-explanation">Guide-level explanation</a></h2>
<p>The Amaranth standard library module, <code>amaranth.lib.enum</code> can be used as a drop-in replacement for the Python standard library <code>enum</code> module. It exports the same classes as the ones provided by Python's <code>enum</code> (namely <code>Enum</code>, <code>Flag</code>, <code>IntEnum</code>, and <code>IntFlag</code>) and provides the same functionality, adding the possibility of specifying a shape for the enumeration when it is defined:</p>
<pre><code class="language-python">&gt;&gt;&gt; from amaranth.lib.enum import Enum
&gt;&gt;&gt; class Kind(Enum, shape=unsigned(4)):
...    MUL = 0
...    ADD = 1
...    SUB = 2
...
&gt;&gt;&gt; Shape.cast(Kind)
unsigned(4)
&gt;&gt;&gt; Value.cast(Kind.SUB)
(const 4'd2)
</code></pre>
<p>If the <code>shape=</code> keyword argument is not specified, the enumeration is treated exactly the same as the corresponding standard Python class.</p>
<p>If the values specified for the members are not representable with the explicitly provided shape, a warning is emitted:</p>
<pre><code class="language-python">&gt;&gt;&gt; class Funct3(Enum, shape=unsigned(3)):
...     SUB = 8
...
&lt;stdin&gt;:1: RuntimeWarning: Value of enumeration member &lt;Funct3.SUB: 8&gt; will be truncated to enumeration shape unsigned(3)
&gt;&gt;&gt; class Funct3(Enum, shape=unsigned(3)):
...     SUB = -1
...
&lt;stdin&gt;:1: RuntimeWarning: Value of enumeration member &lt;Funct3.SUB: -1&gt; is signed, but enumeration shape is unsigned(3)
</code></pre>
<p>A shape that is specified for a base class will be inherited in subclasses:</p>
<pre><code class="language-python">&gt;&gt;&gt; class Enum3(Enum, shape=unsigned(3)): pass
...
&gt;&gt;&gt; class Funct3(Enum3):
...     SUB = 2
...
&gt;&gt;&gt; Shape.cast(Funct3)
unsigned(3)
</code></pre>
<p>If a enumeration without an explicitly defined shape is used in a concatenation, a warning is emitted:</p>
<pre><code class="language-python">&gt;&gt;&gt; class Kind(Enum):
...     ADD = 1
...
&gt;&gt;&gt; Cat(Kind.ADD)
&lt;stdin&gt;:1: SyntaxWarning: Argument #1 of Cat() is an enumeration Kind.ADD without a defined shape used in bit vector context; define the enumeration by inheriting from the class in amaranth.lib.enum and specifying the 'shape=' keyword argument
(cat (const 1'd1))
</code></pre>
<h2 id="reference-level-explanation"><a class="header" href="#reference-level-explanation">Reference-level explanation</a></h2>
<p>The Amaranth standard library module, <code>amaranth.lib.enum</code>, exports all of the public names of the Python standard library <code>enum</code> module. The <code>EnumMeta</code> class adds the functionality for storing and casting to shapes, and inherits from <code>ShapeCastable</code>. The <code>Enum</code>, <code>Flag</code>, <code>IntEnum</code>, and <code>IntFlag</code> classes in this module derive from <code>enum.Enum</code>, <code>enum.Flag</code>, <code>enum.IntEnum</code>, and <code>enum.IntFlag</code> respectively, and use <code>amaranth.lib.enum.EnumMeta</code> as their metaclass, which makes subclasses of <code>amaranth.lib.enum.Enum</code>, etc be instances of <code>ShapeCastable</code>.</p>
<p>When a new <code>amaranth.lib.enum.Enum</code> subclass is defined, <code>amaranth.lib.enum.EnumMeta.__new__</code> checks that the enumeration members are valid (currently, Amaranth requires these to be integers), and if the <code>shape=</code> argument is provided, stores it in an internal attribute. Importantly, the attribute is only set if the argument is provided, making it possible to distinguish these cases later. It also checks that all of the members can be represented by the given shape.</p>
<p>When an <code>amaranth.lib.enum.Enum</code> subclass is cast to a shape, if the internal attribute is set, the shape in it is returned. Otherwise it is cast to a shape using exactly the same logic as what <code>Shape.cast</code> uses for <code>enum.Enum</code> subclasses.</p>
<p>When an instance of a <code>enum.Enum</code> subclass is used in a concatenation, and it is not an instance of <code>ShapeCastable</code>, or if it lacks the <code>_amaranth_shape_</code> attribute, a warning is emitted. This approach avoids a circular dependency between <code>amaranth.hdl.ast</code> and <code>amaranth.lib.enum</code>.</p>
<h2 id="drawbacks"><a class="header" href="#drawbacks">Drawbacks</a></h2>
<ul>
<li>Introducing a new standard library module increases the API surface.</li>
<li>The names of enumeration base classes are the same as the standard library enumeration base classes, which may be confusing.</li>
<li>Deriving from a different class requires changes to the enumeration at its point of definition, meaning that it is not possible to annotate a enum that comes from an external library with an Amaranth shape.</li>
</ul>
<h2 id="rationale-and-alternatives"><a class="header" href="#rationale-and-alternatives">Rationale and alternatives</a></h2>
<p>Ultimately, this feature boils down to defining an internal variable on an enum, which is then used by <code>Shape.cast</code> and other core Amaranth code. There are a few possible options for doing this.</p>
<ol>
<li>
<p>Special class variable:</p>
<pre><code class="language-python">class SomeEnum(enum.Enum):
    _amaranth_shape_ = unsigned(4)
</code></pre>
</li>
<li>
<p>Class decorator:</p>
<pre><code class="language-python">@amaranth.shape(unsigned(4))
class SomeEnum(enum.Enum):
</code></pre>
</li>
<li>
<p>Class keyword argument (this proposal):</p>
<pre><code class="language-python">class SomeEnum(amaranth.lib.enum.Enum, shape=unsigned(4)):
</code></pre>
</li>
</ol>
<p>Alternative (1) has the following drawbacks:</p>
<ul>
<li>It is not possible to check that the enumeration members can be represented by the specified shape at the point of definition.</li>
<li>It exposes what should be an implementation detail to the user.</li>
<li>The documentation for the standard <code>enum</code> module does not specify whether it's OK to use <code>_sunder_</code> names for one's own purposes, but it would have to be a part of the stable API.</li>
</ul>
<p>Its advantages are:</p>
<ul>
<li>No additional methods or classes in the API surface.</li>
<li><code>_amaranth_shape_</code> makes it immediately clear what's going on.</li>
<li>The variable can be defined on any enum, even an external one.</li>
</ul>
<p>Alternative (2) has the following drawbacks:</p>
<ul>
<li>It's not clear where the <code>shape</code> decorator should be. It can only be applied to enums, but there's no enum-specific namespace in Amaranth core to put it into.</li>
<li><code>SomeEnum</code> would inherit from the standard <code>Enum</code> class and therefore <code>isinstance(SomeEnum, ShapeCastable)</code> would be <code>False</code> unless <code>ShapeCastable.__instancecheck__</code> is overridden to fix that.</li>
</ul>
<p>Its advantages are:</p>
<ul>
<li>The decorator can be applied to an external enum.</li>
</ul>
<p>Alternative (3) has the drawbacks specified above, and the following advantages:</p>
<ul>
<li><code>isinstance(SomeEnum, ShapeCastable)</code> naturally works.</li>
<li>As a consequence, no additional code is required in the core language. All of the functionality necessary for the feature to work lives in <code>amaranth.lib.enum</code>.</li>
<li>The <code>shape</code> argument matches <code>Signal(shape=)</code> (even though no one uses the keyword form) and works the way one would naturally expect.</li>
<li>Uses of <code>import enum</code> can be transparently replaced with <code>from amaranth.lib import enum</code> without updating the call sites, making the migration as easy as the other alternatives.</li>
</ul>
<h2 id="prior-art"><a class="header" href="#prior-art">Prior art</a></h2>
<p>None.</p>
<h2 id="unresolved-questions"><a class="header" href="#unresolved-questions">Unresolved questions</a></h2>
<p>None.</p>
<h2 id="future-possibilities"><a class="header" href="#future-possibilities">Future possibilities</a></h2>
<p>None.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="0002-interfaces.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="0004-const-castable-exprs.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="0002-interfaces.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="0004-const-castable-exprs.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
