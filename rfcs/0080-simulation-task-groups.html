<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0080-simulation-task-groups - The Amaranth RFC Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/img-color-scheme.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="0001-aggregate-data-structures.html">0001-aggregate-data-structures</a></li><li class="chapter-item expanded "><a href="0002-interfaces.html">0002-interfaces</a></li><li class="chapter-item expanded "><a href="0003-enumeration-shapes.html">0003-enumeration-shapes</a></li><li class="chapter-item expanded "><a href="0004-const-castable-exprs.html">0004-const-castable-exprs</a></li><li class="chapter-item expanded "><a href="0005-remove-const-normalize.html">0005-remove-const-normalize</a></li><li class="chapter-item expanded "><a href="0006-stdlib-crc.html">0006-stdlib-crc</a></li><li class="chapter-item expanded "><a href="0008-aggregate-extensibility.html">0008-aggregate-extensibility</a></li><li class="chapter-item expanded "><a href="0009-const-init-shape-castable.html">0009-const-init-shape-castable</a></li><li class="chapter-item expanded "><a href="0010-move-repl-to-value.html">0010-move-repl-to-value</a></li><li class="chapter-item expanded "><a href="0015-lifting-shape-castables.html">0015-lifting-shape-castables</a></li><li class="chapter-item expanded "><a href="0016-soc-csr-regs.html">0016-soc-csr-regs</a></li><li class="chapter-item expanded "><a href="0017-remove-log2-int.html">0017-remove-log2-int</a></li><li class="chapter-item expanded "><a href="0018-reorganize-vendor-platforms.html">0018-reorganize-vendor-platforms</a></li><li class="chapter-item expanded "><a href="0019-remove-scheduler.html">0019-remove-scheduler</a></li><li class="chapter-item expanded "><a href="0020-deprecate-non-fwft-fifos.html">0020-deprecate-non-fwft-fifos</a></li><li class="chapter-item expanded "><a href="0021-patch-releases.html">0021-patch-releases</a></li><li class="chapter-item expanded "><a href="0022-valuecastable-shape.html">0022-valuecastable-shape</a></li><li class="chapter-item expanded "><a href="0027-simulator-testbenches.html">0027-simulator-testbenches</a></li><li class="chapter-item expanded "><a href="0028-override-value-operators.html">0028-override-value-operators</a></li><li class="chapter-item expanded "><a href="0030-component-metadata.html">0030-component-metadata</a></li><li class="chapter-item expanded "><a href="0031-enumeration-type-safety.html">0031-enumeration-type-safety</a></li><li class="chapter-item expanded "><a href="0034-interface-rename.html">0034-interface-rename</a></li><li class="chapter-item expanded "><a href="0035-shapelike-valuelike.html">0035-shapelike-valuelike</a></li><li class="chapter-item expanded "><a href="0036-async-testbench-functions.html">0036-async-testbench-functions</a></li><li class="chapter-item expanded "><a href="0037-make-signature-immutable.html">0037-make-signature-immutable</a></li><li class="chapter-item expanded "><a href="0038-component-signature-immutability.html">0038-component-signature-immutability</a></li><li class="chapter-item expanded "><a href="0039-empty-case.html">0039-empty-case</a></li><li class="chapter-item expanded "><a href="0040-arbitrary-memory-shape.html">0040-arbitrary-memory-shape</a></li><li class="chapter-item expanded "><a href="0042-const-from-shape-castable.html">0042-const-from-shape-castable</a></li><li class="chapter-item expanded "><a href="0043-rename-reset-to-init.html">0043-rename-reset-to-init</a></li><li class="chapter-item expanded "><a href="0045-lib-memory.html">0045-lib-memory</a></li><li class="chapter-item expanded "><a href="0046-shape-range-1.html">0046-shape-range-1</a></li><li class="chapter-item expanded "><a href="0049-soc-gpio-peripheral.html">0049-soc-gpio-peripheral</a></li><li class="chapter-item expanded "><a href="0050-print.html">0050-print</a></li><li class="chapter-item expanded "><a href="0051-const-from-bits.html">0051-const-from-bits</a></li><li class="chapter-item expanded "><a href="0052-choice.html">0052-choice</a></li><li class="chapter-item expanded "><a href="0053-ioport.html">0053-ioport</a></li><li class="chapter-item expanded "><a href="0054-read-port-init.html">0054-read-port-init</a></li><li class="chapter-item expanded "><a href="0055-lib-io.html">0055-lib-io</a></li><li class="chapter-item expanded "><a href="0056-mem-wide.html">0056-mem-wide</a></li><li class="chapter-item expanded "><a href="0057-single-field-shortcut.html">0057-single-field-shortcut</a></li><li class="chapter-item expanded "><a href="0058-valuecastable-format.html">0058-valuecastable-format</a></li><li class="chapter-item expanded "><a href="0059-no-domain-upwards-propagation.html">0059-no-domain-upwards-propagation</a></li><li class="chapter-item expanded "><a href="0061-minimal-streams.html">0061-minimal-streams</a></li><li class="chapter-item expanded "><a href="0062-memory-data.html">0062-memory-data</a></li><li class="chapter-item expanded "><a href="0063-remove-lib-coding.html">0063-remove-lib-coding</a></li><li class="chapter-item expanded "><a href="0065-format-struct-enum.html">0065-format-struct-enum</a></li><li class="chapter-item expanded "><a href="0066-simulation-time.html">0066-simulation-time</a></li><li class="chapter-item expanded "><a href="0069-simulation-port.html">0069-simulation-port</a></li><li class="chapter-item expanded "><a href="0070-soc-memory-map-names.html">0070-soc-memory-map-names</a></li><li class="chapter-item expanded "><a href="0071-enumview-matches.html">0071-enumview-matches</a></li><li class="chapter-item expanded "><a href="0073-stricter-connections.html">0073-stricter-connections</a></li><li class="chapter-item expanded "><a href="0074-structured-vcd.html">0074-structured-vcd</a></li><li class="chapter-item expanded "><a href="0076-amaranth-boards-versioning-policy.html">0076-amaranth-boards-versioning-policy</a></li><li class="chapter-item expanded "><a href="0077-stream-port-name-conventions.html">0077-stream-port-name-conventions</a></li><li class="chapter-item expanded "><a href="0079-port-with-direction.html">0079-port-with-direction</a></li><li class="chapter-item expanded "><a href="0080-simulation-task-groups.html" class="active">0080-simulation-task-groups</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Amaranth RFC Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/amaranth-lang/rfcs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <ul>
<li>Start Date: 2025-07-28</li>
<li>RFC PR: <a href="https://github.com/amaranth-lang/rfcs/pull/80">amaranth-lang/rfcs#80</a></li>
<li>Amaranth Issue: <a href="https://github.com/amaranth-lang/amaranth/issues/1620">amaranth-lang/amaranth#1620</a></li>
</ul>
<h1 id="simulation-task-groups"><a class="header" href="#simulation-task-groups">Simulation task groups</a></h1>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>Add task groups to the simulator to allow parallel execution in a testbench.</p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>When testing a component, it's common to need to interact with multiple interfaces in parallel.
For instance, when testing a stream component, the output stream must typically be read in parallel with writing the input stream to avoid backpressure from the output stream to propagate back to the input stream and deadlock the simulation.
Currently this must be done by adding independent testbenches, which can be awkward to synchronize.</p>
<h2 id="guide-level-explanation"><a class="header" href="#guide-level-explanation">Guide-level explanation</a></h2>
<p>Typical testbenches for a stream component can currently look like this:</p>
<pre><code class="language-python">test_vectors = [...]

async def input_testbench(ctx: SimulatorContext):
    for input in test_vectors:
        await send_packet(ctx, dut.i, input)

async def output_testbench(ctx: SimulatorContext):
    for input in test_vectors:
        output = await recv_packet(ctx, dut.o)
        assert output == expected_output(input)
</code></pre>
<p>With task groups, this can instead be written like:</p>
<pre><code class="language-python">test_vectors = [...]

async def testbench(ctx: SimulatorContext):
    for input in test_vectors:
        async with ctx.group() as group:
            group.start(send_packet(ctx, dut.i, input))
            output = await recv_packet(ctx, dut.o)
            assert output == expected_output(input)
</code></pre>
<p>In a similar manner to background testbenches, it is also possible to add background tasks, for tasks that are not intended to run to completion.
This allows code like this:</p>
<pre><code class="language-python">@asynccontextmanager
async def timeout(ctx, ticks, domain = 'sync'):
    async def task():
        await ctx.tick(domain).repeat(ticks) # Never returns if the task group ends before `ticks` have elapsed.
        raise TimeoutError()

    async with ctx.group() as group:
        group.start(task(ctx, ticks, domain), background = True)
        yield

async def testbench(ctx):
    async with timeout(ctx, 100):
        ... # Some operation expected to take less than 100 ticks

    async with timeout(ctx, 200):
        ... # Some other operation expected to take less than 200 ticks
</code></pre>
<h2 id="reference-level-explanation"><a class="header" href="#reference-level-explanation">Reference-level explanation</a></h2>
<p><code>SimulatorContext</code> have the following methods added:</p>
<ul>
<li><code>group() -&gt; TaskGroup</code>
<ul>
<li>Create a new task group.</li>
</ul>
</li>
<li><code>async gather(coros*) -&gt; tuple</code>
<ul>
<li>Shorthand for creating a task group, starting all <code>coros</code>, letting the group run to completion and collecting the return values.</li>
<li>Example implementation:
<pre><code class="language-python">    async def gather(self, *coros):
        async with self.group() as group:
            tasks = [group.start(coro) for coro in coros]
        return tuple(task.result() for task in tasks)
</code></pre>
</li>
</ul>
</li>
</ul>
<p><code>TaskGroup</code> is added with the following methods:</p>
<ul>
<li><code>start(coro, *, background = False) -&gt; Task</code>
<ul>
<li>Create and start a new task.</li>
<li>A background task can be temporarily made non-background with <code>ctx.critical()</code> like a regular testbench.</li>
<li>Raise an exception if called before <code>__aenter__()</code> or after <code>__aexit__()</code>.</li>
</ul>
</li>
<li><code>async __aenter__() -&gt; Self</code>
<ul>
<li>Return <code>self</code>.</li>
<li>Raise an exception if called multiple times.</li>
</ul>
</li>
<li><code>async __aexit__(...)</code>
<ul>
<li>Wait for all non-background tasks to run to completion.</li>
<li>Once all non-background tasks are done, any remaining background tasks are dropped without returning or unwinding from their pending awaits.</li>
<li>Raise an exception if called multiple times or if called without calling <code>__aenter__()</code> first.</li>
</ul>
</li>
</ul>
<p><code>Task</code> is added with the following methods:</p>
<ul>
<li><code>done() -&gt; bool</code>
<ul>
<li>Return whether the task has completed.</li>
</ul>
</li>
<li><code>result() -&gt; Any</code>
<ul>
<li>Get the return value of a completed task.</li>
<li>Raise an exception if the task has not completed.</li>
</ul>
</li>
</ul>
<p>Exception propagation and task cancellation (beyond dropping background tasks when a group is done) are out of scope for this RFC.
If a task raises any unhandled exceptions, this immediately terminates the simulation and propagates out of the simulator as if raised from an independent testbench.</p>
<h2 id="drawbacks"><a class="header" href="#drawbacks">Drawbacks</a></h2>
<ul>
<li>Increased simulator complexity.</li>
</ul>
<h2 id="rationale-and-alternatives"><a class="header" href="#rationale-and-alternatives">Rationale and alternatives</a></h2>
<p>Exception propagation and task cancellation was omitted from the scope of this RFC because it would significantly increase complexity, for limited benefit.
It is expected that the desired outcome of an unhandled exception in a task in most cases would be to terminate simulation and therefore don't need the ability for the parent testbench to catch it.</p>
<h2 id="prior-art"><a class="header" href="#prior-art">Prior art</a></h2>
<p>The proposed API is modelled after <code>asyncio.TaskGroup</code> and <code>asyncio.gather()</code>.</p>
<h2 id="unresolved-questions"><a class="header" href="#unresolved-questions">Unresolved questions</a></h2>
<ul>
<li>The usual bikeshedding of names.</li>
</ul>
<h2 id="future-possibilities"><a class="header" href="#future-possibilities">Future possibilities</a></h2>
<ul>
<li>A future RFC could add exception propagation and task cancellation.</li>
<li>Context managers like the timeout example above could be added for common cases.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="0079-port-with-direction.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="0079-port-with-direction.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
