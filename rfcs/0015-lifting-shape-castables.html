<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0015-lifting-shape-castables - The Amaranth RFC Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="0001-aggregate-data-structures.html">0001-aggregate-data-structures</a></li><li class="chapter-item expanded "><a href="0003-enumeration-shapes.html">0003-enumeration-shapes</a></li><li class="chapter-item expanded "><a href="0004-const-castable-exprs.html">0004-const-castable-exprs</a></li><li class="chapter-item expanded "><a href="0005-remove-const-normalize.html">0005-remove-const-normalize</a></li><li class="chapter-item expanded "><a href="0006-stdlib-crc.html">0006-stdlib-crc</a></li><li class="chapter-item expanded "><a href="0008-aggregate-extensibility.html">0008-aggregate-extensibility</a></li><li class="chapter-item expanded "><a href="0009-const-init-shape-castable.html">0009-const-init-shape-castable</a></li><li class="chapter-item expanded "><a href="0010-move-repl-to-value.html">0010-move-repl-to-value</a></li><li class="chapter-item expanded "><a href="0015-lifting-shape-castables.html" class="active">0015-lifting-shape-castables</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Amaranth RFC Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/amaranth-lang/rfcs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <ul>
<li>Start Date: 2023-05-15</li>
<li>RFC PR: <a href="https://github.com/amaranth-lang/rfcs/pull/15">amaranth-lang/rfcs#15</a></li>
<li>Amaranth Issue: <a href="https://github.com/amaranth-lang/amaranth/issues/784">amaranth-lang/amaranth#784</a></li>
</ul>
<h1 id="lifting-shape-castable-objects"><a class="header" href="#lifting-shape-castable-objects">Lifting shape-castable objects</a></h1>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>Make <code>Signal(shape_castable, ...)</code> return <code>shape_castable(Signal(shape_castable.as_shape(), ...))</code>.</p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>When Amaranth was a very new language, it did not have any facilities for ascribing type information to data. It had shapes (width and signedness), and it had special handling for <code>range()</code> in the shape position, as well as enumerations. Back then it made sense to have <code>Signal</code>, the single way to define new storage of any kind, to only operate on values (numbers / bit containers).</p>
<p>Today the situation is completely different. Amaranth has first-class support for enumerations in the standard library as well as the standard range of data structures (structs, unions, arrays) via <a href="0001-aggregate-data-structures.html">RFC 1</a> and <a href="0003-enumeration-shapes.html">RFC 3</a>. It provides extensibility through <a href="0008-aggregate-extensibility.html">RFC 8</a> and <a href="0009-const-init-shape-castable.html">RFC 9</a>. Using the existing hooks alone it is possible to extend Amaranth with rich numeric types (fixed-point, complex, potentially even floating-point), and some of these are very likely to end up in the standard library.</p>
<p>All of this new functionality internally wraps a <code>Value</code>. It is so common and useful to initialize e.g. a struct view with a fresh <code>Signal</code> that <code>data.View</code> reexports all of the arguments of the <code>Signal</code> constructors and automatically constructs a <code>Signal</code> if no view target is provided. This works, but ties the two together more than would be ideal, and requires every similar facility to reimplement the functionality itself. What is worse is that it seems to be quite confusing to programmers, since it's not apparent that calling <code>data.View(foo_layout)</code> internally creates a <code>Signal</code>. Furthermore, people want to call <code>Signal(foo_layout)</code> to construct some storage for <code>foo_layout</code>, and that works (<code>foo_layout</code> is shape-castable), but does the wrong thing: the returned object is a <code>Signal</code>, not a <code>data.View</code>.</p>
<p>It would make teaching a lot easier if we could draw an equivalence between a <code>Signal</code> and a variable in a general purpose programming language, and between its shape and a type in a general purpose programming language. Then, no matter what shape-castable object it is, the way to make some storage is <code>Signal(x)</code>. It will also simplify the internals a fair bit.</p>
<p>This change wasn't practical before <a href="0008-aggregate-extensibility.html">RFC 8</a> and <a href="0009-const-init-shape-castable.html">RFC 9</a> laid the groundwork for it, but now it is an obvious extension.</p>
<h2 id="guide-level-explanation"><a class="header" href="#guide-level-explanation">Guide-level explanation</a></h2>
<p>To include state in a design, use the <code>Signal(shape)</code> constructor, where <code>shape</code> describes the bit layout and possible operations on that state. The <code>reset=</code> argument and the returned value depend on the <code>shape</code> that is provided. If it is <code>signed(N)</code> or <code>unsigned(N)</code> or a built-in enumeration or a <code>range</code>, then a plain <code>Value</code> is returned, and the <code>reset=</code> argument accepts a number, an enumeration member, or a constant. If it is a <code>data.Layout</code>, then a <code>data.View</code> is returned, and the <code>reset=</code> argument accepts a sequence or a mapping, potentially nested for nested layouts. Other shape-castable classes will have their own behavior.</p>
<blockquote>
<p><strong>Warning</strong>
The existing syntax for creating a <code>View</code> with a new <code>Signal</code> underlying it will be removed immediately (it has never been in a release) to resolve an ambiguity over the semantics of <code>__call__</code>.</p>
</blockquote>
<h2 id="reference-level-explanation"><a class="header" href="#reference-level-explanation">Reference-level explanation</a></h2>
<p>A method <code>def __call__(self, value):</code> is added on <code>ShapeCastable</code>. It must return <code>Value</code> or a <code>ValueCastable</code> instance with the right shape. (Such a method is opportunistically used by <code>data.View</code> for nested views since <a href="0008-aggregate-extensibility.html">RFC 8</a>, however this RFC makes it mandatory for all shape-castable objects.)</p>
<p>The <code>Signal.__call__(shape, ...)</code> method is overridden (on the metaclass) to consider <code>shape</code>. First, a <code>signal</code> is constructed normally with all of the arguments. Afterwards, if <code>shape</code> is a <code>ShapeCastable</code> instance, then <code>shape(signal)</code> is returned. Otherwise <code>signal</code> is returned.</p>
<h2 id="drawbacks"><a class="header" href="#drawbacks">Drawbacks</a></h2>
<ul>
<li>Increase in language complexity.</li>
<li>More metaclasses.
<ul>
<li><code>Signal</code> is a final class so this is unlikely to go wrong.</li>
</ul>
</li>
<li>A <code>Signal()</code> constructor sometimes returning non-<code>Signal</code> objects can be confusing.</li>
</ul>
<h2 id="rationale-and-alternatives"><a class="header" href="#rationale-and-alternatives">Rationale and alternatives</a></h2>
<p>There are several arguments in favor of the design:</p>
<ul>
<li>It does not de facto introduce any new methods on protocols, since <code>ShapeCastable.__call__</code> is expected to be implemented by essentially everyone after <a href="0008-aggregate-extensibility.html">RFC 8</a>.</li>
<li>It does not introduce new complexity to <code>Signal.__init__</code>; the logic for handling non-integer reset exists since <a href="0009-const-init-shape-castable.html">RFC 9</a>.</li>
<li>It eliminates unnecessary coupling between <code>data.View</code> (and other similar facilities) and <code>Signal()</code>.</li>
<li>It is a natural extension of the language and has clear parallels to the notion of variables in other languages.</li>
<li>It has been repeatedly requested by users, almost every time someone became familiar with the aggregate data structure design.</li>
</ul>
<p>All of these points are compelling but the last one perhaps the most. The author did not find it a stark enough necessity to introduce themselves but it does seem to be one.</p>
<p>Alternatives:</p>
<ul>
<li>Do not do this. The status quo is acceptable.</li>
</ul>
<h2 id="prior-art"><a class="header" href="#prior-art">Prior art</a></h2>
<p>This RFC brings the semantics of <code>Signal</code> to be very close to semantics of typed variables in other languages.</p>
<p>&quot;Lifting&quot; in the title of this RFC refers to a <a href="https://wiki.haskell.org/Lifting">concept in functional programming</a> of the same name where a higher order function (<code>Signal</code>, here) is used to generalize an operation over a set of other functions (<code>data.View</code> and other shape-castable objects that implement the <code>__call__</code> protocol, here).</p>
<h2 id="unresolved-questions"><a class="header" href="#unresolved-questions">Unresolved questions</a></h2>
<ul>
<li>How does this interact with typechecking?
<ul>
<li>This is a straightforward higher order function so it's probably fine.</li>
</ul>
</li>
</ul>
<h2 id="future-possibilities"><a class="header" href="#future-possibilities">Future possibilities</a></h2>
<p>This RFC is the final one in a chain that started with <a href="0001-aggregate-data-structures.html">RFC 1</a>.</p>
<p>Enumerations and ranges could be adjusted such that something other than <code>Value</code> is returned. This creates backwards compatibility concerns though.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="0010-move-repl-to-value.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="0010-move-repl-to-value.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
