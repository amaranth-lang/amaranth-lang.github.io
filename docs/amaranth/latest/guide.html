<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Language guide &mdash; Amaranth language &amp; toolchain 0.5.0.dev274 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/platformpicker.css" />
      <link rel="stylesheet" type="text/css" href="_static/custom.css?v=d131d90a" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js?v=db573677"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="_static/platformpicker.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Language reference" href="reference.html" />
    <link rel="prev" title="Tutorial" href="tutorial.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="cover.html" class="icon icon-home">
            Amaranth language & toolchain
              <img src="_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.5.0.dev274
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Language &amp; toolchain</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="start.html">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Language guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-prelude">The prelude</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shapes">Shapes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#shapes-of-values">Shapes of values</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#values">Values</a></li>
<li class="toctree-l3"><a class="reference internal" href="#constants">Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shape-casting">Shape casting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#shapes-from-integers">Shapes from integers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#shapes-from-ranges">Shapes from ranges</a></li>
<li class="toctree-l4"><a class="reference internal" href="#shapes-from-enumerations">Shapes from enumerations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#custom-shapes">Custom shapes</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#value-casting">Value casting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#values-from-integers">Values from integers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#values-from-enumeration-members">Values from enumeration members</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#constant-casting">Constant casting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#signals">Signals</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#signal-shapes">Signal shapes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#signal-names">Signal names</a></li>
<li class="toctree-l4"><a class="reference internal" href="#initial-signal-values">Initial signal values</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reset-less-signals">Reset-less signals</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#operators">Operators</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#performing-or-describing-computations">Performing or describing computations?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#width-extension">Width extension</a></li>
<li class="toctree-l4"><a class="reference internal" href="#arithmetic-operators">Arithmetic operators</a></li>
<li class="toctree-l4"><a class="reference internal" href="#comparison-operators">Comparison operators</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bitwise-shift-and-rotate-operators">Bitwise, shift, and rotate operators</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reduction-operators">Reduction operators</a></li>
<li class="toctree-l4"><a class="reference internal" href="#logical-operators">Logical operators</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bit-sequence-operators">Bit sequence operators</a></li>
<li class="toctree-l4"><a class="reference internal" href="#match-operator">Match operator</a></li>
<li class="toctree-l4"><a class="reference internal" href="#conversion-operators">Conversion operators</a></li>
<li class="toctree-l4"><a class="reference internal" href="#choice-operator">Choice operator</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#arrays">Arrays</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-structures">Data structures</a></li>
<li class="toctree-l3"><a class="reference internal" href="#modules">Modules</a></li>
<li class="toctree-l3"><a class="reference internal" href="#control-domains">Control domains</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#assigning-to-signals">Assigning to signals</a></li>
<li class="toctree-l4"><a class="reference internal" href="#assignable-values">Assignable values</a></li>
<li class="toctree-l4"><a class="reference internal" href="#assignment-domains">Assignment domains</a></li>
<li class="toctree-l4"><a class="reference internal" href="#assignment-order">Assignment order</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#control-flow">Control flow</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#active-and-inactive-assignments">Active and inactive assignments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#if-elif-else-control-blocks"><code class="code highlight py python docutils literal highlight-python"><span class="n">If</span></code>/<code class="code highlight py python docutils literal highlight-python"><span class="n">Elif</span></code>/<code class="code highlight py python docutils literal highlight-python"><span class="n">Else</span></code> control blocks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#switch-case-control-blocks"><code class="code highlight py python docutils literal highlight-python"><span class="n">Switch</span></code>/<code class="code highlight py python docutils literal highlight-python"><span class="n">Case</span></code> control blocks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fsm-state-control-blocks"><code class="code highlight py python docutils literal highlight-python"><span class="n">FSM</span></code>/<code class="code highlight py python docutils literal highlight-python"><span class="n">State</span></code> control blocks</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#combinational-evaluation">Combinational evaluation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#synchronous-evaluation">Synchronous evaluation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#assertions">Assertions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#debug-printing">Debug printing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#clock-domains">Clock domains</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#late-binding-of-clock-and-reset-signals">Late binding of clock and reset signals</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#elaboration">Elaboration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#submodules">Submodules</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modifying-control-flow">Modifying control flow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#renaming-domains">Renaming domains</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#memories">Memories</a></li>
<li class="toctree-l3"><a class="reference internal" href="#i-o-values">I/O values</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#i-o-ports">I/O ports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#i-o-operators">I/O operators</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#instances">Instances</a></li>
<li class="toctree-l3"><a class="reference internal" href="#i-o-buffer-instances">I/O buffer instances</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="reference.html">Language reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="stdlib.html">Standard library</a></li>
<li class="toctree-l2"><a class="reference internal" href="platform.html">Platform integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="changes.html">Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="contrib.html">Contributing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://amaranth-lang.org/docs/amaranth-stdio/latest/">Standard I/O components</a></li>
<li class="toctree-l1"><a class="reference external" href="https://amaranth-lang.org/docs/amaranth-soc/latest/">System on Chip toolkit</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="cover.html">Amaranth language & toolchain</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="cover.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Language &amp; toolchain</a></li>
      <li class="breadcrumb-item active">Language guide</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/guide.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="language-guide">
<h1>Language guide<a class="headerlink" href="#language-guide" title="Permalink to this heading"></a></h1>
<p>This guide introduces the Amaranth language in depth. It assumes familiarity with synchronous digital logic and the Python programming language, but does not require prior experience with any hardware description language. See the <a class="reference internal" href="tutorial.html"><span class="doc">tutorial</span></a> for a step-by-step introduction to the language, and the <a class="reference internal" href="reference.html"><span class="doc">reference</span></a> for a detailed description of the Python classes that underlie the language’s syntax.</p>
<section id="the-prelude">
<span id="lang-prelude"></span><h2>The prelude<a class="headerlink" href="#the-prelude" title="Permalink to this heading"></a></h2>
<p>Because Amaranth is a regular Python library, it needs to be imported before use. The root <code class="docutils literal notranslate"><span class="pre">amaranth</span></code> module, called <em>the prelude</em>, is carefully curated to export a small amount of the most essential names, useful in nearly every design. In source files dedicated to Amaranth code, it is a good practice to use a <a class="reference external" href="https://docs.python.org/3/tutorial/modules.html#tut-pkg-import-star" title="(in Python v3.12)"><span class="xref std std-ref">glob import</span></a> for readability:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">amaranth</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>However, if a source file uses Amaranth together with other libraries, or if glob imports are frowned upon, it is conventional to use a short alias instead:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">amaranth</span> <span class="k">as</span> <span class="nn">am</span>
</pre></div>
</div>
<p>All of the examples below assume that a glob import is used.</p>
</section>
<section id="shapes">
<span id="lang-shapes"></span><h2>Shapes<a class="headerlink" href="#shapes" title="Permalink to this heading"></a></h2>
<p>A <a class="reference internal" href="reference.html#amaranth.hdl.Shape" title="amaranth.hdl.Shape"><code class="xref py py-class docutils literal notranslate"><span class="pre">Shape</span></code></a> describes the bit width and signedness of an Amaranth value. It can be constructed directly:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Shape</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="go">unsigned(5)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Shape</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="go">signed(12)</span>
</pre></div>
</div>
<p>However, in most cases, the signedness of a shape is known upfront, and the convenient aliases <a class="reference internal" href="reference.html#amaranth.hdl.signed" title="amaranth.hdl.signed"><code class="xref py py-func docutils literal notranslate"><span class="pre">signed()</span></code></a> and <a class="reference internal" href="reference.html#amaranth.hdl.unsigned" title="amaranth.hdl.unsigned"><code class="xref py py-func docutils literal notranslate"><span class="pre">unsigned()</span></code></a> can be used:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">unsigned</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">Shape</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">signed</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">==</span> <span class="n">Shape</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
<section id="shapes-of-values">
<h3>Shapes of values<a class="headerlink" href="#shapes-of-values" title="Permalink to this heading"></a></h3>
<p>All values have a <code class="docutils literal notranslate"><span class="pre">.shape()</span></code> method that computes their shape. The width of a value <code class="docutils literal notranslate"><span class="pre">v</span></code>, <code class="docutils literal notranslate"><span class="pre">v.shape().width</span></code>, can also be retrieved with <code class="docutils literal notranslate"><span class="pre">len(v)</span></code>.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Const</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
<span class="go">unsigned(3)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">Const</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="go">3</span>
</pre></div>
</div>
</section>
</section>
<section id="values">
<span id="lang-values"></span><h2>Values<a class="headerlink" href="#values" title="Permalink to this heading"></a></h2>
<p>The basic building block of the Amaranth language is a <em>value</em>, which is a term for a binary number that is computed or stored anywhere in the design. Each value has a <em>width</em>—the amount of bits used to represent the value—and a <em>signedness</em>—the interpretation of the value by arithmetic operations—collectively called its <em>shape</em>. Signed values always use <a class="reference external" href="https://en.wikipedia.org/wiki/Two's_complement">two’s complement</a> representation.</p>
</section>
<section id="constants">
<span id="lang-constants"></span><h2>Constants<a class="headerlink" href="#constants" title="Permalink to this heading"></a></h2>
<p>The simplest Amaranth value is a <em>constant</em>, representing a fixed number, and introduced using <code class="docutils literal notranslate"><span class="pre">Const(...)</span></code> or its short alias <code class="docutils literal notranslate"><span class="pre">C(...)</span></code>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ten</span> <span class="o">=</span> <span class="n">Const</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">minus_two</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>The code above does not specify any shape for the constants. If the shape is omitted, Amaranth uses unsigned shape for positive numbers and signed shape for negative numbers, with the width inferred from the smallest amount of bits necessary to represent the number. As a special case, in order to get the same inferred shape for <code class="docutils literal notranslate"><span class="pre">True</span></code> and <code class="docutils literal notranslate"><span class="pre">False</span></code>, <code class="docutils literal notranslate"><span class="pre">0</span></code> is considered to be 1-bit unsigned.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ten</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
<span class="go">unsigned(4)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">minus_two</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
<span class="go">signed(2)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">C</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
<span class="go">unsigned(1)</span>
</pre></div>
</div>
<p>The shape of the constant can be specified explicitly, in which case the number’s binary representation will be truncated or extended to fit the shape. Although rarely useful, 0-bit constants are permitted.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Const</span><span class="p">(</span><span class="mi">360</span><span class="p">,</span> <span class="n">unsigned</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="o">.</span><span class="n">value</span>
<span class="go">104</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Const</span><span class="p">(</span><span class="mi">129</span><span class="p">,</span> <span class="n">signed</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="o">.</span><span class="n">value</span>
<span class="go">-127</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Const</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">unsigned</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">value</span>
<span class="go">0</span>
</pre></div>
</div>
</section>
<section id="shape-casting">
<span id="lang-shapelike"></span><h2>Shape casting<a class="headerlink" href="#shape-casting" title="Permalink to this heading"></a></h2>
<p>Shapes can be <em>cast</em> from other objects, which are called <em>shape-like</em>. Casting is a convenient way to specify a shape indirectly, for example, by a range of numbers representable by values with that shape. Shapes are shape-like objects as well.</p>
<p>Casting to a shape can be done explicitly with <a class="reference internal" href="reference.html#amaranth.hdl.Shape.cast" title="amaranth.hdl.Shape.cast"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Shape.cast()</span></code></a>, but is usually implicit, since shape-like objects are accepted anywhere shapes are.</p>
<section id="shapes-from-integers">
<span id="lang-shapeint"></span><h3>Shapes from integers<a class="headerlink" href="#shapes-from-integers" title="Permalink to this heading"></a></h3>
<p>Casting a shape from an integer <code class="docutils literal notranslate"><span class="pre">i</span></code> is a shorthand for constructing a shape with <a class="reference internal" href="reference.html#amaranth.hdl.unsigned" title="amaranth.hdl.unsigned"><code class="xref py py-func docutils literal notranslate"><span class="pre">unsigned(i)</span></code></a>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Shape</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="go">unsigned(5)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">C</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
<span class="go">unsigned(3)</span>
</pre></div>
</div>
</section>
<section id="shapes-from-ranges">
<span id="lang-shaperange"></span><h3>Shapes from ranges<a class="headerlink" href="#shapes-from-ranges" title="Permalink to this heading"></a></h3>
<p>Casting a shape from a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#range" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">range</span></code></a> <code class="docutils literal notranslate"><span class="pre">r</span></code> produces a shape that:</p>
<blockquote>
<div><ul class="simple">
<li><p>has a width large enough to represent both <code class="docutils literal notranslate"><span class="pre">min(r)</span></code> and <code class="docutils literal notranslate"><span class="pre">max(r)</span></code>, but not larger, and</p></li>
<li><p>is signed if <code class="docutils literal notranslate"><span class="pre">r</span></code> contains any negative values, unsigned otherwise.</p></li>
</ul>
</div></blockquote>
<p>Specifying a shape with a range is convenient for counters, indexes, and all other values whose width is derived from a set of numbers they must be able to fit:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Const</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
<span class="go">unsigned(7)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">C</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)))</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
<span class="go">unsigned(2)</span>
</pre></div>
</div>
<div class="admonition note" id="lang-exclrange">
<p class="admonition-title">Note</p>
<p>Python ranges are <em>exclusive</em> or <em>half-open</em>, meaning they do not contain their <code class="docutils literal notranslate"><span class="pre">.stop</span></code> element. Because of this, values with shapes cast from a <code class="docutils literal notranslate"><span class="pre">range(stop)</span></code> where <code class="docutils literal notranslate"><span class="pre">stop</span></code> is a power of 2 are not wide enough to represent <code class="docutils literal notranslate"><span class="pre">stop</span></code> itself:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">fencepost</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span>
<span class="go">&lt;...&gt;:1: SyntaxWarning: Value 256 equals the non-inclusive end of the constant shape range(0, 256); this is likely an off-by-one error</span>
<span class="go">  fencepost = C(256, range(256))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fencepost</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
<span class="go">unsigned(8)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fencepost</span><span class="o">.</span><span class="n">value</span>
<span class="go">0</span>
</pre></div>
</div>
<p>Amaranth detects uses of <code class="xref py py-class docutils literal notranslate"><span class="pre">Const</span></code> and <code class="xref py py-class docutils literal notranslate"><span class="pre">Signal</span></code> that invoke such an off-by-one error, and emits a diagnostic message.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>An empty range always casts to an <code class="code highlight py python docutils literal highlight-python"><span class="n">unsigned</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></code>, even if both of its bounds are negative.
This happens because, being empty, it does not contain any negative values.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Shape</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="go">unsigned(0)</span>
</pre></div>
</div>
</div>
</section>
<section id="shapes-from-enumerations">
<span id="lang-shapeenum"></span><h3>Shapes from enumerations<a class="headerlink" href="#shapes-from-enumerations" title="Permalink to this heading"></a></h3>
<p>Casting a shape from an <a class="reference external" href="https://docs.python.org/3/library/enum.html#enum.Enum" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">enum.Enum</span></code></a> subclass requires all of the enumeration members to have <a class="reference internal" href="#lang-constcasting"><span class="std std-ref">constant-castable</span></a> values. The shape has a width large enough to represent the value of every member, and is signed only if there is a member with a negative value.</p>
<p>Specifying a shape with an enumeration is convenient for finite state machines, multiplexers, complex control signals, and all other values whose width is derived from a few distinct choices they must be able to fit:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Direction</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">TOP</span>    <span class="o">=</span> <span class="mi">0</span>
    <span class="n">LEFT</span>   <span class="o">=</span> <span class="mi">1</span>
    <span class="n">BOTTOM</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">RIGHT</span>  <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Shape</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">Direction</span><span class="p">)</span>
<span class="go">unsigned(2)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="stdlib/enum.html#module-amaranth.lib.enum" title="amaranth.lib.enum"><code class="xref py py-mod docutils literal notranslate"><span class="pre">amaranth.lib.enum</span></code></a> module extends the standard enumerations such that their shape can be specified explicitly when they are defined:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Funct4</span><span class="p">(</span><span class="n">amaranth</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">unsigned</span><span class="p">(</span><span class="mi">4</span><span class="p">)):</span>
    <span class="n">ADD</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">SUB</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">MUL</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Shape</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">Funct4</span><span class="p">)</span>
<span class="go">unsigned(4)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The enumeration does not have to subclass <a class="reference external" href="https://docs.python.org/3/library/enum.html#enum.IntEnum" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">enum.IntEnum</span></code></a> or have <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a> as one of its base classes; it only needs to have integers as values of every member. Using enumerations based on <a class="reference external" href="https://docs.python.org/3/library/enum.html#enum.Enum" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">enum.Enum</span></code></a> rather than <a class="reference external" href="https://docs.python.org/3/library/enum.html#enum.IntEnum" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">enum.IntEnum</span></code></a> prevents unwanted implicit conversion of enum members to integers.</p>
</div>
</section>
<section id="custom-shapes">
<span id="lang-shapecustom"></span><h3>Custom shapes<a class="headerlink" href="#custom-shapes" title="Permalink to this heading"></a></h3>
<p>Any Python value that implements the <a class="reference internal" href="reference.html#amaranth.hdl.ShapeCastable" title="amaranth.hdl.ShapeCastable"><code class="xref py py-class docutils literal notranslate"><span class="pre">ShapeCastable</span></code></a> interface can extend the language with a custom shape-like object. For example, the standard library module <a class="reference internal" href="stdlib/data.html#module-amaranth.lib.data" title="amaranth.lib.data"><code class="xref py py-mod docutils literal notranslate"><span class="pre">amaranth.lib.data</span></code></a> uses this facility to add support for aggregate data types to the language.</p>
</section>
</section>
<section id="value-casting">
<span id="lang-valuelike"></span><h2>Value casting<a class="headerlink" href="#value-casting" title="Permalink to this heading"></a></h2>
<p>Like shapes, values may be <em>cast</em> from other objects, which are called <em>value-like</em>. Casting to values allows objects that are not provided by Amaranth, such as integers or enumeration members, to be used in Amaranth expressions directly. Custom value-like objects can be defined by implementing the <a class="reference internal" href="reference.html#amaranth.hdl.ValueCastable" title="amaranth.hdl.ValueCastable"><code class="xref py py-class docutils literal notranslate"><span class="pre">ValueCastable</span></code></a> interface. Values are value-like objects as well.</p>
<p>Casting to a value can be done explicitly with <a class="reference internal" href="reference.html#amaranth.hdl.Value.cast" title="amaranth.hdl.Value.cast"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Value.cast()</span></code></a>, but is usually implicit, since value-like objects are accepted anywhere values are.</p>
<section id="values-from-integers">
<h3>Values from integers<a class="headerlink" href="#values-from-integers" title="Permalink to this heading"></a></h3>
<p>Casting a value from an integer <code class="docutils literal notranslate"><span class="pre">i</span></code> is equivalent to <code class="xref py py-class docutils literal notranslate"><span class="pre">Const(i)</span></code>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Value</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="go">(const 3&#39;d5)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If a value subclasses <a class="reference external" href="https://docs.python.org/3/library/enum.html#enum.IntEnum" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">enum.IntEnum</span></code></a> or its class otherwise inherits from both <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a> and <code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code>, it is treated as an enumeration.</p>
</div>
</section>
<section id="values-from-enumeration-members">
<h3>Values from enumeration members<a class="headerlink" href="#values-from-enumeration-members" title="Permalink to this heading"></a></h3>
<p>Casting a value from an enumeration member <code class="docutils literal notranslate"><span class="pre">m</span></code> is equivalent to <code class="docutils literal notranslate"><span class="pre">Const(m.value,</span> <span class="pre">type(m))</span></code>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Value</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">Direction</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
<span class="go">(const 2&#39;d1)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If a value subclasses <a class="reference external" href="https://docs.python.org/3/library/enum.html#enum.IntEnum" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">enum.IntEnum</span></code></a> or its class otherwise inherits from both <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a> and <code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code>, it is treated as an enumeration.</p>
</div>
</section>
</section>
<section id="constant-casting">
<span id="lang-constcasting"></span><h2>Constant casting<a class="headerlink" href="#constant-casting" title="Permalink to this heading"></a></h2>
<p>A subset of <a class="reference internal" href="#lang-values"><span class="std std-ref">values</span></a> are <em>constant-castable</em>. If a value is constant-castable and all of its operands are also constant-castable, it can be converted to a <code class="xref py py-class docutils literal notranslate"><span class="pre">Const</span></code>, the numeric value of which can then be read by Python code. This provides a way to perform computation on Amaranth values while constructing the design.</p>
<p>Constant-castable objects are accepted anywhere a constant integer is accepted. Casting to a constant can also be done explicitly with <code class="xref py py-meth docutils literal notranslate"><span class="pre">Const.cast()</span></code>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Const</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">Cat</span><span class="p">(</span><span class="n">C</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">C</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="go">(const 6&#39;d26)</span>
</pre></div>
</div>
<p>They may be used in enumeration members, provided the enumeration inherits from <a class="reference internal" href="stdlib/enum.html#amaranth.lib.enum.Enum" title="amaranth.lib.enum.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">amaranth.lib.enum.Enum</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Funct</span><span class="p">(</span><span class="n">amaranth</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">ADD</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="o">...</span>

<span class="k">class</span> <span class="nc">Op</span><span class="p">(</span><span class="n">amaranth</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">REG</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">IMM</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">class</span> <span class="nc">Instr</span><span class="p">(</span><span class="n">amaranth</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">ADD</span>  <span class="o">=</span> <span class="n">Cat</span><span class="p">(</span><span class="n">Funct</span><span class="o">.</span><span class="n">ADD</span><span class="p">,</span> <span class="n">Op</span><span class="o">.</span><span class="n">REG</span><span class="p">)</span>
    <span class="n">ADDI</span> <span class="o">=</span> <span class="n">Cat</span><span class="p">(</span><span class="n">Funct</span><span class="o">.</span><span class="n">ADD</span><span class="p">,</span> <span class="n">Op</span><span class="o">.</span><span class="n">IMM</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>They may also be provided as a pattern to the <a class="reference internal" href="#lang-matchop"><span class="std std-ref">match operator</span></a> and the <a class="reference internal" href="#lang-switch"><span class="std std-ref">Case block</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>At the moment, only the following expressions are constant-castable:</p>
<ul class="simple">
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Const</span></code></p></li>
<li><p><code class="xref py py-func docutils literal notranslate"><span class="pre">Cat()</span></code></p></li>
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Slice</span></code></p></li>
</ul>
<p>This list will be expanded in the future.</p>
</div>
</section>
<section id="signals">
<span id="lang-signals"></span><h2>Signals<a class="headerlink" href="#signals" title="Permalink to this heading"></a></h2>
<p>A <em>signal</em> is a value representing a (potentially) varying number. Signals can be <a class="reference external" href="#lang-assigns"><em>assigned</em></a> in a <a class="reference internal" href="#lang-comb"><span class="std std-ref">combinational</span></a> or <a class="reference internal" href="#lang-sync"><span class="std std-ref">synchronous</span></a> domain, in which case they are generated as wires or registers, respectively. Signals always have a well-defined value; they cannot be uninitialized or undefined.</p>
<section id="signal-shapes">
<h3>Signal shapes<a class="headerlink" href="#signal-shapes" title="Permalink to this heading"></a></h3>
<p>A signal can be created with an explicitly specified shape (any <a class="reference internal" href="#lang-shapelike"><span class="std std-ref">shape-like</span></a> object); if omitted, the shape defaults to <a class="reference internal" href="reference.html#amaranth.hdl.unsigned" title="amaranth.hdl.unsigned"><code class="xref py py-func docutils literal notranslate"><span class="pre">unsigned(1)</span></code></a>. Although rarely useful, 0-bit signals are permitted.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Signal</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
<span class="go">unsigned(1)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Signal</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
<span class="go">unsigned(4)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Signal</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
<span class="go">signed(4)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Signal</span><span class="p">(</span><span class="n">Direction</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
<span class="go">unsigned(2)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Signal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
<span class="go">unsigned(0)</span>
</pre></div>
</div>
</section>
<section id="signal-names">
<span id="lang-signalname"></span><h3>Signal names<a class="headerlink" href="#signal-names" title="Permalink to this heading"></a></h3>
<p>Each signal has a <em>name</em>, which is used in the waveform viewer, diagnostic messages, Verilog output, and so on. In most cases, the name is omitted and inferred from the name of the variable or attribute the signal is placed into:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">foo</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">foo</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;foo&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="bp">self</span><span class="o">.</span><span class="n">bar</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="bp">self</span><span class="o">.</span><span class="n">bar</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;bar&#39;</span>
</pre></div>
</div>
<p>However, the name can also be specified explicitly with the <code class="docutils literal notranslate"><span class="pre">name=</span></code> parameter:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">foo2</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;second_foo&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">foo2</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;second_foo&#39;</span>
</pre></div>
</div>
<p>The names do not need to be unique; if two signals with the same name end up in the same namespace while preparing for simulation or synthesis, one of them will be renamed to remove the ambiguity.</p>
</section>
<section id="initial-signal-values">
<span id="lang-initial"></span><h3>Initial signal values<a class="headerlink" href="#initial-signal-values" title="Permalink to this heading"></a></h3>
<p>Each signal has an <em>initial value</em>, specified with the <code class="docutils literal notranslate"><span class="pre">init=</span></code> parameter. If the initial value is not specified explicitly, zero is used by default. An initial value can be specified with an integer or an enumeration member.</p>
<p>Signals <a class="reference internal" href="#lang-assigns"><span class="std std-ref">assigned</span></a> in a <a class="reference internal" href="#lang-comb"><span class="std std-ref">combinational</span></a> domain assume their initial value when none of the assignments are <a class="reference internal" href="#lang-active"><span class="std std-ref">active</span></a>. Signals assigned in a <a class="reference internal" href="#lang-sync"><span class="std std-ref">synchronous</span></a> domain assume their initial value after <em>power-on reset</em> and, unless the signal is <a class="reference internal" href="#lang-resetless"><span class="std std-ref">reset-less</span></a>, <em>explicit reset</em>. Signals that are used but never assigned are equivalent to constants of their initial value.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Signal</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">init</span>
<span class="go">0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Signal</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">init</span>
<span class="go">5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Signal</span><span class="p">(</span><span class="n">Direction</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">Direction</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span><span class="o">.</span><span class="n">init</span>
<span class="go">1</span>
</pre></div>
</div>
</section>
<section id="reset-less-signals">
<span id="lang-resetless"></span><h3>Reset-less signals<a class="headerlink" href="#reset-less-signals" title="Permalink to this heading"></a></h3>
<p>Signals assigned in a <a class="reference internal" href="#lang-sync"><span class="std std-ref">synchronous</span></a> domain can be <em>resettable</em> or <em>reset-less</em>, specified with the <code class="docutils literal notranslate"><span class="pre">reset_less=</span></code> parameter. If the parameter is not specified, signals are resettable by default. Resettable signals assume their <a class="reference internal" href="#lang-initial"><span class="std std-ref">initial value</span></a> on explicit reset, which can be asserted via the <a class="reference internal" href="#lang-clockdomains"><span class="std std-ref">clock domain</span></a> or by <a class="reference internal" href="#lang-controlinserter"><span class="std std-ref">modifying control flow</span></a> with <code class="xref py py-class docutils literal notranslate"><span class="pre">ResetInserter</span></code>. Reset-less signals are not affected by explicit reset.</p>
<p>Signals assigned in a <a class="reference internal" href="#lang-comb"><span class="std std-ref">combinational</span></a> domain are not affected by the <code class="docutils literal notranslate"><span class="pre">reset_less</span></code> parameter.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Signal</span><span class="p">()</span><span class="o">.</span><span class="n">reset_less</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Signal</span><span class="p">(</span><span class="n">reset_less</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_less</span>
<span class="go">True</span>
</pre></div>
</div>
</section>
</section>
<section id="operators">
<span id="lang-operators"></span><h2>Operators<a class="headerlink" href="#operators" title="Permalink to this heading"></a></h2>
<p>To describe computations, Amaranth values can be combined with each other or with <a class="reference internal" href="#lang-valuelike"><span class="std std-ref">value-like</span></a> objects using a rich set of arithmetic, bitwise, logical, bit sequence, and other <em>operators</em> to form <em>expressions</em>, which are themselves values.</p>
<section id="performing-or-describing-computations">
<span id="lang-abstractexpr"></span><h3>Performing or describing computations?<a class="headerlink" href="#performing-or-describing-computations" title="Permalink to this heading"></a></h3>
<p>Code written in the Python language <em>performs</em> computations on concrete objects, like integers, with the goal of calculating a concrete result:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="mi">5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span>
<span class="go">6</span>
</pre></div>
</div>
<p>In contrast, code written in the Amaranth language <em>describes</em> computations on abstract objects, like <a class="reference internal" href="#lang-signals"><span class="std std-ref">signals</span></a>, with the goal of generating a hardware <em>circuit</em> that can be simulated, synthesized, and so on. Amaranth expressions are ordinary Python objects that represent parts of this circuit:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span>
<span class="go">(+ (sig a) (const 1&#39;d1))</span>
</pre></div>
</div>
<p>Although the syntax is similar, it is important to remember that Amaranth values exist on a higher level of abstraction than Python values. For example, expressions that include Amaranth values cannot be used in Python control flow structures:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Zero!&quot;</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="w">  </span><span class="c">...</span>
<span class="gr">TypeError</span>: <span class="n">Attempted to convert Amaranth value to Python boolean</span>
</pre></div>
</div>
<p>Because the value of <code class="docutils literal notranslate"><span class="pre">a</span></code>, and therefore <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">==</span> <span class="pre">0</span></code>, is not known at the time when the <code class="docutils literal notranslate"><span class="pre">if</span></code> statement is executed, there is no way to decide whether the body of the statement should be executed—in fact, if the design is synthesized, by the time <code class="docutils literal notranslate"><span class="pre">a</span></code> has any concrete value, the Python program has long finished! To solve this problem, Amaranth provides its own <a class="reference internal" href="#lang-control"><span class="std std-ref">control flow syntax</span></a> that, also, manipulates circuits.</p>
</section>
<section id="width-extension">
<span id="lang-widthext"></span><h3>Width extension<a class="headerlink" href="#width-extension" title="Permalink to this heading"></a></h3>
<p>Many of the operations described below (for example, addition, equality, bitwise OR, and part select) extend the width of one or both operands to match the width of the expression. When this happens, unsigned values are always zero-extended and signed values are always sign-extended regardless of the operation or signedness of the result.</p>
</section>
<section id="arithmetic-operators">
<span id="lang-arithops"></span><h3>Arithmetic operators<a class="headerlink" href="#arithmetic-operators" title="Permalink to this heading"></a></h3>
<p>Most arithmetic operations on integers provided by Python can be used on Amaranth values, too.</p>
<p>Although Python integers have unlimited precision and Amaranth values are represented with a <a class="reference internal" href="#lang-values"><span class="std std-ref">finite amount of bits</span></a>, arithmetics on Amaranth values never overflows because the width of the arithmetic expression is always sufficient to represent all possible results.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span> <span class="c1"># needs to represent 1 to 256</span>
<span class="go">unsigned(9)</span>
</pre></div>
</div>
<p>Similarly, although Python integers are always signed and Amaranth values can be either <a class="reference internal" href="#lang-values"><span class="std std-ref">signed or unsigned</span></a>, if any of the operands of an Amaranth arithmetic expression is signed, the expression itself is also signed, matching the behavior of Python.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="n">unsigned</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="n">signed</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span> <span class="c1"># needs to represent -128 to 382</span>
<span class="go">signed(10)</span>
</pre></div>
</div>
<p>While arithmetic computations never result in an overflow, <a class="reference internal" href="#lang-assigns"><span class="std std-ref">assigning</span></a> their results to signals may truncate the most significant bits.</p>
<p>The following table lists the arithmetic operations provided by Amaranth:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operation</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+</span> <span class="pre">b</span></code></p></td>
<td><p>addition</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">-a</span></code></p></td>
<td><p>negation</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">-</span> <span class="pre">b</span></code></p></td>
<td><p>subtraction</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">*</span> <span class="pre">b</span></code></p></td>
<td><p>multiplication</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">//</span> <span class="pre">b</span></code></p></td>
<td><p>floor division</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">%</span> <span class="pre">b</span></code></p></td>
<td><p>modulo</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">abs(a)</span></code></p></td>
<td><p>absolute value</p></td>
</tr>
</tbody>
</table>
</section>
<section id="comparison-operators">
<span id="lang-cmpops"></span><h3>Comparison operators<a class="headerlink" href="#comparison-operators" title="Permalink to this heading"></a></h3>
<p>All comparison operations on integers provided by Python can be used on Amaranth values. However, due to a limitation of Python, chained comparisons (e.g. <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">&lt;</span> <span class="pre">b</span> <span class="pre">&lt;</span> <span class="pre">c</span></code>) cannot be used.</p>
<p>Similar to arithmetic operations, if any operand of a comparison expression is signed, a signed comparison is performed. The result of a comparison is a 1-bit unsigned value.</p>
<p>The following table lists the comparison operations provided by Amaranth:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operation</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">==</span> <span class="pre">b</span></code></p></td>
<td><p>equality</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">!=</span> <span class="pre">b</span></code></p></td>
<td><p>inequality</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">&lt;</span> <span class="pre">b</span></code></p></td>
<td><p>less than</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">&lt;=</span> <span class="pre">b</span></code></p></td>
<td><p>less than or equal</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">&gt;</span> <span class="pre">b</span></code></p></td>
<td><p>greater than</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">&gt;=</span> <span class="pre">b</span></code></p></td>
<td><p>greater than or equal</p></td>
</tr>
</tbody>
</table>
</section>
<section id="bitwise-shift-and-rotate-operators">
<span id="lang-bitops"></span><h3>Bitwise, shift, and rotate operators<a class="headerlink" href="#bitwise-shift-and-rotate-operators" title="Permalink to this heading"></a></h3>
<p>All bitwise and shift operations on integers provided by Python can be used on Amaranth values as well.</p>
<p>Similar to arithmetic operations, if any operand of a bitwise expression is signed, the expression itself is signed as well. A shift expression is signed if the shifted value is signed. A rotate expression is always unsigned.</p>
<p>Rotate operations with variable rotate amounts cannot be efficiently synthesized for non-power-of-2 widths of the rotated value. Because of that, the rotate operations are only provided for constant rotate amounts, specified as Python <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>s.</p>
<p>The following table lists the bitwise and shift operations provided by Amaranth:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operation</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">~a</span></code></p></td>
<td><p>bitwise NOT; complement</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">&amp;</span> <span class="pre">b</span></code></p></td>
<td><p>bitwise AND</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">|</span> <span class="pre">b</span></code></p></td>
<td><p>bitwise OR</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">^</span> <span class="pre">b</span></code></p></td>
<td><p>bitwise XOR</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">&gt;&gt;</span> <span class="pre">b</span></code></p></td>
<td><p>arithmetic right shift by variable amount</p></td>
<td><p><a class="footnote-reference brackets" href="#opb1" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>, <a class="footnote-reference brackets" href="#opb2" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">&lt;&lt;</span> <span class="pre">b</span></code></p></td>
<td><p>left shift by variable amount</p></td>
<td><p><a class="footnote-reference brackets" href="#opb2" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">a.rotate_left(i)</span></code></p></td>
<td><p>left rotate by constant amount</p></td>
<td><p><a class="footnote-reference brackets" href="#opb3" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">a.rotate_right(i)</span></code></p></td>
<td><p>right rotate by constant amount</p></td>
<td><p><a class="footnote-reference brackets" href="#opb3" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">a.shift_left(i)</span></code></p></td>
<td><p>left shift by constant amount</p></td>
<td><p><a class="footnote-reference brackets" href="#opb3" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">a.shift_right(i)</span></code></p></td>
<td><p>right shift by constant amount</p></td>
<td><p><a class="footnote-reference brackets" href="#opb3" id="id7" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a></p></td>
</tr>
</tbody>
</table>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="opb1" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>Logical and arithmetic right shift of an unsigned value are equivalent. Logical right shift of a signed value can be expressed by <a class="reference internal" href="#lang-convops"><span class="std std-ref">converting it to unsigned</span></a> first.</p>
</aside>
<aside class="footnote brackets" id="opb2" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id2">1</a>,<a role="doc-backlink" href="#id3">2</a>)</span>
<p>Shift amount must be unsigned; integer shifts in Python require the amount to be positive.</p>
</aside>
<aside class="footnote brackets" id="opb3" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id4">1</a>,<a role="doc-backlink" href="#id5">2</a>,<a role="doc-backlink" href="#id6">3</a>,<a role="doc-backlink" href="#id7">4</a>)</span>
<p>Shift and rotate amounts can be negative, in which case the direction is reversed.</p>
</aside>
</aside>
<div class="admonition note" id="lang-hugeshift">
<p class="admonition-title">Note</p>
<p>Because Amaranth ensures that the width of a variable left shift expression is wide enough to represent any possible result, variable left shift by a wide amount produces exponentially wider intermediate values, stressing the synthesis tools:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">C</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
<span class="go">unsigned(4294967296)</span>
</pre></div>
</div>
<p>Although Amaranth will detect and reject expressions wide enough to break other tools, it is a good practice to explicitly limit the width of a shift amount in a variable left shift.</p>
</div>
</section>
<section id="reduction-operators">
<span id="lang-bool"></span><span id="lang-reduceops"></span><h3>Reduction operators<a class="headerlink" href="#reduction-operators" title="Permalink to this heading"></a></h3>
<p>Bitwise reduction operations on integers are not provided by Python, but are very useful for hardware. They are similar to bitwise operations applied “sideways”; for example, if bitwise AND is a binary operator that applies AND to each pair of bits between its two operands, then reduction AND is an unary operator that applies AND to all of the bits in its sole operand.</p>
<p>The result of a reduction is a 1-bit unsigned value.</p>
<p>The following table lists the reduction operations provided by Amaranth:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operation</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">a.all()</span></code></p></td>
<td><p>reduction AND; are all bits set?</p></td>
<td><p><a class="footnote-reference brackets" href="#opr1" id="id8" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">a.any()</span></code></p></td>
<td><p>reduction OR; is any bit set?</p></td>
<td><p><a class="footnote-reference brackets" href="#opr1" id="id9" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a> <a class="footnote-reference brackets" href="#opr3" id="id10" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">a.xor()</span></code></p></td>
<td><p>reduction XOR; is an odd number of bits set?</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">a.bool()</span></code></p></td>
<td><p>conversion to boolean; is non-zero?</p></td>
<td><p><a class="footnote-reference brackets" href="#opr2" id="id11" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a> <a class="footnote-reference brackets" href="#opr3" id="id12" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a></p></td>
</tr>
</tbody>
</table>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="opr1" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id8">1</a>,<a role="doc-backlink" href="#id9">2</a>)</span>
<p>Conceptually the same as applying the Python <a class="reference external" href="https://docs.python.org/3/library/functions.html#all" title="(in Python v3.12)"><code class="xref py py-func docutils literal notranslate"><span class="pre">all()</span></code></a> or <a class="reference external" href="https://docs.python.org/3/library/functions.html#any" title="(in Python v3.12)"><code class="xref py py-func docutils literal notranslate"><span class="pre">any()</span></code></a> function to the value viewed as a collection of bits.</p>
</aside>
<aside class="footnote brackets" id="opr2" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id11">5</a><span class="fn-bracket">]</span></span>
<p>Conceptually the same as applying the Python <a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">bool</span></code></a> function to the value viewed as an integer.</p>
</aside>
<aside class="footnote brackets" id="opr3" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id10">1</a>,<a role="doc-backlink" href="#id12">2</a>)</span>
<p>While the <a class="reference internal" href="reference.html#amaranth.hdl.Value.any" title="amaranth.hdl.Value.any"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Value.any()</span></code></a> and <a class="reference internal" href="reference.html#amaranth.hdl.Value.bool" title="amaranth.hdl.Value.bool"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Value.bool()</span></code></a>  operators return the same value, the use of <code class="docutils literal notranslate"><span class="pre">a.any()</span></code> implies that <code class="docutils literal notranslate"><span class="pre">a</span></code> is semantically a bit sequence, and the use of <code class="docutils literal notranslate"><span class="pre">a.bool()</span></code> implies that <code class="docutils literal notranslate"><span class="pre">a</span></code> is semantically a number.</p>
</aside>
</aside>
</section>
<section id="logical-operators">
<span id="lang-logicops"></span><h3>Logical operators<a class="headerlink" href="#logical-operators" title="Permalink to this heading"></a></h3>
<p>Unlike the arithmetic or bitwise operators, it is not possible to change the behavior of the Python logical operators <code class="docutils literal notranslate"><span class="pre">not</span></code>, <code class="docutils literal notranslate"><span class="pre">and</span></code>, and <code class="docutils literal notranslate"><span class="pre">or</span></code>. Due to that, logical expressions in Amaranth are written using bitwise operations on boolean (1-bit unsigned) values, with explicit boolean conversions added where necessary.</p>
<p>The following table lists the Python logical expressions and their Amaranth equivalents:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Python expression</p></th>
<th class="head"><p>Amaranth expression (any operands)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">a</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">~(a).bool()</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">and</span> <span class="pre">b</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(a).bool()</span> <span class="pre">&amp;</span> <span class="pre">(b).bool()</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">or</span> <span class="pre">b</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(a).bool()</span> <span class="pre">|</span> <span class="pre">(b).bool()</span></code></p></td>
</tr>
</tbody>
</table>
<p>When the operands are known to be boolean values, such as comparisons, reductions, or boolean signals, the <code class="docutils literal notranslate"><span class="pre">.bool()</span></code> conversion may be omitted for clarity:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Python expression</p></th>
<th class="head"><p>Amaranth expression (boolean operands)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">p</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">~(p)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">p</span> <span class="pre">and</span> <span class="pre">q</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(p)</span> <span class="pre">&amp;</span> <span class="pre">(q)</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">p</span> <span class="pre">or</span> <span class="pre">q</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(p)</span> <span class="pre">|</span> <span class="pre">(q)</span></code></p></td>
</tr>
</tbody>
</table>
<div class="admonition warning" id="lang-logicprecedence">
<p class="admonition-title">Warning</p>
<p>Because of Python <a class="reference external" href="https://docs.python.org/3/reference/expressions.html#operator-summary" title="(in Python v3.12)"><span class="xref std std-ref">operator precedence</span></a>, logical operators bind less tightly than comparison operators whereas bitwise operators bind more tightly than comparison operators. As a result, all logical expressions in Amaranth <strong>must</strong> have parenthesized operands.</p>
<p>Omitting parentheses around operands in an Amaranth a logical expression is likely to introduce a subtle bug:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">en</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">addr</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">en</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># correct</span>
<span class="go">(&amp; (sig en) (== (sig addr) (const 1&#39;d0)))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">en</span> <span class="o">&amp;</span> <span class="n">addr</span> <span class="o">==</span> <span class="mi">0</span> <span class="c1"># WRONG! addr is truncated to 1 bit</span>
<span class="go">(== (&amp; (sig en) (sig addr)) (const 1&#39;d0))</span>
</pre></div>
</div>
</div>
<div class="admonition warning" id="lang-negatebool">
<p class="admonition-title">Warning</p>
<p>When applied to Amaranth boolean values, the <code class="docutils literal notranslate"><span class="pre">~</span></code> operator computes negation, and when applied to Python boolean values, the <code class="docutils literal notranslate"><span class="pre">not</span></code> operator also computes negation. However, the <code class="docutils literal notranslate"><span class="pre">~</span></code> operator applied to Python boolean values produces an unexpected result:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="o">~</span><span class="kc">False</span>
<span class="go">-1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="o">~</span><span class="kc">True</span>
<span class="go">-2</span>
</pre></div>
</div>
<p>Because of this, Python booleans used in Amaranth logical expressions <strong>must</strong> be negated with the <code class="docutils literal notranslate"><span class="pre">not</span></code> operator, not the <code class="docutils literal notranslate"><span class="pre">~</span></code> operator. Negating a Python boolean with the <code class="docutils literal notranslate"><span class="pre">~</span></code> operator in an Amaranth logical expression is likely to introduce a subtle bug:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stb</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">use_stb</span> <span class="o">=</span> <span class="kc">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="ow">not</span> <span class="n">use_stb</span><span class="p">)</span> <span class="o">|</span> <span class="n">stb</span> <span class="c1"># correct</span>
<span class="go">(| (const 1&#39;d0) (sig stb))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="o">~</span><span class="n">use_stb</span> <span class="o">|</span> <span class="n">stb</span> <span class="c1"># WRONG! MSB of 2-bit wide OR expression is always 1</span>
<span class="go">(| (const 2&#39;sd-2) (sig stb))</span>
</pre></div>
</div>
<p>Amaranth automatically detects some cases of misuse of <code class="docutils literal notranslate"><span class="pre">~</span></code> and emits a detailed diagnostic message.</p>
</div>
</section>
<section id="bit-sequence-operators">
<span id="lang-seqops"></span><h3>Bit sequence operators<a class="headerlink" href="#bit-sequence-operators" title="Permalink to this heading"></a></h3>
<p>Apart from acting as numbers, Amaranth values can also be treated as bit <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#typesseq" title="(in Python v3.12)"><span class="xref std std-ref">sequences</span></a>, supporting slicing, concatenation, replication, and other sequence operations. Since some of the operators Python defines for sequences clash with the operators it defines for numbers, Amaranth gives these operators a different name. Except for the names, Amaranth values follow Python sequence semantics, with the least significant bit at index 0.</p>
<p>Because every Amaranth value has a single fixed width, bit slicing and replication operations require the subscripts and count to be constant, specified as Python <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>s. It is often useful to slice a value with a constant width and variable offset, but this cannot be expressed with the Python slice notation. To solve this problem, Amaranth provides additional <em>part select</em> operations with the necessary semantics.</p>
<p>The result of any bit sequence operation is an unsigned value.</p>
<p>The following table lists the bit sequence operations provided by Amaranth:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operation</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="code highlight py python docutils literal highlight-python"><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span></code></p></td>
<td><p>bit length; value width</p></td>
<td><p><a class="footnote-reference brackets" href="#ops1" id="id13" role="doc-noteref"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-odd"><td><p><code class="code highlight py python docutils literal highlight-python"><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">:</span><span class="n">k</span><span class="p">]</span></code></p></td>
<td><p>bit slicing by constant subscripts</p></td>
<td><p><a class="footnote-reference brackets" href="#ops2" id="id14" role="doc-noteref"><span class="fn-bracket">[</span>8<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-even"><td><p><code class="code highlight py python docutils literal highlight-python"><span class="nb">iter</span><span class="p">(</span><span class="n">a</span><span class="p">)</span></code></p></td>
<td><p>bit iteration</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="code highlight py python docutils literal highlight-python"><span class="n">a</span><span class="o">.</span><span class="n">bit_select</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span></code></p></td>
<td><p>overlapping part select with variable offset</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><code class="code highlight py python docutils literal highlight-python"><span class="n">a</span><span class="o">.</span><span class="n">word_select</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span></code></p></td>
<td><p>non-overlapping part select with variable offset</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="code highlight py python docutils literal highlight-python"><span class="n">Cat</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span></code></p></td>
<td><p>concatenation</p></td>
<td><p><a class="footnote-reference brackets" href="#ops3" id="id15" role="doc-noteref"><span class="fn-bracket">[</span>9<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-even"><td><p><code class="code highlight py python docutils literal highlight-python"><span class="n">a</span><span class="o">.</span><span class="n">replicate</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></code></p></td>
<td><p>replication</p></td>
<td></td>
</tr>
</tbody>
</table>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="ops1" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id13">7</a><span class="fn-bracket">]</span></span>
<p>Words “length” and “width” have the same meaning when talking about Amaranth values. Conventionally, “width” is used.</p>
</aside>
<aside class="footnote brackets" id="ops2" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id14">8</a><span class="fn-bracket">]</span></span>
<p>All variations of the Python slice notation are supported, including “extended slicing”. E.g. all of <code class="code highlight py python docutils literal highlight-python"><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></code>, <code class="code highlight py python docutils literal highlight-python"><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span></code>, <code class="code highlight py python docutils literal highlight-python"><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span></code>, <code class="code highlight py python docutils literal highlight-python"><span class="n">a</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span></code>, <code class="code highlight py python docutils literal highlight-python"><span class="n">a</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></code>, <code class="code highlight py python docutils literal highlight-python"><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span></code> select bits in the same way as other Python sequence types select their elements.</p>
</aside>
<aside class="footnote brackets" id="ops3" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id15">9</a><span class="fn-bracket">]</span></span>
<p>In the concatenated value, <code class="code highlight py python docutils literal highlight-python"><span class="n">a</span></code> occupies the least significant bits, and <code class="code highlight py python docutils literal highlight-python"><span class="n">b</span></code> the most significant bits. Any number of arguments (zero, one, two, or more) are supported.</p>
</aside>
</aside>
<p>For the operators introduced by Amaranth, the following table explains them in terms of Python code operating on tuples of bits rather than Amaranth values:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Amaranth operation</p></th>
<th class="head"><p>Equivalent Python code</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Cat(a,</span> <span class="pre">b)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+</span> <span class="pre">b</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">a.replicate(n)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">*</span> <span class="pre">n</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">a.bit_select(b,</span> <span class="pre">w)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">a[b:b+w]</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">a.word_select(b,</span> <span class="pre">w)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">a[b*w:b*w+w]</span></code></p></td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>In Python, the digits of a number are written right-to-left (0th exponent at the right), and the elements of a sequence are written left-to-right (0th element at the left). This mismatch can cause confusion when numeric operations (like shifts) are mixed with bit sequence operations (like concatenations). For example, <code class="docutils literal notranslate"><span class="pre">Cat(C(0b1001),</span> <span class="pre">C(0b1010))</span></code> has the same value as <code class="docutils literal notranslate"><span class="pre">C(0b1010_1001)</span></code>, <code class="docutils literal notranslate"><span class="pre">val[4:]</span></code> is equivalent to <code class="docutils literal notranslate"><span class="pre">val</span> <span class="pre">&gt;&gt;</span> <span class="pre">4</span></code>, and <code class="docutils literal notranslate"><span class="pre">val[-1]</span></code> refers to the most significant bit.</p>
<p>Such confusion can often be avoided by not using numeric and bit sequence operations in the same expression. For example, although it may seem natural to describe a shift register with a numeric shift and a sequence slice operations, using sequence operations alone would make it easier to understand.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Could Amaranth have used a different indexing or iteration order for values? Yes, but it would be necessary to either place the most significant bit at index 0, or deliberately break the Python sequence type interface. Both of these options would cause more issues than using different iteration orders for numeric and sequence operations.</p>
</div>
</section>
<section id="match-operator">
<span id="lang-matchop"></span><h3>Match operator<a class="headerlink" href="#match-operator" title="Permalink to this heading"></a></h3>
<p>The <code class="code highlight py python docutils literal highlight-python"><span class="n">val</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="o">*</span><span class="n">patterns</span><span class="p">)</span></code> operator examines a value against a set of patterns. It evaluates to <code class="code highlight py python docutils literal highlight-python"><span class="n">Const</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></code> if the value <em>matches</em> any of the patterns, and to <code class="code highlight py python docutils literal highlight-python"><span class="n">Const</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></code> otherwise. What it means for a value to match a pattern depends on the type of the pattern.</p>
<p>If the pattern is a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code></a>, it is treated as a bit mask with “don’t care” bits. After removing whitespace, each character of the pattern is compared to the corresponding bit of the value, where the leftmost character of the pattern (with the lowest index) corresponds to the most significant bit of the value. If the pattern character is <code class="docutils literal notranslate"><span class="pre">'0'</span></code> or <code class="docutils literal notranslate"><span class="pre">'1'</span></code>, the comparison succeeds if the bit equals <code class="docutils literal notranslate"><span class="pre">0</span></code> or <code class="docutils literal notranslate"><span class="pre">1</span></code> correspondingly. If the pattern character is <code class="docutils literal notranslate"><span class="pre">'-'</span></code>, the comparison always succeeds. Aside from spaces and tabs, which are ignored, no other characters are accepted.</p>
<p>Otherwise, the pattern is <a class="reference internal" href="#lang-constcasting"><span class="std std-ref">cast to a constant</span></a> and compared to <code class="code highlight py python docutils literal highlight-python"><span class="n">val</span></code> using the <a class="reference internal" href="#lang-cmpops"><span class="std std-ref">equality operator</span></a>.</p>
<p>For example, given a 8-bit value <code class="code highlight py python docutils literal highlight-python"><span class="n">val</span></code>, <code class="code highlight py python docutils literal highlight-python"><span class="n">val</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;---- -01-&#39;</span><span class="p">)</span></code> is equivalent to <code class="code highlight py python docutils literal highlight-python"><span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mb">0b0000_0110</span><span class="p">)</span> <span class="o">==</span> <span class="mb">0b0000_0010</span><span class="p">)</span></code>. Bit patterns in this operator are treated similarly to <a class="reference internal" href="#lang-bitops"><span class="std std-ref">bit sequence operators</span></a>.</p>
<p>The <a class="reference internal" href="#lang-switch"><span class="std std-ref">Case</span></a> control flow block accepts the same patterns, with the same meaning, as the match operator.</p>
</section>
<section id="conversion-operators">
<span id="lang-convops"></span><h3>Conversion operators<a class="headerlink" href="#conversion-operators" title="Permalink to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.as_signed()</span></code> and <code class="docutils literal notranslate"><span class="pre">.as_unsigned()</span></code> conversion operators reinterpret the bits of a value with the requested signedness. This is useful when the same value is sometimes treated as signed and sometimes as unsigned, or when a signed value is constructed using slices or concatenations.</p>
<p>For example, <code class="docutils literal notranslate"><span class="pre">(pc</span> <span class="pre">+</span> <span class="pre">imm[:7].as_signed()).as_unsigned()</span></code> sign-extends the 7 least significant bits of <code class="docutils literal notranslate"><span class="pre">imm</span></code> to the width of <code class="docutils literal notranslate"><span class="pre">pc</span></code>, performs the addition, and produces an unsigned result.</p>
</section>
<section id="choice-operator">
<span id="lang-muxop"></span><h3>Choice operator<a class="headerlink" href="#choice-operator" title="Permalink to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Mux(sel,</span> <span class="pre">val1,</span> <span class="pre">val0)</span></code> choice expression (similar to the <a class="reference external" href="https://docs.python.org/3/reference/expressions.html#if-expr" title="(in Python v3.12)"><span class="xref std std-ref">conditional expression</span></a> in Python) is equal to the operand <code class="docutils literal notranslate"><span class="pre">val1</span></code> if <code class="docutils literal notranslate"><span class="pre">sel</span></code> is non-zero, and to the other operand <code class="docutils literal notranslate"><span class="pre">val0</span></code> otherwise. If any of <code class="docutils literal notranslate"><span class="pre">val1</span></code> or <code class="docutils literal notranslate"><span class="pre">val0</span></code> are signed, the expression itself is signed as well.</p>
</section>
</section>
<section id="arrays">
<span id="lang-array"></span><h2>Arrays<a class="headerlink" href="#arrays" title="Permalink to this heading"></a></h2>
<p>An <em>array</em> is a mutable collection that can be indexed not only with an <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a> or with a <a class="reference internal" href="#lang-valuelike"><span class="std std-ref">value-like</span></a> object. When indexed with an <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>, it behaves like a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">list</span></code></a>. When indexed with a value-like object, it returns a proxy object containing the elements of the array that has three useful properties:</p>
<ul class="simple">
<li><p>The result of accessing an attribute of the proxy object or indexing it is another proxy object that contains the elements transformed in the same way.</p></li>
<li><p>When the proxy object is <a class="reference internal" href="#lang-valuelike"><span class="std std-ref">cast to a value</span></a>, all of its elements are also cast to a value, and an element is selected using the index originally used with the array.</p></li>
<li><p>The proxy object can be used both in an expression and <a class="reference internal" href="#lang-assigns"><span class="std std-ref">as the target of an assignment</span></a>.</p></li>
</ul>
<p>Crucially, this means that any Python object can be added to an array; the only requirement is that the final result of any computation involving it is a value-like object. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pixels</span> <span class="o">=</span> <span class="n">Array</span><span class="p">([</span>
    <span class="p">{</span><span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="mi">180</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">:</span> <span class="mi">92</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">230</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="mi">74</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">:</span> <span class="mi">130</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="mi">115</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">:</span> <span class="mi">58</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">31</span><span class="p">},</span>
<span class="p">])</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">index</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pixels</span><span class="p">)))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pixels</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;r&quot;</span><span class="p">]</span>
<span class="go">(proxy (array [180, 74, 115]) (sig index))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>An array becomes immutable after it is indexed for the first time. The elements of the array do not themselves become immutable, but it is not recommended to mutate them as the behavior can become unpredictable.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Each time an array proxy object with <code class="code highlight py python docutils literal highlight-python"><span class="n">n</span></code> elements is used in an expression, it generates a multiplexer with <code class="code highlight py python docutils literal highlight-python"><span class="n">n</span></code> branches. However, using <code class="code highlight py python docutils literal highlight-python"><span class="n">k</span></code> of such array proxy objects in an expression generates a multiplexer with <code class="code highlight py python docutils literal highlight-python"><span class="n">n</span><span class="o">**</span><span class="n">k</span></code> branches. This can generate extremely large circuits that may quickly exhaust the resources of the synthesis target or even the available RAM.</p>
</div>
</section>
<section id="data-structures">
<span id="lang-data"></span><h2>Data structures<a class="headerlink" href="#data-structures" title="Permalink to this heading"></a></h2>
<p>Amaranth provides aggregate data structures in the standard library module <a class="reference internal" href="stdlib/data.html#module-amaranth.lib.data" title="amaranth.lib.data"><code class="xref py py-mod docutils literal notranslate"><span class="pre">amaranth.lib.data</span></code></a>.</p>
</section>
<section id="modules">
<span id="lang-modules"></span><h2>Modules<a class="headerlink" href="#modules" title="Permalink to this heading"></a></h2>
<p>A <em>module</em> is a unit of the Amaranth design hierarchy: the smallest collection of logic that can be independently simulated, synthesized, or otherwise processed. Modules associate signals with <a class="reference internal" href="#lang-domains"><span class="std std-ref">control domains</span></a>, provide <a class="reference internal" href="#lang-control"><span class="std std-ref">control flow syntax</span></a>, manage <a class="reference internal" href="#lang-clockdomains"><span class="std std-ref">clock domains</span></a>, and aggregate <a class="reference internal" href="#lang-submodules"><span class="std std-ref">submodules</span></a>.</p>
<p>Every Amaranth design starts with a fresh module:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">Module</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="control-domains">
<span id="lang-domains"></span><h2>Control domains<a class="headerlink" href="#control-domains" title="Permalink to this heading"></a></h2>
<p>A <em>control domain</em> is a named group of <a class="reference internal" href="#lang-signals"><span class="std std-ref">signals</span></a> that change their value in identical conditions.</p>
<p>All designs have a single predefined <em>combinational domain</em>, containing all signals that change immediately when any value used to compute them changes. The name <code class="docutils literal notranslate"><span class="pre">comb</span></code> is reserved for the combinational domain, and refers to the same domain in all modules.</p>
<p>A design can also have any amount of user-defined <em>synchronous domains</em>, also called <a class="reference internal" href="#lang-clockdomains"><span class="std std-ref">clock domains</span></a>, containing signals that change when a specific edge occurs on the domain’s clock signal or, for domains with asynchronous reset, on the domain’s reset signal. Most modules only use a single synchronous domain, conventionally called <code class="docutils literal notranslate"><span class="pre">sync</span></code>, but the name <code class="docutils literal notranslate"><span class="pre">sync</span></code> does not have to be used, and lacks any special meaning beyond being the default.</p>
<p>The behavior of assignments differs for signals in <a class="reference internal" href="#lang-comb"><span class="std std-ref">combinational</span></a> and <a class="reference internal" href="#lang-sync"><span class="std std-ref">synchronous</span></a> domains. Collectively, signals in synchronous domains contain the state of a design, whereas signals in the combinational domain cannot form feedback loops or hold state.</p>
<section id="assigning-to-signals">
<span id="lang-assigns"></span><h3>Assigning to signals<a class="headerlink" href="#assigning-to-signals" title="Permalink to this heading"></a></h3>
<p><em>Assignments</em> are used to change the values of signals. An assignment statement can be introduced with the <code class="docutils literal notranslate"><span class="pre">.eq(...)</span></code> syntax:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">(eq (sig s) (const 1&#39;d1))</span>
</pre></div>
</div>
<p>Similar to <a class="reference internal" href="#lang-abstractexpr"><span class="std std-ref">how Amaranth operators work</span></a>, an Amaranth assignment is an ordinary Python object used to describe a part of a circuit. An assignment does not have any effect on the signal it changes until it is added to a control domain in a module. Once added, it introduces logic into the circuit generated from that module.</p>
</section>
<section id="assignable-values">
<span id="lang-assignable"></span><h3>Assignable values<a class="headerlink" href="#assignable-values" title="Permalink to this heading"></a></h3>
<p>An assignment can affect a value that is more complex than just a signal. It is possible to assign to any combination of <a class="reference internal" href="#lang-signals"><span class="std std-ref">signals</span></a>, <a class="reference internal" href="#lang-seqops"><span class="std std-ref">bit slices</span></a>, <a class="reference internal" href="#lang-seqops"><span class="std std-ref">concatenations</span></a>, <a class="reference internal" href="#lang-seqops"><span class="std std-ref">part selects</span></a>, and <a class="reference internal" href="#lang-array"><span class="std std-ref">array proxy objects</span></a> as long as it includes no other values:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Cat</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="go">(eq (cat (sig a) (sig b)) (const 1&#39;d0))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="go">(eq (slice (sig a) 0:4) (sig b))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Cat</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">bit_select</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mb">0b11</span><span class="p">)</span>
<span class="go">(eq (part (cat (sig a) (sig a)) (sig b) 2 1) (const 2&#39;d3))</span>
</pre></div>
</div>
</section>
<section id="assignment-domains">
<span id="lang-assigndomains"></span><h3>Assignment domains<a class="headerlink" href="#assignment-domains" title="Permalink to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">m.d.&lt;domain&gt;</span> <span class="pre">+=</span> <span class="pre">...</span></code> syntax is used to add assignments to a specific control domain in a module. It can add just a single assignment, or an entire sequence of them:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">a</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="n">b</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">c</span><span class="p">),</span>
    <span class="n">c</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>If the name of a domain is not known upfront, the <code class="docutils literal notranslate"><span class="pre">m.d[&quot;&lt;domain&gt;&quot;]</span> <span class="pre">+=</span> <span class="pre">...</span></code> syntax can be used instead:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_toggle</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;sync_</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">t</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="o">~</span><span class="n">t</span><span class="p">)</span>
<span class="n">add_toggle</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p id="lang-signalgranularity">Every signal included in the target of an assignment becomes a part of the domain, or equivalently, <em>driven</em> by that domain. A signal can be either undriven or driven by exactly one domain; it is an error to add two assignments to the same signal to two different domains:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">d</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">d</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">d</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="w">  </span><span class="c">...</span>
<span class="gr">amaranth.hdl.dsl.SyntaxError</span>: <span class="n">Driver-driver conflict: trying to drive (sig d) from d.sync, but it is already driven from d.comb</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Clearly, Amaranth code that drives a single bit of a signal from two different domains does not describe a meaningful circuit. However, driving two different bits of a signal from two different domains does not inherently cause such a conflict. Would Amaranth accept the following code?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">e</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>The answer is no. While this kind of code is occasionally useful, rejecting it greatly simplifies backends, simulators, and analyzers.</p>
</div>
<p>In addition to assignments, <a class="reference internal" href="#lang-assert"><span class="std std-ref">assertions</span></a> and <a class="reference internal" href="#lang-print"><span class="std std-ref">debug prints</span></a> can be added using the same syntax.</p>
</section>
<section id="assignment-order">
<span id="lang-assignorder"></span><h3>Assignment order<a class="headerlink" href="#assignment-order" title="Permalink to this heading"></a></h3>
<p>Unlike with two different domains, adding multiple assignments to the same signal to the same domain is well-defined.</p>
<p>Assignments to different signal bits apply independently. For example, the following two snippets are equivalent:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">C</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span>
    <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">C</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span>
<span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">a</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">Cat</span><span class="p">(</span><span class="n">C</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">C</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
</pre></div>
</div>
<p>If multiple assignments change the value of the same signal bits, the assignment that is added last determines the final value. For example, the following two snippets are equivalent:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">Cat</span><span class="p">(</span><span class="n">C</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">C</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">C</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))),</span>
    <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">Cat</span><span class="p">(</span><span class="n">C</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">C</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))),</span>
    <span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">C</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
<span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">b</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">Cat</span><span class="p">(</span><span class="n">C</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">C</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">C</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
</pre></div>
</div>
<p>Multiple assignments to the same signal bits are more useful when combined with control structures, which can make some of the assignments <a class="reference internal" href="#lang-active"><span class="std std-ref">active or inactive</span></a>. If all assignments to some signal bits are <a class="reference internal" href="#lang-active"><span class="std std-ref">inactive</span></a>, their final values are determined by the signal’s domain, <a class="reference internal" href="#lang-comb"><span class="std std-ref">combinational</span></a> or <a class="reference internal" href="#lang-sync"><span class="std std-ref">synchronous</span></a>.</p>
</section>
</section>
<section id="control-flow">
<span id="lang-control"></span><h2>Control flow<a class="headerlink" href="#control-flow" title="Permalink to this heading"></a></h2>
<p>Although it is possible to write any decision tree as a combination of <a class="reference internal" href="#lang-assigns"><span class="std std-ref">assignments</span></a> and <a class="reference internal" href="#lang-muxop"><span class="std std-ref">choice expressions</span></a>, Amaranth provides <em>control flow syntax</em> tailored for this task: <a class="reference internal" href="#lang-if"><span class="std std-ref">If/Elif/Else</span></a>, <a class="reference internal" href="#lang-switch"><span class="std std-ref">Switch/Case</span></a>, and <a class="reference internal" href="#lang-fsm"><span class="std std-ref">FSM/State</span></a>. The control flow syntax uses <code class="code highlight py python docutils literal highlight-python"><span class="k">with</span></code> blocks (it is implemented using <a class="reference external" href="https://docs.python.org/3/reference/datamodel.html#context-managers" title="(in Python v3.12)"><span class="xref std std-ref">context managers</span></a>), for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">timer</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">timer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">timer</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Else</span><span class="p">():</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">timer</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">timer</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>While some Amaranth control structures are superficially similar to imperative control flow statements (such as Python’s <code class="code highlight py python docutils literal highlight-python"><span class="k">if</span></code>), their function—together with <a class="reference internal" href="#lang-abstractexpr"><span class="std std-ref">expressions</span></a> and <a class="reference internal" href="#lang-assigns"><span class="std std-ref">assignments</span></a>—is to describe circuits. The code above is equivalent to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">timer</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">timer</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">Mux</span><span class="p">(</span><span class="n">timer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">timer</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<p>Because all branches of a decision tree affect the generated circuit, all of the Python code inside Amaranth control structures is always evaluated in the order in which it appears in the program. This can be observed through Python code with side effects, such as <code class="code highlight py python docutils literal highlight-python"><span class="nb">print</span><span class="p">()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">timer</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">timer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inside `If`&quot;</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">timer</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Else</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inside `Else`&quot;</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">timer</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">timer</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>inside `If`
inside `Else`
</pre></div>
</div>
<section id="active-and-inactive-assignments">
<span id="lang-active"></span><h3>Active and inactive assignments<a class="headerlink" href="#active-and-inactive-assignments" title="Permalink to this heading"></a></h3>
<p>An assignment added inside an Amaranth control structure, i.e. <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">m.&lt;...&gt;:</span></code> block, is <em>active</em> if the condition of the control structure is satisfied, and <em>inactive</em> otherwise. For any given set of conditions, the final value of every signal assigned in a module is the same as if the inactive assignments were removed and the active assignments were performed unconditionally, taking into account the <a class="reference internal" href="#lang-assignorder"><span class="std std-ref">assignment order</span></a>.</p>
<p>For example, there are two possible cases in the circuit generated from the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">timer</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">timer</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">timer</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">timer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">timer</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">timer</span> <span class="pre">==</span> <span class="pre">0</span></code> is true, the code reduces to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">timer</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">timer</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">timer</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>Due to the <a class="reference internal" href="#lang-assignorder"><span class="std std-ref">assignment order</span></a>, it further reduces to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">timer</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">timer</span> <span class="pre">==</span> <span class="pre">0</span></code> is false, the code reduces to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">timer</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">timer</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Combining these cases together, the code above is equivalent to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">timer</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">timer</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">Mux</span><span class="p">(</span><span class="n">timer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">timer</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="if-elif-else-control-blocks">
<span id="lang-if"></span><h3><code class="code highlight py python docutils literal highlight-python"><span class="n">If</span></code>/<code class="code highlight py python docutils literal highlight-python"><span class="n">Elif</span></code>/<code class="code highlight py python docutils literal highlight-python"><span class="n">Else</span></code> control blocks<a class="headerlink" href="#if-elif-else-control-blocks" title="Permalink to this heading"></a></h3>
<p>Conditional control flow is described using a <code class="code highlight py python docutils literal highlight-python"><span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">cond1</span><span class="p">):</span></code> block, which may be followed by one or more <code class="code highlight py python docutils literal highlight-python"><span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Elif</span><span class="p">(</span><span class="n">cond2</span><span class="p">):</span></code> blocks, and optionally a final <code class="code highlight py python docutils literal highlight-python"><span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Else</span><span class="p">():</span></code> block. This structure parallels Python’s own <a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#if" title="(in Python v3.12)"><span class="xref std std-ref">if/elif/else</span></a> control flow syntax. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">x_coord</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">):</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">is_bporch</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">x_coord</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">x_coord</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Elif</span><span class="p">((</span><span class="n">x_coord</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_coord</span> <span class="o">&lt;</span> <span class="mi">364</span><span class="p">)):</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">is_active</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">x_coord</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">x_coord</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Elif</span><span class="p">((</span><span class="n">x_coord</span> <span class="o">&gt;=</span> <span class="mi">364</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_coord</span> <span class="o">&lt;</span> <span class="mi">374</span><span class="p">)):</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">is_fporch</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">x_coord</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">x_coord</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Else</span><span class="p">():</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">x_coord</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Within a single <code class="code highlight py python docutils literal highlight-python"><span class="n">If</span></code>/<code class="code highlight py python docutils literal highlight-python"><span class="n">Elif</span></code>/<code class="code highlight py python docutils literal highlight-python"><span class="n">Else</span></code> sequence of blocks, the statements within at most one block will be active at any time. This will be the first block in the order of definition whose condition, <a class="reference internal" href="#lang-bool"><span class="std std-ref">converted to boolean</span></a>, is true.</p>
<p>If an <code class="code highlight py python docutils literal highlight-python"><span class="n">Else</span></code> block is present, then the statements within exactly one block will be active at any time, and the sequence as a whole is called a <em>full condition</em>.</p>
</section>
<section id="switch-case-control-blocks">
<span id="lang-switch"></span><h3><code class="code highlight py python docutils literal highlight-python"><span class="n">Switch</span></code>/<code class="code highlight py python docutils literal highlight-python"><span class="n">Case</span></code> control blocks<a class="headerlink" href="#switch-case-control-blocks" title="Permalink to this heading"></a></h3>
<p>Case comparison, where a single value is examined against several different <em>patterns</em>, is described using a <code class="code highlight py python docutils literal highlight-python"><span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Switch</span><span class="p">(</span><span class="n">value</span><span class="p">):</span></code> block. This block can contain any amount of <code class="code highlight py python docutils literal highlight-python"><span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Case</span><span class="p">(</span><span class="o">*</span><span class="n">patterns</span><span class="p">)</span></code> and <code class="code highlight py python docutils literal highlight-python"><span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Default</span><span class="p">():</span></code> blocks. This structure parallels Python’s own <a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#match" title="(in Python v3.12)"><span class="xref std std-ref">match/case</span></a> control flow syntax. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">value</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Switch</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Case</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">is_even</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Case</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
        <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">is_odd</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Default</span><span class="p">():</span>
        <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">too_big</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Within a single <code class="code highlight py python docutils literal highlight-python"><span class="n">Switch</span></code> block, the statements within at most one block will be active at any time. This will be the first <code class="code highlight py python docutils literal highlight-python"><span class="n">Case</span></code> block in the order of definition whose pattern <a class="reference internal" href="#lang-matchop"><span class="std std-ref">matches</span></a> the value, or the first <code class="code highlight py python docutils literal highlight-python"><span class="n">Default</span></code> block, whichever is earlier.</p>
<p>If a <code class="code highlight py python docutils literal highlight-python"><span class="n">Default</span></code> block is present, or the patterns in the <code class="code highlight py python docutils literal highlight-python"><span class="n">Case</span></code> blocks cover every possible <code class="code highlight py python docutils literal highlight-python"><span class="n">Switch</span></code> value, then the statements within exactly one block will be active at any time, and the sequence as a whole is called a <em>full condition</em>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>While all Amaranth control flow syntax can be generated programmatically, the <code class="code highlight py python docutils literal highlight-python"><span class="n">Switch</span></code> control block is particularly easy to use in this way:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">length</span>  <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">squared</span> <span class="o">=</span> <span class="n">Signal</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">length</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span>

<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Switch</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span><span class="o">.</span><span class="n">width</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Case</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">squared</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="fsm-state-control-blocks">
<span id="lang-fsm"></span><h3><code class="code highlight py python docutils literal highlight-python"><span class="n">FSM</span></code>/<code class="code highlight py python docutils literal highlight-python"><span class="n">State</span></code> control blocks<a class="headerlink" href="#fsm-state-control-blocks" title="Permalink to this heading"></a></h3>
<p>Simple <a class="reference external" href="https://en.wikipedia.org/wiki/Finite-state_machine">finite state machines</a> are described using a <code class="code highlight py python docutils literal highlight-python"><span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">FSM</span><span class="p">():</span></code> block. This block can contain one or more <code class="code highlight py python docutils literal highlight-python"><span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">State</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">)</span></code> blocks. In addition to these blocks, the <code class="code highlight py python docutils literal highlight-python"><span class="n">m</span><span class="o">.</span><span class="n">next</span> <span class="o">=</span> <span class="s2">&quot;Name&quot;</span></code> syntax chooses which state the FSM enters on the next clock cycle. For example, this FSM performs a bus read transaction once after reset:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">bus_addr</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="n">r_data</span>   <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">r_en</span>     <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="n">latched</span>  <span class="o">=</span> <span class="n">Signal</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">r_data</span><span class="p">)</span>

<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">FSM</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">State</span><span class="p">(</span><span class="s2">&quot;Set Address&quot;</span><span class="p">):</span>
        <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">addr</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mh">0x1234</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">next</span> <span class="o">=</span> <span class="s2">&quot;Strobe Read Enable&quot;</span>

    <span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">State</span><span class="p">(</span><span class="s2">&quot;Strobe Read Enable&quot;</span><span class="p">):</span>
        <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">r_en</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">next</span> <span class="o">=</span> <span class="s2">&quot;Sample Data&quot;</span>

    <span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">State</span><span class="p">(</span><span class="s2">&quot;Sample Data&quot;</span><span class="p">):</span>
        <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">latched</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">r_data</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">r_data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">m</span><span class="o">.</span><span class="n">next</span> <span class="o">=</span> <span class="s2">&quot;Set Address&quot;</span> <span class="c1"># try again</span>
</pre></div>
</div>
<p>The initial (and reset) state of the FSM can be provided when defining it using the <code class="code highlight py python docutils literal highlight-python"><span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">FSM</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="s2">&quot;Name&quot;</span><span class="p">):</span></code> argument. If not provided, it is the first state in the order of definition. For example, this definition is equivalent to the one at the beginning of this section:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">FSM</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="s2">&quot;Set Address&quot;</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>The FSM belongs to a <a class="reference internal" href="#lang-domains"><span class="std std-ref">clock domain</span></a>, which is specified using the <code class="code highlight py python docutils literal highlight-python"><span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">FSM</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="s2">&quot;dom&quot;</span><span class="p">)</span></code> argument. If not specified, it is the <code class="docutils literal notranslate"><span class="pre">sync</span></code> domain. For example, this definition is equivalent to the one at the beginning of this section:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">FSM</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="s2">&quot;sync&quot;</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>To determine (from code that is outside the FSM definition) whether it is currently in a particular state, the FSM can be captured; its <code class="code highlight py python docutils literal highlight-python"><span class="o">.</span><span class="n">ongoing</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">)</span></code> method returns a value that is true whenever the FSM is in the corresponding state. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">FSM</span><span class="p">()</span> <span class="k">as</span> <span class="n">fsm</span><span class="p">:</span>
    <span class="o">...</span>

<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">fsm</span><span class="o">.</span><span class="n">ongoing</span><span class="p">(</span><span class="s2">&quot;Set Address&quot;</span><span class="p">)):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Note that in Python, assignments made using <code class="code highlight py python docutils literal highlight-python"><span class="k">with</span> <span class="n">x</span><span class="p">()</span> <span class="k">as</span> <span class="n">y</span><span class="p">:</span></code> syntax persist past the end of the block.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you make a typo in the state name provided to <code class="code highlight py python docutils literal highlight-python"><span class="n">m</span><span class="o">.</span><span class="n">next</span> <span class="o">=</span> <span class="o">...</span></code> or <code class="code highlight py python docutils literal highlight-python"><span class="n">fsm</span><span class="o">.</span><span class="n">ongoing</span><span class="p">(</span><span class="o">...</span><span class="p">)</span></code>, an empty and unreachable state with that name will be created with no diagnostic message.</p>
<p>This hazard will be eliminated in the future.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If a non-string object is provided as a state name to <code class="code highlight py python docutils literal highlight-python"><span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">State</span><span class="p">(</span><span class="o">...</span><span class="p">):</span></code>, it is cast to a string first, which may lead to surprising behavior. <code class="code highlight py python docutils literal highlight-python"><span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">State</span><span class="p">(</span><span class="o">...</span><span class="p">):</span></code> <strong>does not</strong> treat an enumeration value specially; if one is provided, it is cast to a string, and its numeric value will have no correspondence to the numeric value of the generated state signal.</p>
<p>This hazard will be eliminated in the future.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are nesting two state machines within each other, the <code class="code highlight py python docutils literal highlight-python"><span class="n">m</span><span class="o">.</span><span class="n">next</span> <span class="o">=</span> <span class="o">...</span></code> syntax always refers to the innermost one. To change the state of the outer state machine from within the inner one, use an intermediate signal.</p>
</div>
</section>
</section>
<section id="combinational-evaluation">
<span id="lang-comb"></span><h2>Combinational evaluation<a class="headerlink" href="#combinational-evaluation" title="Permalink to this heading"></a></h2>
<p>Signals in the combinational <a class="reference internal" href="#lang-domains"><span class="std std-ref">control domain</span></a> change whenever any value used to compute them changes. The final value of a combinational signal is equal to its <a class="reference internal" href="#lang-initial"><span class="std std-ref">initial value</span></a> updated by the <a class="reference internal" href="#lang-active"><span class="std std-ref">active assignments</span></a> in the <a class="reference internal" href="#lang-assignorder"><span class="std std-ref">assignment order</span></a>. Combinational signals cannot hold any state.</p>
<p>Consider the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">en</span><span class="p">):</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">a</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Whenever the signals <code class="docutils literal notranslate"><span class="pre">en</span></code> or <code class="docutils literal notranslate"><span class="pre">b</span></code> change, the signal <code class="docutils literal notranslate"><span class="pre">a</span></code> changes as well. If <code class="docutils literal notranslate"><span class="pre">en</span></code> is false, the final value of <code class="docutils literal notranslate"><span class="pre">a</span></code> is its initial value, <code class="docutils literal notranslate"><span class="pre">1</span></code>. If <code class="docutils literal notranslate"><span class="pre">en</span></code> is true, the final value of <code class="docutils literal notranslate"><span class="pre">a</span></code> is equal to <code class="docutils literal notranslate"><span class="pre">b</span> <span class="pre">+</span> <span class="pre">1</span></code>.</p>
<p>A combinational signal that is computed directly or indirectly based on its own value is a part of a <em>combinational feedback loop</em>, sometimes shortened to just <em>feedback loop</em>. Combinational feedback loops can be stable (e.g. implement a constant driver or a transparent latch), or unstable (e.g. implement a ring oscillator). Amaranth prohibits using assignments to describe any kind of a combinational feedback loop, including transparent latches.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the exceedingly rare case when a combinational feedback loop is desirable, it is possible to implement it by directly instantiating technology primitives (e.g. device-specific LUTs or latches). This is also the only way to introduce a combinational feedback loop with well-defined behavior in simulation and synthesis, regardless of the HDL being used.</p>
</div>
</section>
<section id="synchronous-evaluation">
<span id="lang-sync"></span><h2>Synchronous evaluation<a class="headerlink" href="#synchronous-evaluation" title="Permalink to this heading"></a></h2>
<p>Signals in synchronous <a class="reference internal" href="#lang-domains"><span class="std std-ref">control domains</span></a> change whenever the <em>active edge</em> (a 0-to-1 or 1-to-0 transition, configured when <a class="reference internal" href="#lang-clockdomains"><span class="std std-ref">creating the domain</span></a>) occurs on the clock of the synchronous domain. In addition, the signals in <a class="reference internal" href="#lang-clockdomains"><span class="std std-ref">clock domains</span></a> with an asynchronous reset change when such a reset is asserted. The final value of a synchronous signal is equal to its <a class="reference internal" href="#lang-initial"><span class="std std-ref">initial value</span></a> if the reset (of any type) is asserted, or to its current value updated by the <a class="reference internal" href="#lang-active"><span class="std std-ref">active assignments</span></a> in the <a class="reference internal" href="#lang-assignorder"><span class="std std-ref">assignment order</span></a> otherwise. Synchronous signals always hold state.</p>
<p>Consider the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">timer</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>

<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">up</span><span class="p">):</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">timer</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">timer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Elif</span><span class="p">(</span><span class="n">down</span><span class="p">):</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">timer</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">timer</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Whenever there is a transition on the clock of the <code class="docutils literal notranslate"><span class="pre">sync</span></code> domain, the <code class="code highlight py python docutils literal highlight-python"><span class="n">timer</span></code> signal is incremented by one if <code class="code highlight py python docutils literal highlight-python"><span class="n">up</span></code> is true, decremented by one if <code class="code highlight py python docutils literal highlight-python"><span class="n">down</span></code> is true, and retains its value otherwise.</p>
</section>
<section id="assertions">
<span id="lang-assert"></span><h2>Assertions<a class="headerlink" href="#assertions" title="Permalink to this heading"></a></h2>
<p>Some properties are so important that if they are violated, the computations described by the design become meaningless. These properties should be guarded with an <code class="xref py py-class docutils literal notranslate"><span class="pre">Assert</span></code> statement that immediately terminates the simulation if its condition is false. Assertions should generally be added to a <a class="reference internal" href="#lang-sync"><span class="std std-ref">synchronous domain</span></a>, and may have an optional message printed when it is violated:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ip</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">Assert</span><span class="p">(</span><span class="n">ip</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;instruction pointer past the end of program code!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Assertions may be nested within a <a class="reference internal" href="#lang-control"><span class="std std-ref">control block</span></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="o">~</span><span class="n">booting</span><span class="p">):</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">Assert</span><span class="p">(</span><span class="n">ip</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>While is is also possible to add assertions to the <a class="reference internal" href="#lang-comb"><span class="std std-ref">combinational domain</span></a>, simulations of combinational circuits may have <em>glitches</em>: instantaneous, transient changes in the values of expressions that are being computed which do not affect the result of the computation (and are not visible in most waveform viewers for that reason). Depending on the tools used for simulation, a glitch in the condition of an assertion or of a <a class="reference internal" href="#lang-control"><span class="std std-ref">control block</span></a> that contains it may cause the simulation to be terminated, even if the glitch would have been instantaneously resolved afterwards.</p>
<p>If the condition of an assertion is assigned in a synchronous domain, then it is safe to add that assertion in the combinational domain. For example, neither of the assertions in the example below will be violated due to glitches, regardless of which domain the <code class="code highlight py python docutils literal highlight-python"><span class="n">ip</span></code> and <code class="code highlight py python docutils literal highlight-python"><span class="n">booting</span></code> signals are driven by:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ip_sync</span> <span class="o">=</span> <span class="n">Signal</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">ip_sync</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>

<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">Assert</span><span class="p">(</span><span class="n">ip_sync</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span>
<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">booting</span><span class="p">):</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">Assert</span><span class="p">(</span><span class="n">ip_sync</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span>
</pre></div>
</div>
<p>Assertions should be added in a <a class="reference internal" href="#lang-sync"><span class="std std-ref">synchronous domain</span></a> when possible. In cases where it is not, such as if the condition is a signal that is assigned in a synchronous domain elsewhere, care should be taken while adding the assertion to the combinational domain.</p>
</div>
</section>
<section id="debug-printing">
<span id="lang-print"></span><h2>Debug printing<a class="headerlink" href="#debug-printing" title="Permalink to this heading"></a></h2>
<p>The value of any expression, or of several of them, can be printed to the terminal during simulation using the <code class="xref py py-class docutils literal notranslate"><span class="pre">Print</span></code> statement. When added to the <a class="reference internal" href="#lang-comb"><span class="std std-ref">combinational domain</span></a>, the value of an expression is printed whenever it changes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">state</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">Print</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</pre></div>
</div>
<p>When added to a <a class="reference internal" href="#lang-sync"><span class="std std-ref">synchronous domain</span></a>, the value of an expression is printed whenever the active edge occurs on the clock of that domain:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">Print</span><span class="p">(</span><span class="s2">&quot;on tick: &quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">Print</span></code> statement, regardless of the domain, may be nested within a <a class="reference internal" href="#lang-control"><span class="std std-ref">control block</span></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">old_state</span> <span class="o">=</span> <span class="n">Signal</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">old_state</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">old_state</span><span class="p">):</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">Print</span><span class="p">(</span><span class="s2">&quot;was: &quot;</span><span class="p">,</span> <span class="n">old_state</span><span class="p">,</span> <span class="s2">&quot;now: &quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</pre></div>
</div>
<p>The arguments to the <code class="xref py py-class docutils literal notranslate"><span class="pre">Print</span></code> statement have the same meaning as the arguments to the Python <a class="reference external" href="https://docs.python.org/3/library/functions.html#print" title="(in Python v3.12)"><code class="xref py py-func docutils literal notranslate"><span class="pre">print()</span></code></a> function, with the exception that only <code class="code highlight py python docutils literal highlight-python"><span class="n">sep</span></code> and <code class="code highlight py python docutils literal highlight-python"><span class="n">end</span></code> keyword arguments are supported. In addition, the <code class="xref py py-class docutils literal notranslate"><span class="pre">Format</span></code> helper can be used to apply formatting to the values, similar to the Python <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str.format" title="(in Python v3.12)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">str.format()</span></code></a> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">addr</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">Print</span><span class="p">(</span><span class="n">Format</span><span class="p">(</span><span class="s2">&quot;address: </span><span class="si">{:08x}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
</pre></div>
</div>
<p>In both <code class="xref py py-class docutils literal notranslate"><span class="pre">Print</span></code> and <code class="xref py py-class docutils literal notranslate"><span class="pre">Format</span></code>, arguments that are not Amaranth <a class="reference internal" href="#lang-values"><span class="std std-ref">values</span></a> are formatted using the usual Python rules. The optional second <code class="code highlight py python docutils literal highlight-python"><span class="n">message</span></code> argument to <code class="xref py py-class docutils literal notranslate"><span class="pre">Assert</span></code> (described <a class="reference internal" href="#lang-assert"><span class="std std-ref">above</span></a>) also accepts a string or the <code class="xref py py-class docutils literal notranslate"><span class="pre">Format</span></code> helper:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">Assert</span><span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mb">0b111</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">Format</span><span class="p">(</span><span class="s2">&quot;unaligned address </span><span class="si">{:08x}</span><span class="s2">!&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="clock-domains">
<span id="lang-clockdomains"></span><h2>Clock domains<a class="headerlink" href="#clock-domains" title="Permalink to this heading"></a></h2>
<p>A new synchronous <a class="reference internal" href="#lang-domains"><span class="std std-ref">control domain</span></a>, which is more often called a <em>clock domain</em>, can be defined in a design by creating a <code class="xref py py-class docutils literal notranslate"><span class="pre">ClockDomain</span></code> object and adding it to the <code class="code highlight py python docutils literal highlight-python"><span class="n">m</span><span class="o">.</span><span class="n">domains</span></code> collection:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">domains</span><span class="o">.</span><span class="n">video</span> <span class="o">=</span> <span class="n">cd_video</span> <span class="o">=</span> <span class="n">ClockDomain</span><span class="p">(</span><span class="n">local</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>If the name of the domain is not known upfront, another, less concise, syntax can be used instead:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_video_domain</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">cd</span> <span class="o">=</span> <span class="n">ClockDomain</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;video_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">domains</span> <span class="o">+=</span> <span class="n">cd</span>
    <span class="k">return</span> <span class="n">cd</span>

<span class="n">add_video_domain</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Whenever the created <code class="xref py py-class docutils literal notranslate"><span class="pre">ClockDomain</span></code> object is immediately assigned using the <code class="code highlight py python docutils literal highlight-python"><span class="n">domain_name</span> <span class="o">=</span> <span class="n">ClockDomain</span><span class="p">(</span><span class="o">...</span><span class="p">)</span></code> or <code class="code highlight py python docutils literal highlight-python"><span class="n">m</span><span class="o">.</span><span class="n">domains</span><span class="o">.</span><span class="n">domain_name</span> <span class="o">=</span> <span class="n">ClockDomain</span><span class="p">(</span><span class="o">...</span><span class="p">)</span></code> syntax, the name of the domain may be omitted from the <code class="code highlight py python docutils literal highlight-python"><span class="n">ClockDomain</span><span class="p">()</span></code> invocation. In other cases, it must be provided as the first argument.</p>
</div>
<p>A clock domain always has a clock signal, which can be accessed through the <code class="xref py py-attr docutils literal notranslate"><span class="pre">cd.clk</span></code> attribute. By default, the <em>active edge</em> of the clock domain is positive; this means that the signals in the domain change when the clock signal transitions from 0 to 1. A clock domain can be configured to have a negative active edge so that signals in it change when the clock signal transitions from 1 to 0:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">domains</span><span class="o">.</span><span class="n">jtag</span> <span class="o">=</span> <span class="n">ClockDomain</span><span class="p">(</span><span class="n">clk_edge</span><span class="o">=</span><span class="s2">&quot;neg&quot;</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>A clock domain also has a reset signal, which can be accessed through the <code class="xref py py-attr docutils literal notranslate"><span class="pre">cd.rst</span></code> attribute. The reset signal is always active-high: the signals in the clock domain are reset if the value of the reset signal is 1. The <a class="reference internal" href="#lang-initial"><span class="std std-ref">initial value</span></a> of this signal is 0, so if the reset signal is never assigned, the signals in the clock domain are never explicitly reset (they are still <a class="reference internal" href="#lang-initial"><span class="std std-ref">reset at power-on</span></a>). Nevertheless, if its existence is undesirable, the clock domain can be configured to omit it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">domains</span><span class="o">.</span><span class="n">startup</span> <span class="o">=</span> <span class="n">ClockDomain</span><span class="p">(</span><span class="n">reset_less</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Signals in a reset-less clock domain can still be explicitly reset using the <code class="xref py py-class docutils literal notranslate"><span class="pre">ResetInserter</span></code> <a class="reference internal" href="#lang-controlinserter"><span class="std std-ref">control flow modifier</span></a>.</p>
<p>If a clock domain is defined in a module, all of its <a class="reference internal" href="#lang-submodules"><span class="std std-ref">submodules</span></a> can refer to that domain under the same name.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Always provide the <code class="code highlight py python docutils literal highlight-python"><span class="n">local</span><span class="o">=</span><span class="kc">True</span></code> keyword argument when defining a clock domain. The behavior of clock domains defined without this keyword argument is subject to change in near future, and is intentionally left undocumented.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Clock domains use synchronous reset unless otherwise specified. Clock domains with asynchronous reset are implemented, but their behavior is subject to change in near future, and is intentionally left undocumented.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Unless you need to introduce a new asynchronous control set in the design, consider <a class="reference internal" href="#lang-controlinserter"><span class="std std-ref">using ResetInserter or EnableInserter</span></a> instead of defining a new clock domain. Designs with fewer clock domains are easier to reason about.</p>
<p>A new asynchronous control set is necessary when some signals must change on a different active edge of a clock, at a different frequency, with a different phase, or when a different asynchronous reset signal is asserted.</p>
</div>
<section id="late-binding-of-clock-and-reset-signals">
<span id="lang-latesignals"></span><h3>Late binding of clock and reset signals<a class="headerlink" href="#late-binding-of-clock-and-reset-signals" title="Permalink to this heading"></a></h3>
<p>Clock domains are <em>late bound</em>, which means that their signals and properties can be referred to using the domain’s name before the <code class="xref py py-class docutils literal notranslate"><span class="pre">ClockDomain</span></code> object with that name is created and added to the design. This happens whenever <a class="reference internal" href="#lang-assigns"><span class="std std-ref">an assignment is added</span></a> to a domain. In some cases, it is necessary to refer to the domain’s clock or reset signal using only the domain’s name. The <code class="xref py py-class docutils literal notranslate"><span class="pre">ClockSignal</span></code> and <code class="xref py py-class docutils literal notranslate"><span class="pre">ResetSignal</span></code> values make this possible:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="n">ClockSignal</span><span class="p">()</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">bus_clk</span><span class="p">),</span>
    <span class="n">ResetSignal</span><span class="p">()</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="o">~</span><span class="n">bus_rstn</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>In this example, once the design is processed, the clock signal of the clock domain <code class="docutils literal notranslate"><span class="pre">sync</span></code> found in this module or one of its containing modules will be equal to <code class="code highlight py python docutils literal highlight-python"><span class="n">bus_clk</span></code>. The reset signal of the same clock domain will be equal to the negated <code class="code highlight py python docutils literal highlight-python"><span class="n">bus_rstn</span></code>. With the <code class="docutils literal notranslate"><span class="pre">sync</span></code> domain created in the same module, these statements become equivalent to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">domains</span><span class="o">.</span><span class="n">sync</span> <span class="o">=</span> <span class="n">cd_sync</span> <span class="o">=</span> <span class="n">ClockDomain</span><span class="p">(</span><span class="n">local</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="n">cd_sync</span><span class="o">.</span><span class="n">clk</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">bus_clk</span><span class="p">),</span>
    <span class="n">cd_sync</span><span class="o">.</span><span class="n">rst</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="o">~</span><span class="n">bus_rstn</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">ClockSignal</span></code> and <code class="xref py py-class docutils literal notranslate"><span class="pre">ResetSignal</span></code> values may also be assigned to other signals and used in expressions. They take a single argument, which is the name of the domain; if not specified, it defaults to <code class="code highlight py python docutils literal highlight-python"><span class="s2">&quot;sync&quot;</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Be especially careful when using <code class="xref py py-class docutils literal notranslate"><span class="pre">ClockSignal</span></code> or <code class="xref py py-attr docutils literal notranslate"><span class="pre">cd.clk</span></code> in expressions. Assigning to and from a clock signal is usually safe; any other operations may have unpredictable results. Consult the documentation for your synthesis toolchain and platform to understand which operations with a clock signal are permitted.</p>
<p>FPGAs usually have dedicated clocking facilities that can be used to disable, divide, or multiplex clock signals. When targeting an FPGA, these facilities should be used if at all possible, and expressions like <code class="code highlight py python docutils literal highlight-python"><span class="n">ClockSignal</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">en</span></code> or <code class="code highlight py python docutils literal highlight-python"><span class="n">Mux</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">ClockSignal</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">ClockSignal</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">))</span></code> should be avoided.</p>
</div>
</section>
</section>
<section id="elaboration">
<span id="lang-elaboration"></span><h2>Elaboration<a class="headerlink" href="#elaboration" title="Permalink to this heading"></a></h2>
<p>Amaranth designs are built from a hierarchy of smaller subdivisions, which are called <em>elaboratables</em>. The process of creating a data structure representing the behavior of a complete design by composing such subdivisions together is called <em>elaboration</em>.</p>
<p>An elaboratable is any Python object that inherits from the <code class="xref py py-class docutils literal notranslate"><span class="pre">Elaboratable</span></code> base class and implements the <code class="xref py py-meth docutils literal notranslate"><span class="pre">elaborate()</span></code>  method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Counter</span><span class="p">(</span><span class="n">Elaboratable</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">elaborate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Module</span><span class="p">()</span>

        <span class="o">...</span>

        <span class="k">return</span> <span class="n">m</span>
</pre></div>
</div>
<p>The <code class="xref py py-meth docutils literal notranslate"><span class="pre">elaborate()</span></code> method must either return an instance of <code class="xref py py-class docutils literal notranslate"><span class="pre">Module</span></code> or <code class="xref py py-class docutils literal notranslate"><span class="pre">Instance</span></code> to describe the behavior of the elaboratable, or delegate it by returning another elaboratable object.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Instances of <code class="xref py py-class docutils literal notranslate"><span class="pre">Module</span></code> also implement the <code class="xref py py-meth docutils literal notranslate"><span class="pre">elaborate()</span></code> method, which returns a special object that represents a fragment of a netlist. Such an object cannot be constructed without using <code class="xref py py-class docutils literal notranslate"><span class="pre">Module</span></code>.</p>
</div>
<p>The <code class="code highlight py python docutils literal highlight-python"><span class="n">platform</span></code> argument received by the <code class="xref py py-meth docutils literal notranslate"><span class="pre">elaborate()</span></code> method can be <code class="code highlight py python docutils literal highlight-python"><span class="kc">None</span></code>, an instance of <a class="reference internal" href="platform.html#platform"><span class="std std-ref">a built-in platform</span></a>, or a custom object. It is used for <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">dependency injection</a> and to contain the state of a design while it is being elaborated.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <code class="xref py py-meth docutils literal notranslate"><span class="pre">elaborate()</span></code> method should not modify the <code class="docutils literal notranslate"><span class="pre">self</span></code> object it receives other than for debugging and experimentation. Elaborating the same design twice with two identical platform objects should produce two identical netlists. If the design needs to be modified after construction, this should happen before elaboration.</p>
<p>It is not possible to ensure that a design which modifies itself during elaboration is correctly converted to a netlist because the relative order in which the <code class="xref py py-meth docutils literal notranslate"><span class="pre">elaborate()</span></code> methods are called within a single design is not guaranteed.</p>
</div>
<p>The Amaranth standard library provides <em>components</em>: elaboratable objects that also include a description of their interface. Unless otherwise necessary, an elaboratable should inherit from <a class="reference internal" href="stdlib/wiring.html#amaranth.lib.wiring.Component" title="amaranth.lib.wiring.Component"><code class="xref py py-class docutils literal notranslate"><span class="pre">amaranth.lib.wiring.Component</span></code></a> rather than plain <code class="xref py py-class docutils literal notranslate"><span class="pre">Elaboratable</span></code>. See the <a class="reference internal" href="stdlib/wiring.html#wiring-introduction"><span class="std std-ref">introduction to interfaces and components</span></a> for details.</p>
<section id="submodules">
<span id="lang-submodules"></span><h3>Submodules<a class="headerlink" href="#submodules" title="Permalink to this heading"></a></h3>
<p>An elaboratable can be included within another elaboratable, which is called its <em>containing elaboratable</em>, by adding it as a submodule:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">submodules</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
</pre></div>
</div>
<p>If the name of a submodule is not known upfront, a different syntax should be used:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">m</span><span class="o">.</span><span class="n">submodules</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;counter_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
</pre></div>
</div>
<p>A submodule can also be added without specifying a name:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
<span class="n">m</span><span class="o">.</span><span class="n">submodules</span> <span class="o">+=</span> <span class="n">counter</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If a name is not explicitly specified for a submodule, one will be generated and assigned automatically. Designs with many autogenerated names can be difficult to debug, so a name should usually be supplied.</p>
</div>
<p>A non-Amaranth design unit can be added as a submodule using an <a class="reference internal" href="#lang-instance"><span class="std std-ref">instance</span></a>.</p>
</section>
<section id="modifying-control-flow">
<span id="lang-controlinserter"></span><h3>Modifying control flow<a class="headerlink" href="#modifying-control-flow" title="Permalink to this heading"></a></h3>
<p>Control flow within an elaboratable can be altered without introducing a new clock domain by using <em>control flow modifiers</em> that affect <a class="reference internal" href="#lang-sync"><span class="std std-ref">synchronous evaluation</span></a> of signals in a specified domain (or domains). They never affect <a class="reference internal" href="#lang-comb"><span class="std std-ref">combinational evaluation</span></a>. There are two control flow modifiers:</p>
<ul class="simple">
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">ResetInserter</span></code> introduces a synchronous reset input (or inputs), updating all of the signals in the specified domains to their <a class="reference internal" href="#lang-initial"><span class="std std-ref">initial value</span></a> whenever the active edge occurs on the clock of the domain <em>if</em> the synchronous reset input is asserted.</p></li>
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">EnableInserter</span></code> introduces a synchronous enable input (or inputs), preventing any of the signals in the specified domains from changing value whenever the active edge occurs on the clock of the domain <em>unless</em> the synchronous enable input is asserted.</p></li>
</ul>
<p>Control flow modifiers use the syntax <code class="code highlight py python docutils literal highlight-python"><span class="n">Modifier</span><span class="p">(</span><span class="n">controls</span><span class="p">)(</span><span class="n">elaboratable</span><span class="p">)</span></code>, where <code class="code highlight py python docutils literal highlight-python"><span class="n">controls</span></code> is a mapping from <a class="reference internal" href="#lang-clockdomains"><span class="std std-ref">clock domain</span></a> names to 1-wide <a class="reference internal" href="#lang-values"><span class="std std-ref">values</span></a> and <code class="code highlight py python docutils literal highlight-python"><span class="n">elaboratable</span></code> is any <a class="reference internal" href="#lang-elaboration"><span class="std std-ref">elaboratable</span></a> object. When only the <code class="docutils literal notranslate"><span class="pre">sync</span></code> domain is involved, instead of writing <code class="code highlight py python docutils literal highlight-python"><span class="n">Modifier</span><span class="p">({</span><span class="s2">&quot;sync&quot;</span><span class="p">:</span> <span class="nb">input</span><span class="p">})(</span><span class="n">elaboratable</span><span class="p">)</span></code>, the equivalent but shorter <code class="code highlight py python docutils literal highlight-python"><span class="n">Modifier</span><span class="p">(</span><span class="nb">input</span><span class="p">)(</span><span class="n">elaboratable</span><span class="p">)</span></code> syntax can be used.</p>
<p>The result of applying a control flow modifier to an elaboratable is, itself, an elaboratable object. A common way to use a control flow modifier is to apply it to another elaboratable while adding it as a submodule:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rst</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="n">m</span><span class="o">.</span><span class="n">submodules</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">ResetInserter</span><span class="p">(</span><span class="n">rst</span><span class="p">)(</span><span class="n">Counter</span><span class="p">())</span>
</pre></div>
</div>
<p>A control flow modifier affects all logic within a given elaboratable and clock domain, which includes the submodules of that elaboratable.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Applying a control flow modifier to an elaboratable does not mutate it; a new proxy object is returned that forwards attribute accesses and method calls to the original elaboratable. Whenever this proxy object is elaborated, it manipulates the circuit defined by the original elaboratable to include the requested control inputs.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is possible to apply several control flow modifiers to the same elaboratable, even if the same domain is used. For <code class="xref py py-class docutils literal notranslate"><span class="pre">ResetInserter</span></code>, the signals in a domain are held at their initial value whenever any of the reset inputs for that domain are asserted (logical OR), and for <code class="xref py py-class docutils literal notranslate"><span class="pre">EnableInserter</span></code>, the signals in a domain are allowed to update whenever all of the enable signals for that domain are asserted (logical AND).</p>
</div>
<p>Consider the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">Module</span><span class="p">()</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">n</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">z</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">ResetInserter</span><span class="p">({</span><span class="s2">&quot;sync&quot;</span><span class="p">:</span> <span class="n">rst</span><span class="p">})(</span><span class="n">m</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">EnableInserter</span><span class="p">({</span><span class="s2">&quot;sync&quot;</span><span class="p">:</span> <span class="n">en</span><span class="p">})(</span><span class="n">m</span><span class="p">)</span>
</pre></div>
</div>
<p>The application of control flow modifiers in it causes the behavior of the final <code class="code highlight py python docutils literal highlight-python"><span class="n">m</span></code> to be identical to that of this module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">Module</span><span class="p">()</span>
<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">en</span><span class="p">):</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">n</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">rst</span><span class="p">):</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">n</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">init</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">z</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The control input provided to <code class="xref py py-class docutils literal notranslate"><span class="pre">ResetInserter</span></code> must be synchronous to the domain that is being reset by it. If you need to reset another domain, use <a class="reference internal" href="stdlib/cdc.html#amaranth.lib.cdc.ResetSynchronizer" title="amaranth.lib.cdc.ResetSynchronizer"><code class="xref py py-class docutils literal notranslate"><span class="pre">amaranth.lib.cdc.ResetSynchronizer</span></code></a> instead.</p>
</div>
</section>
<section id="renaming-domains">
<span id="lang-domainrenamer"></span><h3>Renaming domains<a class="headerlink" href="#renaming-domains" title="Permalink to this heading"></a></h3>
<p>A reusable <a class="reference internal" href="#lang-elaboration"><span class="std std-ref">elaboratable</span></a> usually specifies the use of one or more <a class="reference internal" href="#lang-clockdomains"><span class="std std-ref">clock domains</span></a> while leaving the details of clocking and initialization to a later phase in the design process. <code class="xref py py-class docutils literal notranslate"><span class="pre">DomainRenamer</span></code> can be used to alter a reusable elaboratable for integration in a specific design. Most elaboratables use a single clock domain named <code class="docutils literal notranslate"><span class="pre">sync</span></code>, and <code class="xref py py-class docutils literal notranslate"><span class="pre">DomainRenamer</span></code> makes it easy to place such elaboratables in any clock domain of a design.</p>
<p>Clock domains can be renamed using the syntax <code class="code highlight py python docutils literal highlight-python"><span class="n">DomainRenamer</span><span class="p">(</span><span class="n">domains</span><span class="p">)(</span><span class="n">elaboratable</span><span class="p">)</span></code>, where <code class="code highlight py python docutils literal highlight-python"><span class="n">domains</span></code> is a mapping from clock domain names to clock domain names and <code class="code highlight py python docutils literal highlight-python"><span class="n">elaboratable</span></code> is any <a class="reference internal" href="#lang-elaboration"><span class="std std-ref">elaboratable</span></a> object. The keys of <code class="code highlight py python docutils literal highlight-python"><span class="n">domains</span></code> correspond to existing clock domain names specified by <code class="code highlight py python docutils literal highlight-python"><span class="n">elaboratable</span></code>, and the values of <code class="code highlight py python docutils literal highlight-python"><span class="n">domains</span></code> correspond to the clock domain names from the containing elaboratable that will be used instead. When only the <code class="docutils literal notranslate"><span class="pre">sync</span></code> domain is being renamed, instead of writing <code class="code highlight py python docutils literal highlight-python"><span class="n">DomainRenamer</span><span class="p">({</span><span class="s2">&quot;sync&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">})(</span><span class="n">elaboratable</span><span class="p">)</span></code>, the equivalent but shorter <code class="code highlight py python docutils literal highlight-python"><span class="n">DomainRenamer</span><span class="p">(</span><span class="n">name</span><span class="p">)(</span><span class="n">elaboratable</span><span class="p">)</span></code> syntax can be used.</p>
<p>The result of renaming clock domains in an elaboratable is, itself, an elaboratable object. A common way to rename domains is to apply <code class="xref py py-class docutils literal notranslate"><span class="pre">DomainRenamer</span></code> to another elaboratable while adding it as a submodule:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">submodules</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">DomainRenamer</span><span class="p">(</span><span class="s2">&quot;video&quot;</span><span class="p">)(</span><span class="n">counter</span><span class="p">)</span>
</pre></div>
</div>
<p>Renaming a clock domain affects all logic within a given elaboratable and clock domain, which includes the submodules of that elaboratable. It does not affect any logic outside of that elaboratable.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Renaming domains in an elaboratable does not mutate it; a new proxy object is returned that forwards attribute accesses and method calls to the original elaboratable. Whenever this proxy object is elaborated, it manipulates the circuit defined by the original elaboratable to use the requested clock domain.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is possible to rename domains in an elaboratable and also apply <a class="reference internal" href="#lang-controlinserter"><span class="std std-ref">control flow modifiers</span></a>.</p>
</div>
<p>Consider the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">Module</span><span class="p">()</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">count</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">zero</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">DomainRenamer</span><span class="p">({</span><span class="s2">&quot;sync&quot;</span><span class="p">:</span> <span class="s2">&quot;video&quot;</span><span class="p">})(</span><span class="n">m</span><span class="p">)</span>
</pre></div>
</div>
<p>The renaming of the <code class="docutils literal notranslate"><span class="pre">sync</span></code> clock domain in it causes the behavior of the final <code class="code highlight py python docutils literal highlight-python"><span class="n">m</span></code> to be identical to that of this module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">Module</span><span class="p">()</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">video</span> <span class="o">+=</span> <span class="n">count</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">zero</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>A combinational signal can change synchronously to a clock domain, as in the example above, in which case it may only be sampled from the same clock domain unless explicitly synchronized. Renaming a clock domain must be assumed to potentially affect any output of an elaboratable.</p>
</div>
</section>
</section>
<section id="memories">
<span id="lang-memory"></span><h2>Memories<a class="headerlink" href="#memories" title="Permalink to this heading"></a></h2>
<p>Amaranth provides support for memories in the standard library module <a class="reference internal" href="stdlib/memory.html#module-amaranth.lib.memory" title="amaranth.lib.memory"><code class="xref py py-mod docutils literal notranslate"><span class="pre">amaranth.lib.memory</span></code></a>.</p>
</section>
<section id="i-o-values">
<span id="lang-iovalues"></span><h2>I/O values<a class="headerlink" href="#i-o-values" title="Permalink to this heading"></a></h2>
<p>To interoperate with external circuitry, Amaranth provides <em>I/O values</em>, which represent bundles of wires carrying uninterpreted signals. Unlike regular <a class="reference internal" href="#lang-values"><span class="std std-ref">values</span></a>, which represent binary numbers and can be <a class="reference internal" href="#lang-assigns"><span class="std std-ref">assigned</span></a> to create a unidirectional connection or used in computations, I/O values represent electrical signals that may be digital or analog and have no <a class="reference internal" href="#lang-shapes"><span class="std std-ref">shape</span></a>, cannot be assigned, used in computations, or simulated.</p>
<p>I/O values are only used to define connections between non-Amaranth building blocks that traverse an Amaranth design, including <a class="reference internal" href="#lang-instance"><span class="std std-ref">instances</span></a> and <a class="reference internal" href="#lang-iobufferinstance"><span class="std std-ref">I/O buffer instances</span></a>.</p>
<section id="i-o-ports">
<span id="lang-ioports"></span><h3>I/O ports<a class="headerlink" href="#i-o-ports" title="Permalink to this heading"></a></h3>
<p>An <em>I/O port</em> is an I/O value representing a connection to a port of the topmost module in the <a class="reference internal" href="#lang-submodules"><span class="std std-ref">design hierarchy</span></a>. It can be created with an explicitly specified width.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">amaranth.hdl</span> <span class="kn">import</span> <span class="n">IOPort</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">port</span> <span class="o">=</span> <span class="n">IOPort</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">port</span><span class="o">.</span><span class="n">width</span>
<span class="go">4</span>
</pre></div>
</div>
<p>I/O ports can be named in the same way as <a class="reference internal" href="#lang-signalname"><span class="std std-ref">signals</span></a>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">clk_port</span> <span class="o">=</span> <span class="n">IOPort</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;clk&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">clk_port</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;clk&#39;</span>
</pre></div>
</div>
<p>If two I/O ports with the same name exist in a design, one of them will be renamed to remove the ambiguity. Because the name of an I/O port is significant, they should be named unambiguously.</p>
</section>
<section id="i-o-operators">
<span id="lang-ioops"></span><h3>I/O operators<a class="headerlink" href="#i-o-operators" title="Permalink to this heading"></a></h3>
<p>I/O values support only a limited set of <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#typesseq" title="(in Python v3.12)"><span class="xref std std-ref">sequence</span></a> operators, all of which return another I/O value. The following table lists the I/O operators provided by Amaranth:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operation</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="code highlight py python docutils literal highlight-python"><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span></code></p></td>
<td><p>length; width</p></td>
<td><p><a class="footnote-reference brackets" href="#iops1" id="id16" role="doc-noteref"><span class="fn-bracket">[</span>10<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-odd"><td><p><code class="code highlight py python docutils literal highlight-python"><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">:</span><span class="n">k</span><span class="p">]</span></code></p></td>
<td><p>slicing by constant subscripts</p></td>
<td><p><a class="footnote-reference brackets" href="#iops2" id="id17" role="doc-noteref"><span class="fn-bracket">[</span>11<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-even"><td><p><code class="code highlight py python docutils literal highlight-python"><span class="nb">iter</span><span class="p">(</span><span class="n">a</span><span class="p">)</span></code></p></td>
<td><p>iteration</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="code highlight py python docutils literal highlight-python"><span class="n">Cat</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span></code></p></td>
<td><p>concatenation</p></td>
<td><p><a class="footnote-reference brackets" href="#iops3" id="id18" role="doc-noteref"><span class="fn-bracket">[</span>12<span class="fn-bracket">]</span></a> <a class="footnote-reference brackets" href="#iops4" id="id19" role="doc-noteref"><span class="fn-bracket">[</span>13<span class="fn-bracket">]</span></a></p></td>
</tr>
</tbody>
</table>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="iops1" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id16">10</a><span class="fn-bracket">]</span></span>
<p>Words “length” and “width” have the same meaning when talking about Amaranth I/O values. Conventionally, “width” is used.</p>
</aside>
<aside class="footnote brackets" id="iops2" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id17">11</a><span class="fn-bracket">]</span></span>
<p>All variations of the Python slice notation are supported, including “extended slicing”. E.g. all of <code class="code highlight py python docutils literal highlight-python"><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></code>, <code class="code highlight py python docutils literal highlight-python"><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span></code>, <code class="code highlight py python docutils literal highlight-python"><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span></code>, <code class="code highlight py python docutils literal highlight-python"><span class="n">a</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span></code>, <code class="code highlight py python docutils literal highlight-python"><span class="n">a</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></code>, <code class="code highlight py python docutils literal highlight-python"><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span></code> select wires in the same way as other Python sequence types select their elements.</p>
</aside>
<aside class="footnote brackets" id="iops3" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id18">12</a><span class="fn-bracket">]</span></span>
<p>In the concatenated value, <code class="code highlight py python docutils literal highlight-python"><span class="n">a</span></code> occupies the lower indices and <code class="code highlight py python docutils literal highlight-python"><span class="n">b</span></code> the higher indices. Any number of arguments (zero, one, two, or more) are supported.</p>
</aside>
<aside class="footnote brackets" id="iops4" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id19">13</a><span class="fn-bracket">]</span></span>
<p>Concatenation of zero arguments, <code class="code highlight py python docutils literal highlight-python"><span class="n">Cat</span><span class="p">()</span></code>, returns a 0-bit regular value, however any such value is accepted (and ignored) anywhere an I/O value is expected.</p>
</aside>
</aside>
</section>
</section>
<section id="instances">
<span id="lang-instance"></span><h2>Instances<a class="headerlink" href="#instances" title="Permalink to this heading"></a></h2>
<p>A submodule written in a non-Amaranth language is called an <em>instance</em>. An instance can be written in any language supported by the synthesis toolchain; usually, that is (System)Verilog, VHDL, or a language that is translated to one of those two. Adding an instance as a submodule corresponds to “module instantiation” in (System)Verilog and “component instantiation” in VHDL, and is done by specifying the following:</p>
<ul class="simple">
<li><p>The <em>type</em> of an instance is the name of a (System)Verilog module, VHDL entity or component, or another HDL design unit that is being instantiated.</p></li>
<li><p>The <em>name</em> of an instance is the name of the submodule within the containing elaboratable.</p></li>
<li><p>The <em>attributes</em> of an instance correspond to attributes of a (System)Verilog module instance, or a custom attribute of a VHDL entity or component instance. Attributes applied to instances are interpreted by the synthesis toolchain rather than the HDL.</p></li>
<li><p>The <em>parameters</em> of an instance correspond to parameters of a (System)Verilog module instance, or a generic constant of a VHDL entity or component instance. Not all HDLs allow their design units to be parameterized during instantiation.</p></li>
<li><p>The <em>inputs</em>, <em>outputs</em>, and <em>inouts</em> of an instance correspond to input ports, output ports, and bidirectional ports of the external design unit.</p></li>
</ul>
<p>An instance can be added as a submodule using the <code class="code highlight py python docutils literal highlight-python"><span class="n">m</span><span class="o">.</span><span class="n">submodules</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span></code> syntax, where <code class="code highlight py python docutils literal highlight-python"><span class="s2">&quot;type&quot;</span></code> is the type of the instance as a string (which is passed to the synthesis toolchain uninterpreted), and <code class="code highlight py python docutils literal highlight-python"><span class="o">...</span></code> is a list of parameters, inputs, and outputs. Depending on whether the name of an attribute, parameter, input, or output can be written as a part of a Python identifier or not, one of two possible syntaxes is used to specify them:</p>
<ul class="simple">
<li><p>An attribute is specified using the <code class="code highlight py python docutils literal highlight-python"><span class="n">a_ANAME</span><span class="o">=</span><span class="n">attr</span></code> or <code class="code highlight py python docutils literal highlight-python"><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;ANAME&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span></code> syntaxes. The <code class="code highlight py python docutils literal highlight-python"><span class="n">attr</span></code> must be an <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>, a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code></a>, or a <code class="xref py py-class docutils literal notranslate"><span class="pre">Const</span></code>.</p></li>
<li><p>A parameter is specified using the <code class="code highlight py python docutils literal highlight-python"><span class="n">p_PNAME</span><span class="o">=</span><span class="n">param</span></code> or <code class="code highlight py python docutils literal highlight-python"><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;PNAME&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span></code> syntaxes. The <code class="code highlight py python docutils literal highlight-python"><span class="n">param</span></code> must be an <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>, a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code></a>, or a <code class="xref py py-class docutils literal notranslate"><span class="pre">Const</span></code>.</p></li>
<li><p>An input is specified using the <code class="code highlight py python docutils literal highlight-python"><span class="n">i_INAME</span><span class="o">=</span><span class="n">in_val</span></code> or <code class="code highlight py python docutils literal highlight-python"><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;INAME&quot;</span><span class="p">,</span> <span class="n">in_val</span><span class="p">)</span></code> syntaxes. The <code class="code highlight py python docutils literal highlight-python"><span class="n">in_val</span></code> must be an <a class="reference internal" href="#lang-iovalues"><span class="std std-ref">I/O value</span></a> or a <a class="reference internal" href="#lang-valuelike"><span class="std std-ref">value-like</span></a> object.</p></li>
<li><p>An output is specified using the <code class="code highlight py python docutils literal highlight-python"><span class="n">o_ONAME</span><span class="o">=</span><span class="n">out_val</span></code> or <code class="code highlight py python docutils literal highlight-python"><span class="p">(</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;ONAME&quot;</span><span class="p">,</span> <span class="n">out_val</span><span class="p">)</span></code> syntaxes. The <code class="code highlight py python docutils literal highlight-python"><span class="n">out_val</span></code> must be an <a class="reference internal" href="#lang-iovalues"><span class="std std-ref">I/O value</span></a> or a <a class="reference internal" href="#lang-valuelike"><span class="std std-ref">value-like</span></a> object that casts to a <a class="reference internal" href="#lang-signals"><span class="std std-ref">signal</span></a>, a concatenation of signals, or a slice of a signal.</p></li>
<li><p>An inout is specified using the <code class="code highlight py python docutils literal highlight-python"><span class="n">io_IONAME</span><span class="o">=</span><span class="n">inout_val</span></code> or <code class="code highlight py python docutils literal highlight-python"><span class="p">(</span><span class="s2">&quot;io&quot;</span><span class="p">,</span> <span class="s2">&quot;IONAME&quot;</span><span class="p">,</span> <span class="n">inout_val</span><span class="p">)</span></code> syntaxes. The <code class="code highlight py python docutils literal highlight-python"><span class="n">inout_val</span></code> must be an <a class="reference internal" href="#lang-iovalues"><span class="std std-ref">I/O value</span></a>.</p></li>
</ul>
<p>The two following examples use both syntaxes to add the same instance of type <code class="docutils literal notranslate"><span class="pre">external</span></code> as a submodule named <code class="docutils literal notranslate"><span class="pre">processor</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">submodules</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="s2">&quot;external&quot;</span><span class="p">,</span>
    <span class="n">p_width</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">i_clk</span><span class="o">=</span><span class="n">ClockSignal</span><span class="p">(),</span>
    <span class="n">i_rst</span><span class="o">=</span><span class="n">ResetSignal</span><span class="p">(),</span>
    <span class="n">i_en</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">i_mode</span><span class="o">=</span><span class="n">Const</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">unsigned</span><span class="p">(</span><span class="mi">4</span><span class="p">)),</span>
    <span class="n">i_data_in</span><span class="o">=</span><span class="n">i_data</span><span class="p">,</span>
    <span class="n">o_data_out</span><span class="o">=</span><span class="n">o_data</span><span class="p">,</span>
    <span class="n">io_pin</span><span class="o">=</span><span class="n">io_pin</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">submodules</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="s2">&quot;external&quot;</span><span class="p">,</span>
    <span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;clk&quot;</span><span class="p">,</span> <span class="n">ClockSignal</span><span class="p">()),</span>
    <span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;rst&quot;</span><span class="p">,</span> <span class="n">ResetSignal</span><span class="p">()),</span>
    <span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;en&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="n">Const</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">unsigned</span><span class="p">(</span><span class="mi">4</span><span class="p">))),</span>
    <span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;data_in&quot;</span><span class="p">,</span> <span class="n">i_data</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;data_out&quot;</span><span class="p">,</span> <span class="n">o_data</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;io&quot;</span><span class="p">,</span> <span class="s2">&quot;pin&quot;</span><span class="p">,</span> <span class="n">io_pin</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Like a regular submodule, an instance can also be added without specifying a name:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">submodules</span> <span class="o">+=</span> <span class="n">Instance</span><span class="p">(</span><span class="s2">&quot;external&quot;</span><span class="p">,</span>
    <span class="c1"># ...</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If a name is not explicitly specified for a submodule, one will be generated and assigned automatically. Designs with many autogenerated names can be difficult to debug, so a name should usually be supplied.</p>
</div>
<p>Although an <code class="xref py py-class docutils literal notranslate"><span class="pre">Instance</span></code> is not an elaboratable, as a special case, it can be returned from the <code class="code highlight py python docutils literal highlight-python"><span class="n">elaborate</span><span class="p">()</span></code> method. This is conveinent for implementing an elaboratable that adorns an instance with an Amaranth interface:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">amaranth</span> <span class="kn">import</span> <span class="n">vendor</span>


<span class="k">class</span> <span class="nc">FlipFlop</span><span class="p">(</span><span class="n">Elaboratable</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">elaborate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="c1"># Decide on the instance to use based on the platform we are elaborating for.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">vendor</span><span class="o">.</span><span class="n">LatticeICE40Platform</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Instance</span><span class="p">(</span><span class="s2">&quot;SB_DFF&quot;</span><span class="p">,</span>
                <span class="n">i_C</span><span class="o">=</span><span class="n">ClockSignal</span><span class="p">(),</span>
                <span class="n">i_D</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span>
                <span class="n">o_Q</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</pre></div>
</div>
</section>
<section id="i-o-buffer-instances">
<span id="lang-iobufferinstance"></span><h2>I/O buffer instances<a class="headerlink" href="#i-o-buffer-instances" title="Permalink to this heading"></a></h2>
<p>An <em>I/O buffer instance</em> is a submodule that allows connecting <a class="reference internal" href="#lang-iovalues"><span class="std std-ref">I/O values</span></a> and regular <a class="reference internal" href="#lang-values"><span class="std std-ref">values</span></a> without the use of an external, toolchain- and technology-dependent <a class="reference internal" href="#lang-instance"><span class="std std-ref">instance</span></a>. It can be created in four configurations: input, output, tristatable output, and bidirectional (input/output).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">amaranth.hdl</span> <span class="kn">import</span> <span class="n">IOBufferInstance</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">Module</span><span class="p">()</span>
</pre></div>
</div>
<p>In the input configuration, the buffer combinationally drives a signal <code class="code highlight py python docutils literal highlight-python"><span class="n">i</span></code> by the port:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">port</span> <span class="o">=</span> <span class="n">IOPort</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">port_i</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">submodules</span> <span class="o">+=</span> <span class="n">IOBufferInstance</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">port_i</span><span class="p">)</span>
</pre></div>
</div>
<p>In the output configuration, the buffer combinationally drives the port by a value <code class="code highlight py python docutils literal highlight-python"><span class="n">o</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">port</span> <span class="o">=</span> <span class="n">IOPort</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">port_o</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">submodules</span> <span class="o">+=</span> <span class="n">IOBufferInstance</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">o</span><span class="o">=</span><span class="n">port_o</span><span class="p">)</span>
</pre></div>
</div>
<p>In the tristatable output configuration, the buffer combinationally drives the port by a value <code class="code highlight py python docutils literal highlight-python"><span class="n">o</span></code> if <code class="code highlight py python docutils literal highlight-python"><span class="n">oe</span></code> is asserted, and does not drive (leaves in a high-impedance state, or tristates) the port otherwise:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">port</span> <span class="o">=</span> <span class="n">IOPort</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">port_o</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">port_oe</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="n">m</span><span class="o">.</span><span class="n">submodules</span> <span class="o">+=</span> <span class="n">IOBufferInstance</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">o</span><span class="o">=</span><span class="n">port_o</span><span class="p">,</span> <span class="n">oe</span><span class="o">=</span><span class="n">port_oe</span><span class="p">)</span>
</pre></div>
</div>
<p>In the bidirectional (input/output) configuration, the buffer combinationally drives a signal <code class="code highlight py python docutils literal highlight-python"><span class="n">i</span></code> by the port, combinationally drives the port by a value <code class="code highlight py python docutils literal highlight-python"><span class="n">o</span></code> if <code class="code highlight py python docutils literal highlight-python"><span class="n">oe</span></code> is asserted, and does not drive (leaves in a high-impedance state, or tristates) the port otherwise:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">port</span> <span class="o">=</span> <span class="n">IOPort</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">port_i</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">port_o</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">port_oe</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
<span class="n">m</span><span class="o">.</span><span class="n">submodules</span> <span class="o">+=</span> <span class="n">IOBufferInstance</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">port_i</span><span class="p">,</span> <span class="n">o</span><span class="o">=</span><span class="n">port_o</span><span class="p">,</span> <span class="n">oe</span><span class="o">=</span><span class="n">port_oe</span><span class="p">)</span>
</pre></div>
</div>
<p>The width of the <code class="code highlight py python docutils literal highlight-python"><span class="n">i</span></code> and <code class="code highlight py python docutils literal highlight-python"><span class="n">o</span></code> values (when present) must be the same as the width of the port, and the width of the <code class="code highlight py python docutils literal highlight-python"><span class="n">oe</span></code> value must be 1.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="tutorial.html" class="btn btn-neutral float-left" title="Tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="reference.html" class="btn btn-neutral float-right" title="Language reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020—2024, Amaranth project contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>