<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data structures &mdash; Amaranth HDL toolchain 0.4.dev263 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/platformpicker.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=395106a4"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="../_static/platformpicker.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Code conversion" href="coding.html" />
    <link rel="prev" title="Enumerations" href="enum.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../cover.html" class="icon icon-home">
            Amaranth HDL toolchain
          </a>
              <div class="version">
                0.4.dev263+g6ad0d21.editable
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Language &amp; toolchain</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../intro.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../start.html">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial.html">Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lang.html">Language guide</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../stdlib.html">Standard library</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="enum.html">Enumerations</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Data structures</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modeling-structured-data">Modeling structured data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#common-data-layouts">Common data layouts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#data-views">Data views</a></li>
<li class="toctree-l4"><a class="reference internal" href="#data-classes">Data classes</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="coding.html">Code conversion</a></li>
<li class="toctree-l3"><a class="reference internal" href="cdc.html">Clock domain crossing</a></li>
<li class="toctree-l3"><a class="reference internal" href="crc.html">Cyclic redundancy checks</a></li>
<li class="toctree-l3"><a class="reference internal" href="fifo.html">First-in first-out queues</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../platform.html">Platform integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changes.html">Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib.html">Contributing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://amaranth-lang.org/docs/amaranth-boards/latest/">Board definitions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../cover.html">Amaranth HDL toolchain</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../cover.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Language &amp; toolchain</a></li>
          <li class="breadcrumb-item"><a href="../stdlib.html">Standard library</a></li>
      <li class="breadcrumb-item active">Data structures</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/stdlib/data.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="module-amaranth.lib.data">
<span id="data-structures"></span><h1>Data structures<a class="headerlink" href="#module-amaranth.lib.data" title="Permalink to this heading"></a></h1>
<p>The <a class="reference internal" href="#module-amaranth.lib.data" title="amaranth.lib.data"><code class="xref py py-mod docutils literal notranslate"><span class="pre">amaranth.lib.data</span></code></a> module provides a way to describe the bitwise layout of values and a proxy class for accessing fields of values using the attribute access and indexing syntax.</p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h2>
<section id="overview">
<h3>Overview<a class="headerlink" href="#overview" title="Permalink to this heading"></a></h3>
<p>This module provides four related facilities:</p>
<ol class="arabic simple">
<li><p>Low-level bitwise layout description via <a class="reference internal" href="#amaranth.lib.data.Field" title="amaranth.lib.data.Field"><code class="xref py py-class docutils literal notranslate"><span class="pre">Field</span></code></a> and <a class="reference internal" href="#amaranth.lib.data.Layout" title="amaranth.lib.data.Layout"><code class="xref py py-class docutils literal notranslate"><span class="pre">Layout</span></code></a>. These classes are rarely used directly, but are the foundation on which all other functionality is built. They are also useful for introspection.</p></li>
<li><p>High-level bitwise layout description via <a class="reference internal" href="#amaranth.lib.data.StructLayout" title="amaranth.lib.data.StructLayout"><code class="xref py py-class docutils literal notranslate"><span class="pre">StructLayout</span></code></a>, <a class="reference internal" href="#amaranth.lib.data.UnionLayout" title="amaranth.lib.data.UnionLayout"><code class="xref py py-class docutils literal notranslate"><span class="pre">UnionLayout</span></code></a>, <a class="reference internal" href="#amaranth.lib.data.ArrayLayout" title="amaranth.lib.data.ArrayLayout"><code class="xref py py-class docutils literal notranslate"><span class="pre">ArrayLayout</span></code></a>, and <a class="reference internal" href="#amaranth.lib.data.FlexibleLayout" title="amaranth.lib.data.FlexibleLayout"><code class="xref py py-class docutils literal notranslate"><span class="pre">FlexibleLayout</span></code></a>. These classes are the ones most often used directly, in particular <a class="reference internal" href="#amaranth.lib.data.StructLayout" title="amaranth.lib.data.StructLayout"><code class="xref py py-class docutils literal notranslate"><span class="pre">StructLayout</span></code></a> and <a class="reference internal" href="#amaranth.lib.data.ArrayLayout" title="amaranth.lib.data.ArrayLayout"><code class="xref py py-class docutils literal notranslate"><span class="pre">ArrayLayout</span></code></a>.</p></li>
<li><p>Data views via <a class="reference internal" href="#amaranth.lib.data.View" title="amaranth.lib.data.View"><code class="xref py py-class docutils literal notranslate"><span class="pre">View</span></code></a> or its user-defined subclasses. This class is used to apply a layout description to a plain <code class="xref py py-class docutils literal notranslate"><span class="pre">Value</span></code>, enabling structured access to its bits.</p></li>
<li><p>Data classes <a class="reference internal" href="#amaranth.lib.data.Struct" title="amaranth.lib.data.Struct"><code class="xref py py-class docutils literal notranslate"><span class="pre">Struct</span></code></a> and <a class="reference internal" href="#amaranth.lib.data.Union" title="amaranth.lib.data.Union"><code class="xref py py-class docutils literal notranslate"><span class="pre">Union</span></code></a>. These classes are data views with a layout that is defined using Python <a class="reference external" href="https://docs.python.org/3/glossary.html#term-variable-annotation" title="(in Python v3.12)"><span class="xref std std-term">variable annotations</span></a> (also known as type annotations).</p></li>
</ol>
</section>
<section id="motivation">
<h3>Motivation<a class="headerlink" href="#motivation" title="Permalink to this heading"></a></h3>
<p>The fundamental Amaranth type is a <code class="xref py py-class docutils literal notranslate"><span class="pre">Value</span></code>: a sequence of bits that can also be used as a number. Manipulating values directly is sufficient for simple applications, but in more complex ones, values are often more than just a sequence of bits; they have well-defined internal structure.</p>
<p>For example, consider a module that processes pixels, converting them from RGB to grayscale. The color pixel format is RGB565:</p>
<img alt="../_images/rgb565_layout.svg" src="../_images/rgb565_layout.svg" /><p>This module could be implemented (using a fast but <em>very</em> approximate method) as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">i_color</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="n">o_gray</span>  <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>

<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">o_gray</span><span class="o">.</span><span class="n">eq</span><span class="p">((</span><span class="n">i_color</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">i_color</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span> <span class="o">+</span> <span class="n">i_color</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">16</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>While this implementation works, it is repetitive, error-prone, hard to read, and laborous to change; all because the color components are referenced using bit offsets. To improve it, the structure can be described with a <a class="reference internal" href="#amaranth.lib.data.Layout" title="amaranth.lib.data.Layout"><code class="xref py py-class docutils literal notranslate"><span class="pre">Layout</span></code></a> so that the components can be referenced by name:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">amaranth.lib</span> <span class="kn">import</span> <span class="n">data</span><span class="p">,</span> <span class="n">enum</span>

<span class="n">rgb565_layout</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">StructLayout</span><span class="p">({</span>
    <span class="s2">&quot;red&quot;</span><span class="p">:</span>   <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;green&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="s2">&quot;blue&quot;</span><span class="p">:</span>  <span class="mi">5</span>
<span class="p">})</span>

<span class="n">i_color</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="n">rgb565_layout</span><span class="p">)</span>
<span class="n">o_gray</span>  <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>

<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">o_gray</span><span class="o">.</span><span class="n">eq</span><span class="p">((</span><span class="n">i_color</span><span class="o">.</span><span class="n">red</span> <span class="o">+</span> <span class="n">i_color</span><span class="o">.</span><span class="n">green</span> <span class="o">+</span> <span class="n">i_color</span><span class="o">.</span><span class="n">blue</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="#amaranth.lib.data.View" title="amaranth.lib.data.View"><code class="xref py py-class docutils literal notranslate"><span class="pre">View</span></code></a> is <a class="reference internal" href="../lang.html#lang-valuelike"><span class="std std-ref">value-like</span></a> and can be used anywhere a plain value can be used. For example, it can be assigned to in the usual way:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="n">i_color</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># everything is black</span>
</pre></div>
</div>
</section>
<section id="composing-layouts">
<h3>Composing layouts<a class="headerlink" href="#composing-layouts" title="Permalink to this heading"></a></h3>
<p>Layouts are composable: a <a class="reference internal" href="#amaranth.lib.data.Layout" title="amaranth.lib.data.Layout"><code class="xref py py-class docutils literal notranslate"><span class="pre">Layout</span></code></a> is a <a class="reference internal" href="../lang.html#lang-shapes"><span class="std std-ref">shape</span></a> and can be used as a part of another layout. In this case, an attribute access through a view returns a view as well.</p>
<p>For example, consider a module that processes RGB pixels in groups of up to four at a time, provided by another module, and accumulates their average intensity:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">input_layout</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">StructLayout</span><span class="p">({</span>
    <span class="s2">&quot;pixels&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">ArrayLayout</span><span class="p">(</span><span class="n">rgb565_layout</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="s2">&quot;valid&quot;</span><span class="p">:</span>  <span class="mi">4</span>
<span class="p">})</span>

<span class="n">i_stream</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="n">input_layout</span><span class="p">)</span>
<span class="n">r_accum</span>  <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">r_accum</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span>
    <span class="n">r_accum</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">((</span><span class="n">i_stream</span><span class="o">.</span><span class="n">pixels</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">red</span> <span class="o">+</span>
                   <span class="n">i_stream</span><span class="o">.</span><span class="n">pixels</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">green</span> <span class="o">+</span>
                   <span class="n">i_stream</span><span class="o">.</span><span class="n">pixels</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">blue</span><span class="p">)</span>
                  <span class="o">*</span> <span class="n">i_stream</span><span class="o">.</span><span class="n">valid</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                  <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">i_stream</span><span class="o">.</span><span class="n">valid</span><span class="p">))))</span>
</pre></div>
</div>
<p>Note how the width of <code class="docutils literal notranslate"><span class="pre">i_stream</span></code> is never defined explicitly; it is instead inferred from the shapes of its fields.</p>
<p>In the previous section, the precise bitwise layout was important, since RGB565 is an interchange format. In this section however the exact bit positions do not matter, since the layout is only used internally to communicate between two modules in the same design. It is sufficient that both of them use the same layout.</p>
</section>
<section id="defining-layouts">
<h3>Defining layouts<a class="headerlink" href="#defining-layouts" title="Permalink to this heading"></a></h3>
<p>Data layouts can be defined in a few different ways depending on the use case.</p>
<p>In case the data format is defined using a family of layouts instead of a single specific one, a function can be used:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rgb_layout</span><span class="p">(</span><span class="n">r_bits</span><span class="p">,</span> <span class="n">g_bits</span><span class="p">,</span> <span class="n">b_bits</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">StructLayout</span><span class="p">({</span>
        <span class="s2">&quot;red&quot;</span><span class="p">:</span>   <span class="n">unsigned</span><span class="p">(</span><span class="n">r_bits</span><span class="p">),</span>
        <span class="s2">&quot;green&quot;</span><span class="p">:</span> <span class="n">unsigned</span><span class="p">(</span><span class="n">g_bits</span><span class="p">),</span>
        <span class="s2">&quot;blue&quot;</span><span class="p">:</span>  <span class="n">unsigned</span><span class="p">(</span><span class="n">b_bits</span><span class="p">)</span>
    <span class="p">})</span>

<span class="n">rgb565_layout</span> <span class="o">=</span> <span class="n">rgb_layout</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">rgb24_layout</span>  <span class="o">=</span> <span class="n">rgb_layout</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
<p>In case the data has related operations or transformations, <a class="reference internal" href="#amaranth.lib.data.View" title="amaranth.lib.data.View"><code class="xref py py-class docutils literal notranslate"><span class="pre">View</span></code></a> can be subclassed to define methods implementing them:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RGBLayout</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">StructLayout</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r_bits</span><span class="p">,</span> <span class="n">g_bits</span><span class="p">,</span> <span class="n">b_bits</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">({</span>
            <span class="s2">&quot;red&quot;</span><span class="p">:</span>   <span class="n">unsigned</span><span class="p">(</span><span class="n">r_bits</span><span class="p">),</span>
            <span class="s2">&quot;green&quot;</span><span class="p">:</span> <span class="n">unsigned</span><span class="p">(</span><span class="n">g_bits</span><span class="p">),</span>
            <span class="s2">&quot;blue&quot;</span><span class="p">:</span>  <span class="n">unsigned</span><span class="p">(</span><span class="n">b_bits</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">RGBView</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">RGBView</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">View</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">brightness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">red</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">green</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">blue</span><span class="p">)[</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span>
</pre></div>
</div>
<p>Here, the <code class="docutils literal notranslate"><span class="pre">RGBLayout</span></code> class itself is <a class="reference internal" href="../lang.html#lang-shapelike"><span class="std std-ref">shape-like</span></a> and can be used anywhere a shape is accepted. When a <code class="xref py py-class docutils literal notranslate"><span class="pre">Signal</span></code> is constructed with this layout, the returned value is wrapped in an <code class="docutils literal notranslate"><span class="pre">RGBView</span></code>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pixel</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="n">RGBLayout</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">pixel</span><span class="o">.</span><span class="n">as_value</span><span class="p">())</span>
<span class="go">16</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pixel</span><span class="o">.</span><span class="n">red</span>
<span class="go">(slice (sig pixel) 0:5)</span>
</pre></div>
</div>
<p>In case the data format is static, <a class="reference internal" href="#amaranth.lib.data.Struct" title="amaranth.lib.data.Struct"><code class="xref py py-class docutils literal notranslate"><span class="pre">Struct</span></code></a> (or <a class="reference internal" href="#amaranth.lib.data.Union" title="amaranth.lib.data.Union"><code class="xref py py-class docutils literal notranslate"><span class="pre">Union</span></code></a>) can be subclassed instead of <a class="reference internal" href="#amaranth.lib.data.View" title="amaranth.lib.data.View"><code class="xref py py-class docutils literal notranslate"><span class="pre">View</span></code></a>, to reduce the amount of boilerplate needed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">IEEE754Single</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Struct</span><span class="p">):</span>
    <span class="n">fraction</span><span class="p">:</span> <span class="mi">23</span>
    <span class="n">exponent</span><span class="p">:</span>  <span class="mi">8</span> <span class="o">=</span> <span class="mh">0x7f</span>
    <span class="n">sign</span><span class="p">:</span>      <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">is_subnormal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exponent</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>
</div>
</section>
<section id="discriminated-unions">
<h3>Discriminated unions<a class="headerlink" href="#discriminated-unions" title="Permalink to this heading"></a></h3>
<p>This module provides a <a class="reference internal" href="#amaranth.lib.data.UnionLayout" title="amaranth.lib.data.UnionLayout"><code class="xref py py-class docutils literal notranslate"><span class="pre">UnionLayout</span></code></a>, which is rarely needed by itself, but is very useful in combination with a <em>discriminant</em>: a enumeration indicating which field of the union contains valid data.</p>
<p>For example, consider a module that can direct another module to perform one of a few operations, each of which requires its own parameters. The two modules could communicate through a channel with a layout like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Struct</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Kind</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
        <span class="n">SET_ADDR</span>  <span class="o">=</span> <span class="mi">0</span>
        <span class="n">SEND_DATA</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">valid</span>  <span class="p">:</span> <span class="mi">1</span>
    <span class="n">kind</span>   <span class="p">:</span> <span class="n">Kind</span>
    <span class="n">params</span> <span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">UnionLayout</span><span class="p">({</span>
        <span class="s2">&quot;set_addr&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">StructLayout</span><span class="p">({</span>
            <span class="s2">&quot;addr&quot;</span><span class="p">:</span> <span class="n">unsigned</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="p">}),</span>
        <span class="s2">&quot;send_data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">StructLayout</span><span class="p">({</span>
            <span class="s2">&quot;byte&quot;</span><span class="p">:</span> <span class="n">unsigned</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">})</span>
</pre></div>
</div>
<p>Here, the shape of the <code class="docutils literal notranslate"><span class="pre">Command</span></code> is inferred, being large enough to accommodate the biggest of all defined parameter structures, and it is not necessary to manage it manually.</p>
<p>One module could submit a command with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cmd</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="n">Command</span><span class="p">)</span>

<span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">comb</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">Command</span><span class="o">.</span><span class="n">Kind</span><span class="o">.</span><span class="n">SET_ADDR</span><span class="p">),</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">set_addr</span><span class="o">.</span><span class="n">addr</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mh">0x00001234</span><span class="p">)</span>
<span class="p">]</span>
</pre></div>
</div>
<p>The other would react to commands as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">addr</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

<span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">valid</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Switch</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">kind</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Case</span><span class="p">(</span><span class="n">Command</span><span class="o">.</span><span class="n">Kind</span><span class="o">.</span><span class="n">SET_ADDR</span><span class="p">):</span>
            <span class="n">m</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">sync</span> <span class="o">+=</span> <span class="n">addr</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">set_addr</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">m</span><span class="o">.</span><span class="n">Case</span><span class="p">(</span><span class="n">Command</span><span class="o">.</span><span class="n">Kind</span><span class="o">.</span><span class="n">SEND_DATA</span><span class="p">):</span>
           <span class="o">...</span>
</pre></div>
</div>
</section>
</section>
<section id="modeling-structured-data">
<h2>Modeling structured data<a class="headerlink" href="#modeling-structured-data" title="Permalink to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="amaranth.lib.data.Field">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">amaranth.lib.data.</span></span><span class="sig-name descname"><span class="pre">Field</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">shape</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">offset</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.Field" title="Permalink to this definition"></a></dt>
<dd><p>Description of a data field.</p>
<p>The <a class="reference internal" href="#amaranth.lib.data.Field" title="amaranth.lib.data.Field"><code class="xref py py-class docutils literal notranslate"><span class="pre">Field</span></code></a> class specifies the signedness and bit positions of a field in
an Amaranth value.</p>
<p><a class="reference internal" href="#amaranth.lib.data.Field" title="amaranth.lib.data.Field"><code class="xref py py-class docutils literal notranslate"><span class="pre">Field</span></code></a> objects are immutable.</p>
<dl class="field-list simple">
<dt class="field-odd">Variables<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>shape</strong> (<a class="reference internal" href="../lang.html#lang-shapelike"><span class="std std-ref">shape-like</span></a>) – Shape of the field. When initialized or assigned, the object is stored as-is.</p></li>
<li><p><strong>offset</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>, &gt;=0) – Index of the least significant bit of the field.</p></li>
</ul>
</dd>
</dl>
<dl class="py property">
<dt class="sig sig-object py" id="amaranth.lib.data.Field.width">
<em class="property"><span class="pre">property</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">width</span></span><a class="headerlink" href="#amaranth.lib.data.Field.width" title="Permalink to this definition"></a></dt>
<dd><p>Width of the field.</p>
<p>This property should be used over <code class="docutils literal notranslate"><span class="pre">self.shape.width</span></code> because <code class="docutils literal notranslate"><span class="pre">self.shape</span></code> can be
an arbitrary <a class="reference internal" href="../lang.html#lang-shapelike"><span class="std std-ref">shape-like</span></a> object, which may not have
a <code class="docutils literal notranslate"><span class="pre">width</span></code> property.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">Shape.cast(self.shape).width</span></code></p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth.lib.data.Field.__eq__">
<span class="sig-name descname"><span class="pre">__eq__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">other</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.Field.__eq__" title="Permalink to this definition"></a></dt>
<dd><p>Compare fields.</p>
<p>Two fields are equal if they have the same shape and offset.</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="amaranth.lib.data.Layout">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">amaranth.lib.data.</span></span><span class="sig-name descname"><span class="pre">Layout</span></span><a class="headerlink" href="#amaranth.lib.data.Layout" title="Permalink to this definition"></a></dt>
<dd><p>Description of a data layout.</p>
<p>The <a class="reference internal" href="../lang.html#lang-shapelike"><span class="std std-ref">shape-like</span></a> <a class="reference internal" href="#amaranth.lib.data.Layout" title="amaranth.lib.data.Layout"><code class="xref py py-class docutils literal notranslate"><span class="pre">Layout</span></code></a> interface associates keys
(string names or integer indexes) with fields, giving identifiers to spans of bits in
an Amaranth value.</p>
<p>It is an abstract base class; <a class="reference internal" href="#amaranth.lib.data.StructLayout" title="amaranth.lib.data.StructLayout"><code class="xref py py-class docutils literal notranslate"><span class="pre">StructLayout</span></code></a>, <a class="reference internal" href="#amaranth.lib.data.UnionLayout" title="amaranth.lib.data.UnionLayout"><code class="xref py py-class docutils literal notranslate"><span class="pre">UnionLayout</span></code></a>,
<a class="reference internal" href="#amaranth.lib.data.ArrayLayout" title="amaranth.lib.data.ArrayLayout"><code class="xref py py-class docutils literal notranslate"><span class="pre">ArrayLayout</span></code></a>, and <a class="reference internal" href="#amaranth.lib.data.FlexibleLayout" title="amaranth.lib.data.FlexibleLayout"><code class="xref py py-class docutils literal notranslate"><span class="pre">FlexibleLayout</span></code></a> implement concrete layout rules.
New layout rules can be defined by inheriting from this class.</p>
<p>Like all other shape-castable objects, all layouts are immutable. New classes deriving from
<a class="reference internal" href="#amaranth.lib.data.Layout" title="amaranth.lib.data.Layout"><code class="xref py py-class docutils literal notranslate"><span class="pre">Layout</span></code></a> must preserve this invariant.</p>
<dl class="py method">
<dt class="sig sig-object py" id="amaranth.lib.data.Layout.cast">
<em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">cast</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">obj</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.Layout.cast" title="Permalink to this definition"></a></dt>
<dd><p>Cast a <a class="reference internal" href="../lang.html#lang-shapelike"><span class="std std-ref">shape-like</span></a> object to a layout.</p>
<p>This method performs a subset of the operations done by <code class="xref py py-meth docutils literal notranslate"><span class="pre">Shape.cast()</span></code>; it will
recursively call <code class="docutils literal notranslate"><span class="pre">.as_shape()</span></code>, but only until a layout is returned.</p>
<dl class="field-list simple">
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#TypeError" title="(in Python v3.12)"><strong>TypeError</strong></a> – If <code class="docutils literal notranslate"><span class="pre">obj</span></code> cannot be converted to a <a class="reference internal" href="#amaranth.lib.data.Layout" title="amaranth.lib.data.Layout"><code class="xref py py-class docutils literal notranslate"><span class="pre">Layout</span></code></a> instance.</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#RecursionError" title="(in Python v3.12)"><strong>RecursionError</strong></a> – If <code class="docutils literal notranslate"><span class="pre">obj.as_shape()</span></code> returns <code class="docutils literal notranslate"><span class="pre">obj</span></code>.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth.lib.data.Layout.__iter__">
<em class="property"><span class="pre">abstract</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">__iter__</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.Layout.__iter__" title="Permalink to this definition"></a></dt>
<dd><p>Iterate fields in the layout.</p>
<dl class="field-list simple">
<dt class="field-odd">Yields<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code></a> or <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a> – Key (either name or index) for accessing the field.</p></li>
<li><p><a class="reference internal" href="#amaranth.lib.data.Field" title="amaranth.lib.data.Field"><code class="xref py py-class docutils literal notranslate"><span class="pre">Field</span></code></a> – Description of the field.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth.lib.data.Layout.__getitem__">
<em class="property"><span class="pre">abstract</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">__getitem__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">key</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.Layout.__getitem__" title="Permalink to this definition"></a></dt>
<dd><p>Retrieve a field from the layout.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>The field associated with <code class="docutils literal notranslate"><span class="pre">key</span></code>.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><a class="reference internal" href="#amaranth.lib.data.Field" title="amaranth.lib.data.Field"><code class="xref py py-class docutils literal notranslate"><span class="pre">Field</span></code></a></p>
</dd>
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#KeyError" title="(in Python v3.12)"><strong>KeyError</strong></a> – If there is no field associated with <code class="docutils literal notranslate"><span class="pre">key</span></code>.</p>
</dd>
</dl>
</dd></dl>

<dl class="py property">
<dt class="sig sig-object py" id="amaranth.lib.data.Layout.size">
<em class="property"><span class="pre">abstract</span><span class="w"> </span><span class="pre">property</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">size</span></span><a class="headerlink" href="#amaranth.lib.data.Layout.size" title="Permalink to this definition"></a></dt>
<dd><p>Size of the layout.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>The amount of bits required to store every field in the layout.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth.lib.data.Layout.as_shape">
<span class="sig-name descname"><span class="pre">as_shape</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.Layout.as_shape" title="Permalink to this definition"></a></dt>
<dd><p>Shape of the layout.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">unsigned(self.size)</span></code></p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Shape</span></code></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth.lib.data.Layout.__eq__">
<span class="sig-name descname"><span class="pre">__eq__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">other</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.Layout.__eq__" title="Permalink to this definition"></a></dt>
<dd><p>Compare layouts.</p>
<p>Two layouts are equal if they have the same size and the same fields under the same names.
The order of the fields is not considered.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth.lib.data.Layout.__call__">
<span class="sig-name descname"><span class="pre">__call__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">target</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.Layout.__call__" title="Permalink to this definition"></a></dt>
<dd><p>Create a view into a target.</p>
<p>When a <a class="reference internal" href="#amaranth.lib.data.Layout" title="amaranth.lib.data.Layout"><code class="xref py py-class docutils literal notranslate"><span class="pre">Layout</span></code></a> is used as the shape of a <a class="reference internal" href="#amaranth.lib.data.Field" title="amaranth.lib.data.Field"><code class="xref py py-class docutils literal notranslate"><span class="pre">Field</span></code></a> and accessed through
a <a class="reference internal" href="#amaranth.lib.data.View" title="amaranth.lib.data.View"><code class="xref py py-class docutils literal notranslate"><span class="pre">View</span></code></a>, this method is used to wrap the slice of the underlying value into
another view with this layout.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">View(self,</span> <span class="pre">target)</span></code></p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><a class="reference internal" href="#amaranth.lib.data.View" title="amaranth.lib.data.View"><code class="xref py py-class docutils literal notranslate"><span class="pre">View</span></code></a></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth.lib.data.Layout.const">
<span class="sig-name descname"><span class="pre">const</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">init</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.Layout.const" title="Permalink to this definition"></a></dt>
<dd><p>Convert a constant initializer to a constant.</p>
<p>Converts <code class="docutils literal notranslate"><span class="pre">init</span></code>, which may be a sequence or a mapping of field values, to a constant.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>A constant that has the same value as a view with this layout that was initialized with
an all-zero value and had every field assigned to the corresponding value in the order
in which they appear in <code class="docutils literal notranslate"><span class="pre">init</span></code>.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Const</span></code></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</section>
<section id="common-data-layouts">
<h2>Common data layouts<a class="headerlink" href="#common-data-layouts" title="Permalink to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="amaranth.lib.data.StructLayout">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">amaranth.lib.data.</span></span><span class="sig-name descname"><span class="pre">StructLayout</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">members</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.StructLayout" title="Permalink to this definition"></a></dt>
<dd><p>Description of a structure layout.</p>
<p>The fields of a structure layout follow one another without any gaps, and the size of
a structure layout is the sum of the sizes of its members.</p>
<p>For example, the following layout of a 16-bit value:</p>
<img alt="../_images/struct_layout.svg" src="../_images/struct_layout.svg" /><p>can be described with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">StructLayout</span><span class="p">({</span>
    <span class="s2">&quot;first&quot;</span><span class="p">:</span>  <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;second&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s2">&quot;third&quot;</span><span class="p">:</span>  <span class="mi">6</span>
<span class="p">})</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Structures that have padding can be described with a <a class="reference internal" href="#amaranth.lib.data.FlexibleLayout" title="amaranth.lib.data.FlexibleLayout"><code class="xref py py-class docutils literal notranslate"><span class="pre">FlexibleLayout</span></code></a>. Alternately,
padding can be added to the layout as fields called <code class="docutils literal notranslate"><span class="pre">_1</span></code>, <code class="docutils literal notranslate"><span class="pre">_2</span></code>, and so on. These fields
won’t be accessible as attributes or by using indexing.</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Variables<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>members</strong> (mapping of <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code></a> to <a class="reference internal" href="../lang.html#lang-shapelike"><span class="std std-ref">shape-like</span></a>) – Dictionary of structure members.</p>
</dd>
</dl>
<dl class="py property">
<dt class="sig sig-object py" id="amaranth.lib.data.StructLayout.size">
<em class="property"><span class="pre">property</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">size</span></span><a class="headerlink" href="#amaranth.lib.data.StructLayout.size" title="Permalink to this definition"></a></dt>
<dd><p>Size of the structure layout.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>Index of the most significant bit of the <em>last</em> field plus one; or zero if there are
no fields.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="amaranth.lib.data.UnionLayout">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">amaranth.lib.data.</span></span><span class="sig-name descname"><span class="pre">UnionLayout</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">members</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.UnionLayout" title="Permalink to this definition"></a></dt>
<dd><p>Description of a union layout.</p>
<p>The fields of a union layout all start from bit 0, and the size of a union layout is the size
of the largest of its members.</p>
<p>For example, the following layout of a 7-bit value:</p>
<img alt="../_images/union_layout.svg" src="../_images/union_layout.svg" /><p>can be described with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">UnionLayout</span><span class="p">({</span>
    <span class="s2">&quot;first&quot;</span><span class="p">:</span>  <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;second&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s2">&quot;third&quot;</span><span class="p">:</span>  <span class="mi">6</span>
<span class="p">})</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Variables<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>members</strong> (mapping of <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code></a> to <a class="reference internal" href="../lang.html#lang-shapelike"><span class="std std-ref">shape-like</span></a>) – Dictionary of union members.</p>
</dd>
</dl>
<dl class="py property">
<dt class="sig sig-object py" id="amaranth.lib.data.UnionLayout.size">
<em class="property"><span class="pre">property</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">size</span></span><a class="headerlink" href="#amaranth.lib.data.UnionLayout.size" title="Permalink to this definition"></a></dt>
<dd><p>Size of the union layout.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>Index of the most significant bit of the <em>largest</em> field plus one; or zero if there are
no fields.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth.lib.data.UnionLayout.const">
<span class="sig-name descname"><span class="pre">const</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">init</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.UnionLayout.const" title="Permalink to this definition"></a></dt>
<dd><p>Convert a constant initializer to a constant.</p>
<p>Converts <code class="docutils literal notranslate"><span class="pre">init</span></code>, which may be a sequence or a mapping of field values, to a constant.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>A constant that has the same value as a view with this layout that was initialized with
an all-zero value and had every field assigned to the corresponding value in the order
in which they appear in <code class="docutils literal notranslate"><span class="pre">init</span></code>.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Const</span></code></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="amaranth.lib.data.ArrayLayout">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">amaranth.lib.data.</span></span><span class="sig-name descname"><span class="pre">ArrayLayout</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">elem_shape</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">length</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.ArrayLayout" title="Permalink to this definition"></a></dt>
<dd><p>Description of an array layout.</p>
<p>The fields of an array layout follow one another without any gaps, and the size of an array
layout is the size of its element multiplied by its length.</p>
<p>For example, the following layout of a 16-bit value:</p>
<img alt="../_images/array_layout.svg" src="../_images/array_layout.svg" /><p>can be described with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">ArrayLayout</span><span class="p">(</span><span class="n">unsigned</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Arrays that have padding can be described with a <a class="reference internal" href="#amaranth.lib.data.FlexibleLayout" title="amaranth.lib.data.FlexibleLayout"><code class="xref py py-class docutils literal notranslate"><span class="pre">FlexibleLayout</span></code></a>.</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Variables<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>elem_shape</strong> (<a class="reference internal" href="../lang.html#lang-shapelike"><span class="std std-ref">shape-like</span></a>) – Shape of an individual element.</p></li>
<li><p><strong>length</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>) – Amount of elements.</p></li>
</ul>
</dd>
</dl>
<dl class="py property">
<dt class="sig sig-object py" id="amaranth.lib.data.ArrayLayout.size">
<em class="property"><span class="pre">property</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">size</span></span><a class="headerlink" href="#amaranth.lib.data.ArrayLayout.size" title="Permalink to this definition"></a></dt>
<dd><p>Size of the array layout.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>Size of an individual element multiplied by their amount.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="amaranth.lib.data.FlexibleLayout">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">amaranth.lib.data.</span></span><span class="sig-name descname"><span class="pre">FlexibleLayout</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fields</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.FlexibleLayout" title="Permalink to this definition"></a></dt>
<dd><p>Description of a flexible layout.</p>
<p>A flexible layout is similar to a structure layout; while fields in <a class="reference internal" href="#amaranth.lib.data.StructLayout" title="amaranth.lib.data.StructLayout"><code class="xref py py-class docutils literal notranslate"><span class="pre">StructLayout</span></code></a> are
defined contiguously, the fields in a flexible layout can overlap and have gaps between them.</p>
<p>Because the size and field boundaries in a flexible layout can be defined arbitrarily, it
may also be more convenient to use a flexible layout when the layout information is derived
from an external data file rather than defined in Python code.</p>
<p>For example, the following layout of a 16-bit value:</p>
<img alt="../_images/flexible_layout.svg" src="../_images/flexible_layout.svg" /><p>can be described with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">FlexibleLayout</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;first&quot;</span><span class="p">:</span>  <span class="n">data</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">unsigned</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s2">&quot;second&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">unsigned</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s2">&quot;third&quot;</span><span class="p">:</span>  <span class="n">data</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">unsigned</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span>
    <span class="mi">0</span><span class="p">:</span>        <span class="n">data</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">unsigned</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">14</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Both strings and integers can be used as names of flexible layout fields, so flexible layouts
can be used to describe structures with arbitrary padding and arrays with arbitrary stride.</p>
<p>If another data structure is used as the source of truth for creating flexible layouts,
consider instead inheriting from the base <a class="reference internal" href="#amaranth.lib.data.Layout" title="amaranth.lib.data.Layout"><code class="xref py py-class docutils literal notranslate"><span class="pre">Layout</span></code></a> class, which may be more convenient.</p>
<dl class="field-list simple">
<dt class="field-odd">Variables<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>size</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>) – Size of the layout.</p></li>
<li><p><strong>fields</strong> (mapping of <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code></a> or <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a> to <a class="reference internal" href="#amaranth.lib.data.Field" title="amaranth.lib.data.Field"><code class="xref py py-class docutils literal notranslate"><span class="pre">Field</span></code></a>) – Fields defined in the layout.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
<section id="data-views">
<h2>Data views<a class="headerlink" href="#data-views" title="Permalink to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="amaranth.lib.data.View">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">amaranth.lib.data.</span></span><span class="sig-name descname"><span class="pre">View</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">layout</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">target</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.View" title="Permalink to this definition"></a></dt>
<dd><p>A value viewed through the lens of a layout.</p>
<p>The <a class="reference internal" href="../lang.html#lang-valuelike"><span class="std std-ref">value-like</span></a> class <a class="reference internal" href="#amaranth.lib.data.View" title="amaranth.lib.data.View"><code class="xref py py-class docutils literal notranslate"><span class="pre">View</span></code></a> provides access to the fields
of an underlying Amaranth value via the names or indexes defined in the provided layout.</p>
<section id="creating-a-view">
<h3>Creating a view<a class="headerlink" href="#creating-a-view" title="Permalink to this heading"></a></h3>
<p>A view must be created using an explicitly provided layout and target. To create a new <code class="xref py py-class docutils literal notranslate"><span class="pre">Signal</span></code> that is wrapped in a <a class="reference internal" href="#amaranth.lib.data.View" title="amaranth.lib.data.View"><code class="xref py py-class docutils literal notranslate"><span class="pre">View</span></code></a> with a given <code class="docutils literal notranslate"><span class="pre">layout</span></code>, use <code class="docutils literal notranslate"><span class="pre">Signal(layout,</span> <span class="pre">...)</span></code>, which for a <a class="reference internal" href="#amaranth.lib.data.Layout" title="amaranth.lib.data.Layout"><code class="xref py py-class docutils literal notranslate"><span class="pre">Layout</span></code></a> is equivalent to <code class="docutils literal notranslate"><span class="pre">View(layout,</span> <span class="pre">Signal(...))</span></code>.</p>
</section>
<section id="accessing-a-view">
<h3>Accessing a view<a class="headerlink" href="#accessing-a-view" title="Permalink to this heading"></a></h3>
<p>Slicing a view or accessing its attributes returns a part of the underlying value
corresponding to the field with that index or name, which is itself either a value or
a value-castable object. If the shape of the field is a <a class="reference internal" href="#amaranth.lib.data.Layout" title="amaranth.lib.data.Layout"><code class="xref py py-class docutils literal notranslate"><span class="pre">Layout</span></code></a>, it will be
a <a class="reference internal" href="#amaranth.lib.data.View" title="amaranth.lib.data.View"><code class="xref py py-class docutils literal notranslate"><span class="pre">View</span></code></a>; if it is a class deriving from <a class="reference internal" href="#amaranth.lib.data.Struct" title="amaranth.lib.data.Struct"><code class="xref py py-class docutils literal notranslate"><span class="pre">Struct</span></code></a> or <a class="reference internal" href="#amaranth.lib.data.Union" title="amaranth.lib.data.Union"><code class="xref py py-class docutils literal notranslate"><span class="pre">Union</span></code></a>, it
will be an instance of that data class; if it is another
<a class="reference internal" href="../lang.html#lang-shapelike"><span class="std std-ref">shape-like</span></a> object implementing <code class="docutils literal notranslate"><span class="pre">__call__</span></code>, it will be
the result of calling that method.</p>
<p>Slicing a view whose layout is an <a class="reference internal" href="#amaranth.lib.data.ArrayLayout" title="amaranth.lib.data.ArrayLayout"><code class="xref py py-class docutils literal notranslate"><span class="pre">ArrayLayout</span></code></a> can be done with an index that is
an Amaranth value instead of a constant integer. The returned element is chosen dynamically
in that case.</p>
<p>A view can only be compared for equality with another view of the same layout,
returning a single-bit value. No other operators are supported on views. If required,
a view can be converted back to its underlying value via <a class="reference internal" href="#amaranth.lib.data.View.as_value" title="amaranth.lib.data.View.as_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">as_value()</span></code></a>.</p>
</section>
<section id="custom-view-classes">
<h3>Custom view classes<a class="headerlink" href="#custom-view-classes" title="Permalink to this heading"></a></h3>
<p>The <a class="reference internal" href="#amaranth.lib.data.View" title="amaranth.lib.data.View"><code class="xref py py-class docutils literal notranslate"><span class="pre">View</span></code></a> class can be inherited from to define additional properties or methods on
a view. The only two names that are reserved on instances of <a class="reference internal" href="#amaranth.lib.data.View" title="amaranth.lib.data.View"><code class="xref py py-class docutils literal notranslate"><span class="pre">View</span></code></a> are <a class="reference internal" href="#amaranth.lib.data.View.as_value" title="amaranth.lib.data.View.as_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">as_value()</span></code></a>
and <a class="reference internal" href="#amaranth.lib.data.View.eq" title="amaranth.lib.data.View.eq"><code class="xref py py-meth docutils literal notranslate"><span class="pre">eq()</span></code></a>, leaving the rest to the developer. The <a class="reference internal" href="#amaranth.lib.data.Struct" title="amaranth.lib.data.Struct"><code class="xref py py-class docutils literal notranslate"><span class="pre">Struct</span></code></a> and <a class="reference internal" href="#amaranth.lib.data.Union" title="amaranth.lib.data.Union"><code class="xref py py-class docutils literal notranslate"><span class="pre">Union</span></code></a>
classes provided in this module are subclasses of <a class="reference internal" href="#amaranth.lib.data.View" title="amaranth.lib.data.View"><code class="xref py py-class docutils literal notranslate"><span class="pre">View</span></code></a> that also provide a concise way
to define a layout.</p>
<dl class="py method">
<dt class="sig sig-object py" id="amaranth.lib.data.View.shape">
<span class="sig-name descname"><span class="pre">shape</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.View.shape" title="Permalink to this definition"></a></dt>
<dd><p>Get layout of this view.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>The <code class="docutils literal notranslate"><span class="pre">layout</span></code> provided when constructing the view.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><a class="reference internal" href="#amaranth.lib.data.Layout" title="amaranth.lib.data.Layout"><code class="xref py py-class docutils literal notranslate"><span class="pre">Layout</span></code></a></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth.lib.data.View.as_value">
<span class="sig-name descname"><span class="pre">as_value</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.View.as_value" title="Permalink to this definition"></a></dt>
<dd><p>Get underlying value.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>The <code class="docutils literal notranslate"><span class="pre">target</span></code> provided when constructing the view, or the <code class="xref py py-class docutils literal notranslate"><span class="pre">Signal</span></code> that
was created.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Value</span></code></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth.lib.data.View.eq">
<span class="sig-name descname"><span class="pre">eq</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">other</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.View.eq" title="Permalink to this definition"></a></dt>
<dd><p>Assign to the underlying value.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">self.as_value().eq(other)</span></code></p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Assign</span></code></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth.lib.data.View.__getitem__">
<span class="sig-name descname"><span class="pre">__getitem__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">key</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.View.__getitem__" title="Permalink to this definition"></a></dt>
<dd><p>Slice the underlying value.</p>
<p>A field corresponding to <code class="docutils literal notranslate"><span class="pre">key</span></code> is looked up in the layout. If the field’s shape is
a shape-castable object that has a <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method, it is called and the result is
returned. Otherwise, <code class="docutils literal notranslate"><span class="pre">as_shape</span></code> is called repeatedly on the shape until either an object
with a <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method is reached, or a <code class="docutils literal notranslate"><span class="pre">Shape</span></code> is returned. In the latter case,
returns an unspecified Amaranth expression with the right shape.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>key</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code></a> or <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a> or <code class="xref py py-class docutils literal notranslate"><span class="pre">ValueCastable</span></code>) – Name or index of a field.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>A slice of the underlying value defined by the field.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Value</span></code> or <code class="xref py py-class docutils literal notranslate"><span class="pre">ValueCastable</span></code>, inout</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#KeyError" title="(in Python v3.12)"><strong>KeyError</strong></a> – If the layout does not define a field corresponding to <code class="docutils literal notranslate"><span class="pre">key</span></code>.</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#TypeError" title="(in Python v3.12)"><strong>TypeError</strong></a> – If <code class="docutils literal notranslate"><span class="pre">key</span></code> is a value-castable object, but the layout of the view is not
    a <a class="reference internal" href="#amaranth.lib.data.ArrayLayout" title="amaranth.lib.data.ArrayLayout"><code class="xref py py-class docutils literal notranslate"><span class="pre">ArrayLayout</span></code></a>.</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#TypeError" title="(in Python v3.12)"><strong>TypeError</strong></a> – If <code class="docutils literal notranslate"><span class="pre">ShapeCastable.__call__</span></code> does not return a value or a value-castable object.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth.lib.data.View.__getattr__">
<span class="sig-name descname"><span class="pre">__getattr__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.View.__getattr__" title="Permalink to this definition"></a></dt>
<dd><p>Access a field of the underlying value.</p>
<p>Returns <code class="docutils literal notranslate"><span class="pre">self[name]</span></code>.</p>
<dl class="field-list simple">
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#AttributeError" title="(in Python v3.12)"><strong>AttributeError</strong></a> – If the layout does not define a field called <code class="docutils literal notranslate"><span class="pre">name</span></code>, or if <code class="docutils literal notranslate"><span class="pre">name</span></code> starts with
    an underscore.</p>
</dd>
</dl>
</dd></dl>

</section>
</dd></dl>

</section>
<section id="data-classes">
<h2>Data classes<a class="headerlink" href="#data-classes" title="Permalink to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="amaranth.lib.data.Struct">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">amaranth.lib.data.</span></span><span class="sig-name descname"><span class="pre">Struct</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">target</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.Struct" title="Permalink to this definition"></a></dt>
<dd><p>Structures defined with annotations.</p>
<p>The <a class="reference internal" href="#amaranth.lib.data.Struct" title="amaranth.lib.data.Struct"><code class="xref py py-class docutils literal notranslate"><span class="pre">Struct</span></code></a> base class is a subclass of <a class="reference internal" href="#amaranth.lib.data.View" title="amaranth.lib.data.View"><code class="xref py py-class docutils literal notranslate"><span class="pre">View</span></code></a> that provides a concise way
to describe the structure layout and reset values for the fields using Python
<a class="reference external" href="https://docs.python.org/3/glossary.html#term-variable-annotation" title="(in Python v3.12)"><span class="xref std std-term">variable annotations</span></a>.</p>
<p>Any annotations containing <a class="reference internal" href="../lang.html#lang-shapelike"><span class="std std-ref">shape-like</span></a> objects are used,
in the order in which they appear in the source code, to construct a <a class="reference internal" href="#amaranth.lib.data.StructLayout" title="amaranth.lib.data.StructLayout"><code class="xref py py-class docutils literal notranslate"><span class="pre">StructLayout</span></code></a>.
The values assigned to such annotations are used to populate the reset value of the signal
created by the view. Any other annotations are kept as-is.</p>
<p>As an example, a structure for <a class="reference external" href="https://en.wikipedia.org/wiki/Single-precision_floating-point_format">IEEE 754 single-precision floating-point format</a> can be defined as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">IEEE754Single</span><span class="p">(</span><span class="n">Struct</span><span class="p">):</span>
    <span class="n">fraction</span><span class="p">:</span> <span class="mi">23</span>
    <span class="n">exponent</span><span class="p">:</span>  <span class="mi">8</span> <span class="o">=</span> <span class="mh">0x7f</span>
    <span class="n">sign</span><span class="p">:</span>      <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">is_subnormal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exponent</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">IEEE754Single</span></code> class itself can be used where a <a class="reference internal" href="../lang.html#lang-shapes"><span class="std std-ref">shape</span></a> is expected:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">IEEE754Single</span><span class="o">.</span><span class="n">as_shape</span><span class="p">()</span>
<span class="go">StructLayout({&#39;fraction&#39;: 23, &#39;exponent&#39;: 8, &#39;sign&#39;: 1})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Signal</span><span class="p">(</span><span class="n">IEEE754Single</span><span class="p">)</span><span class="o">.</span><span class="n">as_value</span><span class="p">()</span><span class="o">.</span><span class="n">width</span>
<span class="go">32</span>
</pre></div>
</div>
<p>Instances of this class can be used where <a class="reference internal" href="../lang.html#lang-values"><span class="std std-ref">values</span></a> are expected:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">flt</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="n">IEEE754Single</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Signal</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">flt</span><span class="p">)</span>
<span class="go">(eq (sig $signal) (sig flt))</span>
</pre></div>
</div>
<p>Accessing shape-castable properties returns slices of the underlying value:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">flt</span><span class="o">.</span><span class="n">fraction</span>
<span class="go">(slice (sig flt) 0:23)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">flt</span><span class="o">.</span><span class="n">is_subnormal</span><span class="p">()</span>
<span class="go">(== (slice (sig flt) 23:31) (const 1&#39;d0))</span>
</pre></div>
</div>
<p>The reset values for individual fields can be overridden during instantiation:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">hex</span><span class="p">(</span><span class="n">Signal</span><span class="p">(</span><span class="n">IEEE754Single</span><span class="p">)</span><span class="o">.</span><span class="n">as_value</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">)</span>
<span class="go">&#39;0x3f800000&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">hex</span><span class="p">(</span><span class="n">Signal</span><span class="p">(</span><span class="n">IEEE754Single</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sign&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span><span class="o">.</span><span class="n">as_value</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">)</span>
<span class="go">&#39;0xbf800000&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">hex</span><span class="p">(</span><span class="n">Signal</span><span class="p">(</span><span class="n">IEEE754Single</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;exponent&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span><span class="o">.</span><span class="n">as_value</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">)</span>
<span class="go">&#39;0x0&#39;</span>
</pre></div>
</div>
<p>Classes inheriting from <a class="reference internal" href="#amaranth.lib.data.Struct" title="amaranth.lib.data.Struct"><code class="xref py py-class docutils literal notranslate"><span class="pre">Struct</span></code></a> can be used as base classes. The only restrictions
are that:</p>
<ul class="simple">
<li><p>Classes that do not define a layout cannot be instantiated or converted to a shape;</p></li>
<li><p>A layout can be defined exactly once in the inheritance hierarchy.</p></li>
</ul>
<p>Behavior can be shared through inheritance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HasChecksum</span><span class="p">(</span><span class="n">Struct</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">checksum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="n">Value</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits</span><span class="p">),</span> <span class="mi">8</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">BareHeader</span><span class="p">(</span><span class="n">HasChecksum</span><span class="p">):</span>
    <span class="n">address</span><span class="p">:</span> <span class="mi">16</span>
    <span class="n">length</span><span class="p">:</span>   <span class="mi">8</span>

<span class="k">class</span> <span class="nc">HeaderWithParam</span><span class="p">(</span><span class="n">HasChecksum</span><span class="p">):</span>
    <span class="n">address</span><span class="p">:</span> <span class="mi">16</span>
    <span class="n">length</span><span class="p">:</span>   <span class="mi">8</span>
    <span class="n">param</span><span class="p">:</span>    <span class="mi">8</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">HasChecksum</span><span class="o">.</span><span class="n">as_shape</span><span class="p">()</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="w">  </span><span class="c">...</span>
<span class="gr">TypeError</span>: <span class="n">Aggregate class &#39;HasChecksum&#39; does not have a defined shape</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bare</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="n">BareHeader</span><span class="p">);</span> <span class="n">bare</span><span class="o">.</span><span class="n">checksum</span><span class="p">()</span>
<span class="go">(+ (+ (+ (const 1&#39;d0) (slice (sig bare) 0:8)) (slice (sig bare) 8:16)) (slice (sig bare) 16:24))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">param</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="n">HeaderWithParam</span><span class="p">);</span> <span class="n">param</span><span class="o">.</span><span class="n">checksum</span><span class="p">()</span>
<span class="go">(+ (+ (+ (+ (const 1&#39;d0) (slice (sig param) 0:8)) (slice (sig param) 8:16)) (slice (sig param) 16:24)) (slice (sig param) 24:32))</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="amaranth.lib.data.Union">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">amaranth.lib.data.</span></span><span class="sig-name descname"><span class="pre">Union</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">target</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth.lib.data.Union" title="Permalink to this definition"></a></dt>
<dd><p>Unions defined with annotations.</p>
<p>The <a class="reference internal" href="#amaranth.lib.data.Union" title="amaranth.lib.data.Union"><code class="xref py py-class docutils literal notranslate"><span class="pre">Union</span></code></a> base class is a subclass of <a class="reference internal" href="#amaranth.lib.data.View" title="amaranth.lib.data.View"><code class="xref py py-class docutils literal notranslate"><span class="pre">View</span></code></a> that provides a concise way
to describe the union layout using Python <a class="reference external" href="https://docs.python.org/3/glossary.html#term-variable-annotation" title="(in Python v3.12)"><span class="xref std std-term">variable annotations</span></a>. It is very similar to the <a class="reference internal" href="#amaranth.lib.data.Struct" title="amaranth.lib.data.Struct"><code class="xref py py-class docutils literal notranslate"><span class="pre">Struct</span></code></a> class, except that its layout
is a <a class="reference internal" href="#amaranth.lib.data.UnionLayout" title="amaranth.lib.data.UnionLayout"><code class="xref py py-class docutils literal notranslate"><span class="pre">UnionLayout</span></code></a>.</p>
<p>A <a class="reference internal" href="#amaranth.lib.data.Union" title="amaranth.lib.data.Union"><code class="xref py py-class docutils literal notranslate"><span class="pre">Union</span></code></a> can have only one field with a specified reset value. If a reset value is
explicitly provided during instantiation, it overrides the reset value specified with
an annotation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">VarInt</span><span class="p">(</span><span class="n">Union</span><span class="p">):</span>
    <span class="n">int8</span><span class="p">:</span>  <span class="mi">8</span>
    <span class="n">int16</span><span class="p">:</span> <span class="mi">16</span> <span class="o">=</span> <span class="mh">0x100</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Signal</span><span class="p">(</span><span class="n">VarInt</span><span class="p">)</span><span class="o">.</span><span class="n">as_value</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span>
<span class="go">256</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Signal</span><span class="p">(</span><span class="n">VarInt</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;int8&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">})</span><span class="o">.</span><span class="n">as_value</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span>
<span class="go">10</span>
</pre></div>
</div>
</dd></dl>

</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="enum.html" class="btn btn-neutral float-left" title="Enumerations" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="coding.html" class="btn btn-neutral float-right" title="Code conversion" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020—2023, Amaranth HDL developers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>